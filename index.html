<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Universitário do Ceará | Indicadores Gerenciados</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* ===== VARIÁVEIS CSS MODERNAS ===== */
        :root {
            --primary: #2563EB;
            --primary-dark: #1E40AF;
            --primary-light: rgba(37, 99, 235, 0.14);
            --accent: #0F766E;
            --accent-dark: #0B5256;
            --accent-light: rgba(15, 118, 110, 0.18);
            --accent-soft: rgba(15, 118, 110, 0.24);

            --background: #E7EDF2;
            --surface: #FFFFFF;
            --surface-border: #CDD6E1;
            --surface-subtle: #F3F6F9;
            --surface-muted: rgba(243, 246, 249, 0.9);
            --overlay-scrim: rgba(231, 237, 242, 0.82);

            --text-title: #1F2933;
            --text-body: #384452;
            --text-muted: #6C7785;

            --shadow-sm: 0 4px 8px rgba(15, 23, 42, 0.06);
            --shadow-md: 0 12px 24px rgba(15, 23, 42, 0.09);
            --shadow-lg: 0 18px 34px rgba(15, 23, 42, 0.12);

            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --border-radius-xl: 20px;

            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 24px;

            --primary-soft: rgba(37, 99, 235, 0.14);
            --primary-soft-muted: rgba(37, 99, 235, 0.08);
            --primary-border-soft: rgba(37, 99, 235, 0.22);
            --primary-border-strong: rgba(37, 99, 235, 0.3);

            --table-header-bg: rgba(37, 99, 235, 0.08);
            --table-hover-bg: rgba(37, 99, 235, 0.12);
            --table-divider: rgba(148, 163, 184, 0.35);

            --chart-axis-color: #3F4C5B;
            --chart-grid-color: rgba(99, 112, 126, 0.18);
            --chart-legend-color: #384452;
            --chart-label-color: #1F2933;
            --chart-tooltip-bg: #FFFFFF;
            --chart-tooltip-color: #1F2933;
            --chart-tooltip-border: rgba(148, 163, 184, 0.35);

            --scroll-thumb: rgba(148, 163, 184, 0.6);
            --scroll-thumb-hover: rgba(148, 163, 184, 0.78);

            --transition-fast: 0.18s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 0.28s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.45s cubic-bezier(0.4, 0, 0.2, 1);

            --focus-ring: 0 0 0 3px rgba(37, 99, 235, 0.35);
            --backdrop-blur: blur(12px);
        }

        body[data-theme="ambulatorial"] {
            color-scheme: light;
        }

        body[data-theme="plantao"] {
            --background: #0B1423;
            --surface: #131F30;
            --surface-border: rgba(64, 83, 110, 0.52);
            --surface-subtle: rgba(19, 31, 48, 0.86);
            --surface-muted: rgba(19, 31, 48, 0.92);
            --overlay-scrim: rgba(7, 12, 22, 0.72);

            --text-title: #E2E8F0;
            --text-body: #CBD5E1;
            --text-muted: #94A3B8;

            --primary: #60A5FA;
            --primary-dark: #3B82F6;
            --primary-light: rgba(96, 165, 250, 0.2);

            --accent: #14B8A6;
            --accent-dark: #0D9488;
            --accent-light: rgba(20, 184, 166, 0.22);
            --accent-soft: rgba(20, 184, 166, 0.26);

            --primary-soft: rgba(96, 165, 250, 0.24);
            --primary-soft-muted: rgba(96, 165, 250, 0.12);
            --primary-border-soft: rgba(96, 165, 250, 0.28);
            --primary-border-strong: rgba(96, 165, 250, 0.4);

            --table-header-bg: rgba(20, 184, 166, 0.2);
            --table-hover-bg: rgba(96, 165, 250, 0.18);
            --table-divider: rgba(96, 165, 250, 0.28);

            --chart-axis-color: #E2E8F0;
            --chart-grid-color: rgba(96, 165, 250, 0.22);
            --chart-legend-color: #E2E8F0;
            --chart-label-color: #F8FAFC;
            --chart-tooltip-bg: #0F1A2B;
            --chart-tooltip-color: #F8FAFC;
            --chart-tooltip-border: rgba(96, 165, 250, 0.35);

            --scroll-thumb: rgba(96, 165, 250, 0.45);
            --scroll-thumb-hover: rgba(96, 165, 250, 0.65);

            --shadow-sm: 0 4px 12px rgba(2, 6, 23, 0.4);
            --shadow-md: 0 16px 32px rgba(2, 6, 23, 0.55);
            --shadow-lg: 0 24px 46px rgba(2, 6, 23, 0.65);

            color-scheme: dark;
        }

        body[data-dataset="cirurgico"][data-theme="ambulatorial"] {
            --primary: #4FD69B;
            --primary-dark: #2EA87B;
            --primary-light: rgba(111, 232, 181, 0.18);
            --accent: #FF7A4A;
            --accent-dark: #E95E2A;
            --accent-light: rgba(255, 122, 74, 0.16);
            --accent-soft: rgba(255, 214, 191, 0.32);

            --surface-border: rgba(111, 232, 181, 0.32);
            --surface-subtle: rgba(225, 247, 238, 0.9);
            --surface-muted: rgba(245, 252, 248, 0.92);
            --overlay-scrim: rgba(209, 245, 231, 0.82);

            --text-title: #334155;
            --text-body: #475569;
            --text-muted: #6B7280;

            --chart-axis-color: #41535F;
            --chart-grid-color: rgba(99, 112, 126, 0.14);
            --chart-legend-color: #334155;
            --chart-label-color: #1E293B;

            --scroll-thumb: rgba(79, 214, 155, 0.4);
            --scroll-thumb-hover: rgba(79, 214, 155, 0.7);
        }

        /* ===== RESET E BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--background);
            color: var(--text-body);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
        }

        /* ===== LAYOUT PRINCIPAL ===== */
        .app-shell {
            min-height: 100vh;
            display: flex;
            background: var(--background);
        }

        .app-sidebar {
            width: 260px;
            padding: 28px 22px;
            background: var(--surface);
            border-right: 1px solid var(--surface-border);
            display: flex;
            flex-direction: column;
            gap: 24px;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .sidebar-title {
            font-size: 0.95rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
        }

        .sidebar-header i {
            color: var(--primary);
            font-size: 1.1rem;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .sidebar-link {
            border: 1px solid transparent;
            background: transparent;
            border-radius: var(--border-radius-lg);
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: var(--transition-normal);
            text-align: left;
            color: var(--text-body);
        }

        .sidebar-link-icon {
            width: 42px;
            height: 42px;
            border-radius: 14px;
            display: grid;
            place-items: center;
            background: var(--primary-light);
            color: var(--primary);
            box-shadow: var(--shadow-sm);
            flex-shrink: 0;
        }

        .sidebar-link-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .sidebar-link-label {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-title);
        }

        .sidebar-link-description {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .sidebar-link.is-active,
        .sidebar-link:hover {
            border-color: var(--primary-border-soft);
            background: var(--primary-soft-muted);
            box-shadow: var(--shadow-sm);
        }

        .sidebar-footer {
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px dashed var(--surface-border);
            font-size: 0.78rem;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .sidebar-footer strong {
            color: var(--primary);
        }

        .app-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .dashboard-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            max-width: 1800px;
            width: 100%;
            margin: 0 auto;
            position: relative;
        }

        .dashboard-view {
            display: none;
            width: 100%;
        }

        body[data-dataset="ambulatorial"] .dashboard-view--ambulatorial {
            display: block;
        }

        body[data-dataset="cirurgico"] .dashboard-view--cirurgico {
            display: flex;
            flex-direction: column;
        }

        /* ===== HEADER COM DESIGN FUTURISTA ===== */
        .dashboard-header {
            background: var(--surface);
            border: 1px solid var(--surface-border);
            border-radius: var(--border-radius-xl);
            padding: 24px 32px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            position: relative;
            transition: var(--transition-normal);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface);
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .title-text {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .title-text h1 {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-title);
            margin-bottom: 4px;
        }

        .title-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .dataset-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--primary-soft);
            color: var(--primary-dark);
            padding: 6px 12px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.85rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--primary-border-soft);
            transition: var(--transition-fast);
        }

        .dataset-badge i {
            color: var(--primary);
        }

        .title-meta p {
            font-size: 0.95rem;
            color: var(--text-body);
            font-weight: 500;
            margin: 0;
        }

        .header-controls {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            align-items: center;
            justify-content: flex-end;
        }

        /* ===== BOTÕES COM DESIGN 3D ===== */
        .btn {
            padding: 12px 22px;
            border-radius: var(--border-radius-md);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            border: none;
            min-height: 44px;
            letter-spacing: 0.3px;
        }

        .btn:focus-visible {
            outline: none;
            box-shadow: var(--focus-ring);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        .btn-primary {
            background: var(--primary);
            color: #ffffff;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: var(--accent);
            color: #ffffff;
            box-shadow: var(--shadow-sm);
        }

        .btn-success:hover {
            background: var(--accent-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-accent {
            background: var(--accent-light);
            color: var(--text-title);
            box-shadow: var(--shadow-sm);
        }

        .btn-accent:hover {
            background: var(--accent);
            color: #ffffff;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-outline {
            background: transparent;
            color: var(--text-title);
            border: 1px solid var(--surface-border);
            box-shadow: none;
        }

        .btn-outline:hover,
        .btn-outline[aria-pressed="true"] {
            color: var(--primary-dark);
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-border-soft);
        }

        .btn--critico {
            background: var(--accent);
            color: #ffffff;
            box-shadow: 0 8px 18px rgba(13, 148, 136, 0.28);
        }

        .btn--critico:hover {
            background: var(--accent-dark);
            box-shadow: 0 10px 24px rgba(13, 148, 136, 0.34);
        }

        .btn:disabled,
        .btn[disabled] {
            opacity: 0.55;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn .btn-label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        /* ===== SEÇÃO DE BUSCA ===== */
        .search-section {
            background: var(--surface);
            border: 1px solid var(--surface-border);
            border-radius: var(--border-radius-xl);
            padding: 22px 30px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-md);
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .search-container {
            flex: 1;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 16px 50px 16px 20px;
            background: var(--background);
            border: 1px solid var(--surface-border);
            border-radius: var(--border-radius-md);
            color: var(--text-body);
            font-size: 0.95rem;
            transition: all var(--transition-fast);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-border-soft);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .performance-info {
            padding: 12px 20px;
            background: var(--primary-light);
            border: 1px solid var(--primary);
            border-radius: var(--border-radius-md);
            font-size: 0.85rem;
            color: var(--text-title);
            font-weight: 600;
        }

        /* ===== FILTROS COM DESIGN MODERNO ===== */
        .filters-section {
            background: var(--surface);
            border: 1px solid var(--surface-border);
            border-radius: var(--border-radius-xl);
            padding: 26px 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-md);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
        }

        .filter-group.is-hidden {
            display: none;
        }

        .filter-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-title);
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .filter-select {
            appearance: none;
            padding: 14px 16px;
            background: var(--surface);
            border: 1px solid var(--primary-border-soft);
            border-radius: var(--border-radius-lg);
            color: var(--text-body);
            font-size: 0.95rem;
            font-weight: 500;
            transition: all var(--transition-fast);
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2' stroke='%235E6B73'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 18px center;
            background-size: 14px;
            padding-right: 46px;
        }

        .filter-select:hover {
            border-color: var(--primary);
            box-shadow: 0 12px 24px var(--primary-soft);
            transform: translateY(-1px);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-border-strong);
        }

        .filter-select option {
            background: var(--surface);
            color: var(--text-body);
        }

        .filter-select::-ms-expand {
            display: none;
        }

        .filter-helper {
            font-size: 0.75rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .filter-select-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0 0 0 0);
            border: 0;
        }

        .multi-select {
            position: relative;
        }

        .multi-select-trigger {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 14px 16px;
            background: var(--surface);
            border: 1px solid var(--primary-border-soft);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
            color: var(--text-body);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .multi-select-trigger:hover {
            border-color: var(--primary);
            box-shadow: 0 12px 24px var(--primary-soft);
            transform: translateY(-1px);
        }

        .multi-select-trigger:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-border-strong);
        }

        .multi-select-trigger i {
            color: var(--text-muted);
            transition: transform var(--transition-fast);
        }

        .multi-select.open .multi-select-trigger i {
            transform: rotate(180deg);
        }

        .multi-select-dropdown {
            position: absolute;
            top: calc(100% + 10px);
            left: 0;
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--primary-border-soft);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-lg);
            padding: 16px;
            z-index: 50;
            opacity: 0;
            transform: translateY(-6px);
            pointer-events: none;
            transition: all var(--transition-normal);
        }

        .multi-select.open .multi-select-dropdown {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .multi-select.is-disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        .multi-select-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .multi-select-actions button {
            background: transparent;
            border: none;
            color: var(--primary-dark);
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: color var(--transition-fast);
        }

        .multi-select-actions button:hover {
            color: var(--accent);
        }

        .multi-select-actions button:disabled {
            opacity: 0.45;
            cursor: not-allowed;
        }

        .multi-select-options {
            display: grid;
            gap: 10px;
            max-height: 220px;
            overflow-y: auto;
            padding-right: 6px;
        }

        .multi-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: var(--border-radius-md);
            background: var(--primary-light);
            border: 1px solid var(--primary-border-soft);
            transition: background var(--transition-fast), transform var(--transition-fast), border-color var(--transition-fast);
            cursor: pointer;
        }

        .multi-option.multi-option--empty {
            justify-content: center;
            padding: 14px 12px;
            background: var(--primary-soft-muted);
            color: var(--text-muted);
            cursor: default;
        }

        .multi-option:hover {
            background: var(--primary-soft);
            border-color: var(--primary-border-strong);
            transform: translateX(4px);
        }

        .multi-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-dark);
            cursor: pointer;
        }

        .multi-option span {
            flex: 1;
            font-weight: 600;
            color: var(--text-title);
        }

        .multi-select-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
        }

        .multi-select-badge {
            padding: 4px 10px;
            background: var(--primary-soft);
            color: var(--text-title);
            border-radius: 999px;
            font-size: 0.72rem;
            font-weight: 600;
        }

        /* ===== SEÇÃO DE KPIs COM CARDS ANIMADOS ===== */
        .kpi-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: var(--surface);
            border: 1px solid var(--surface-border);
            border-radius: var(--border-radius-lg);
            padding: 28px;
            box-shadow: var(--shadow-md);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary);
        }

        .kpi-card[data-variant="agendamentos"]::before {
            background: var(--accent);
        }

        .kpi-card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-border-strong);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .kpi-icon {
            width: 54px;
            height: 54px;
            border-radius: var(--border-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            background: var(--primary-soft);
            color: var(--primary-dark);
        }

        .kpi-card[data-variant="agendamentos"] .kpi-icon {
            background: var(--accent-soft);
            color: var(--accent);
        }

        .kpi-title {
            font-size: 0.9rem;
            color: var(--text-body);
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-title);
            margin-bottom: 5px;
            line-height: 1;
        }

        .kpi-trend {
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }

        .trend-up {
            color: var(--primary-dark);
        }

        .trend-down {
            color: var(--accent);
        }

        .card--alerta {
            border-color: var(--accent-soft);
            box-shadow: 0 10px 28px rgba(13, 148, 136, 0.24);
        }

        .card--alerta::before {
            background: var(--accent);
        }

        .card--alerta .kpi-icon {
            background: var(--accent-soft);
            color: var(--accent);
        }

        .card--alerta .kpi-value {
            color: var(--accent);
        }

        /* ===== SEÇÃO DE GRÁFICOS ===== */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
            align-items: stretch;
        }

        @media (min-width: 1200px) {
            .charts-section {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }

        .chart-container {
            background: var(--surface);
            border: 1px solid var(--surface-border);
            border-radius: var(--border-radius-xl);
            padding: 24px;
            box-shadow: var(--shadow-md);
            transition: var(--transition-normal);
            display: flex;
            flex-direction: column;
        }

        .chart-container:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .chart-container.animate-fade-in-up {
            animation: fadeInUp 0.6s ease forwards;
            opacity: 0;
        }

        .demographic-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
            align-items: stretch;
        }

        .chart-legend {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        .chart-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .chart-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 6px;
            border: 1px solid var(--surface-border);
        }

        .chart-legend--highlight {
            color: var(--text-title);
            font-weight: 600;
            letter-spacing: 0.4px;
            text-shadow: none;
        }

        .chart-legend--highlight.is-hidden {
            display: none;
        }

        .chart-legend--highlight .chart-legend-item {
            color: inherit;
            letter-spacing: inherit;
            text-shadow: inherit;
        }

        .chart-legend--highlight .chart-legend-color {
            box-shadow: none;
            border: 1px solid var(--surface-border);
        }

        .chart-legend--highlight .chart-legend-label {
            color: inherit;
        }

        .insights-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
            align-items: flex-start;
        }

        .table-card,
        .insight-card {
            background: var(--surface);
            border: 1px solid var(--surface-border);
            border-radius: var(--border-radius-xl);
            padding: 24px 30px;
            box-shadow: var(--shadow-md);
            transition: var(--transition-normal);
        }

        .table-card:hover,
        .insight-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .insight-card {
            align-self: flex-start;
        }

        .table-header,
        .insight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-title,
        .insight-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-title);
        }

        .table-scroll {
            max-height: 420px;
            overflow-y: auto;
            margin-right: -12px;
            padding-right: 12px;
            border-radius: var(--border-radius-md);
            border: 1px solid var(--surface-border);
            background: var(--surface-muted);
            box-shadow: inset 0 1px 0 var(--surface-border);
        }

        .table-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .table-scroll::-webkit-scrollbar-thumb {
            background: var(--scroll-thumb);
            border-radius: 999px;
        }

        .table-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .data-table colgroup col:first-child {
            width: 48%;
        }

        .data-table colgroup col:nth-child(2),
        .data-table colgroup col:nth-child(3) {
            width: 26%;
        }

        .data-table thead {
            background: var(--table-header-bg);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .data-table th,
        .data-table td {
            padding: 14px 16px;
            font-size: 0.95rem;
            border-bottom: 1px solid var(--table-divider);
        }

        .data-table th:first-child,
        .data-table td:first-child {
            text-align: left;
            padding-right: 28px;
            white-space: normal;
            overflow-wrap: anywhere;
        }

        .data-table td:nth-child(2),
        .data-table td:nth-child(3),
        .data-table th:nth-child(2),
        .data-table th:nth-child(3) {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .data-table th {
            color: var(--text-title);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table tbody tr:hover {
            background: var(--table-hover-bg);
        }

        .empty-row td {
            text-align: center;
            color: var(--text-muted);
            font-style: italic;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
            background: var(--primary-soft);
            color: var(--primary-dark);
        }

        .badge i {
            font-size: 0.8rem;
        }

        .insight-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .insight-item {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-body);
        }

        .insight-item strong {
            color: var(--text-title);
            font-size: 1.05rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-title);
        }

        .chart-actions {
            display: flex;
            gap: 10px;
        }

        .chart-btn {
            padding: 8px 12px;
            background: var(--surface-subtle);
            border: 1px solid var(--surface-border);
            border-radius: var(--border-radius-sm);
            color: var(--text-title);
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .chart-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: #ffffff;
        }

        .chart-wrapper {
            position: relative;
            min-height: 220px;
            height: auto;
            max-height: none;
            flex: 1 1 auto;
        }

        .demographic-section .chart-container {
            padding: 24px;
        }

        .demographic-section .chart-wrapper {
            min-height: 220px;
            max-height: 340px;
        }

        .chart-wrapper canvas {
            width: 100% !important;
            height: auto !important;
        }

        .chart-expand-btn[aria-expanded="true"] {
            background: var(--primary);
            color: #ffffff;
            border-color: var(--primary);
        }

        .chart-expand-btn[aria-expanded="true"]:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .chart-overlay {
            position: fixed;
            inset: 0;
            background: rgba(25, 39, 48, 0.58);
            backdrop-filter: blur(4px);
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-normal);
            z-index: 2000;
        }

        .chart-overlay.is-active {
            opacity: 1;
            pointer-events: all;
        }

        body.chart-expanded {
            overflow: hidden;
        }

        .chart-container.is-expanded {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(1100px, 92vw);
            max-height: 92vh;
            height: auto;
            z-index: 2010;
            padding: 32px;
            box-shadow: var(--shadow-lg);
        }

        .chart-container.is-expanded .chart-wrapper {
            flex: 1 1 auto;
            min-height: clamp(360px, 70vh, 820px);
            height: auto;
            max-height: none;
        }

        .chart-container.is-expanded .chart-wrapper canvas {
            height: 100% !important;
        }

        .chart-container.is-expanded .chart-header {
            margin-bottom: 24px;
        }

        .chart-container.is-expanded.animate-fade-in-up {
            animation: none;
            opacity: 1;
        }

        .demographic-section .chart-wrapper canvas {
            height: 100% !important;
        }

        /* ===== LOADING ===== */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px 20px;
            color: var(--text-body);
            flex-direction: column;
            gap: 20px;
        }

        .global-loading {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--overlay-scrim);
            backdrop-filter: blur(4px);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease;
        }

        .global-loading.visible {
            opacity: 1;
            pointer-events: all;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--surface-border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            font-size: 0.9rem;
            color: var(--text-title);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== ANIMAÇÕES PERSONALIZADAS ===== */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }

        /* ===== RESPONSIVIDADE ===== */
        @media (max-width: 1200px) {
            .app-sidebar {
                width: 220px;
            }

            .charts-section {
                grid-template-columns: 1fr;
            }

            .insights-section {
                grid-template-columns: 1fr;
            }

            .kpi-section {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .app-shell {
                flex-direction: column;
            }

            .app-sidebar {
                width: 100%;
                height: auto;
                position: static;
                flex-direction: column;
                padding: 16px;
                box-shadow: none;
                border-right: none;
                border-bottom: 1px solid var(--surface-border);
                gap: 16px;
            }

            .sidebar-nav {
                flex-direction: row;
                overflow-x: auto;
                padding-bottom: 4px;
            }

            .sidebar-link {
                flex: 1;
                min-width: 220px;
            }

            .sidebar-footer {
                display: none;
            }

            .dashboard-container {
                padding: 15px;
            }

            .header-content {
                flex-direction: column;
                gap: 20px;
                align-items: flex-start;
            }
            
            .header-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .filters-section {
                grid-template-columns: 1fr;
            }
            
            .kpi-section {
                grid-template-columns: 1fr;
            }
            
            .search-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .data-table {
                display: block;
                overflow-x: auto;
            }

            .table-scroll {
                max-height: 280px;
                margin-right: 0;
                padding-right: 0;
            }
        }

        /* ===== SCROLLBAR PERSONALIZADA ===== */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--surface-subtle);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--scroll-thumb);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--scroll-thumb-hover);
        }


/* ===== ESTILOS ESPECÍFICOS DO BI CIRÚRGICO ===== */
#cirurgicoDashboard {
    background: var(--background);
    min-height: 100%;
    padding: 20px;
    gap: 24px;
    position: relative;
}

#cirurgicoDashboard::before {
    content: '';
    position: absolute;
    inset: 0;
    background:
        radial-gradient(circle at 20% 80%, rgba(111, 232, 181, 0.18) 0%, transparent 55%),
        radial-gradient(circle at 80% 20%, rgba(255, 122, 74, 0.12) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(201, 243, 224, 0.4) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
}

#cirurgicoDashboard > * {
    position: relative;
    z-index: 1;
}

#cirurgicoDashboard .dashboard-header {
    background: var(--surface);
    border: 1px solid var(--surface-border);
    border-radius: var(--border-radius-xl);
    padding: 28px 36px;
    box-shadow: var(--shadow-lg);
    position: relative;
    overflow: hidden;
    transition: var(--transition-normal);
}

#cirurgicoDashboard .dashboard-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(79, 214, 155, 0.18), transparent);
    transition: var(--transition-slow);
}

#cirurgicoDashboard .dashboard-header:hover::before {
    left: 100%;
}

#cirurgicoDashboard .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#cirurgicoDashboard .header-title {
    display: flex;
    align-items: center;
    gap: 15px;
}

#cirurgicoDashboard .header-title .logo {
    width: 52px;
    height: 52px;
    border-radius: 14px;
    background: var(--surface);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow-glow);
    color: var(--primary-dark);
    font-size: 1.6rem;
}

#cirurgicoDashboard .title-text h1 {
    font-size: 2rem;
    font-weight: 800;
    color: var(--text-title);
    margin-bottom: 4px;
}

#cirurgicoDashboard .title-text p {
    font-size: 0.95rem;
    color: var(--text-body);
    font-weight: 400;
}

#cirurgicoDashboard .header-controls {
    display: flex;
    gap: 15px;
    align-items: center;
}

#cirurgicoDashboard .btn {
    padding: 12px 24px;
    border-radius: var(--border-radius-md);
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    gap: 8px;
    position: relative;
    overflow: hidden;
    border: none;
}

#cirurgicoDashboard .btn:focus-visible {
    outline: 3px solid rgba(111, 232, 181, 0.35);
    outline-offset: 2px;
}

#cirurgicoDashboard .btn:active {
    transform: translateY(0);
    box-shadow: var(--shadow-sm);
}

#cirurgicoDashboard .btn-primary {
    background: var(--primary);
    color: #ffffff;
    box-shadow: var(--shadow-sm);
}

#cirurgicoDashboard .btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

#cirurgicoDashboard .btn-success {
    background: var(--accent);
    color: #ffffff;
    box-shadow: var(--shadow-sm);
}

#cirurgicoDashboard .btn-success:hover {
    background: #ff6a33;
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

#cirurgicoDashboard .btn-accent {
    background: var(--accent-light);
    color: var(--text-title);
    box-shadow: var(--shadow-sm);
}

#cirurgicoDashboard .btn-accent:hover {
    background: var(--accent);
    color: #ffffff;
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

#cirurgicoDashboard .search-section {
    background: var(--surface);
    border: 1px solid var(--surface-border);
    border-radius: var(--border-radius-xl);
    padding: 22px 30px;
    margin-bottom: 25px;
    box-shadow: var(--shadow-md);
    display: flex;
    gap: 20px;
    align-items: center;
}

#cirurgicoDashboard .search-container {
    flex: 1;
    position: relative;
}

#cirurgicoDashboard .search-input {
    width: 100%;
    padding: 16px 50px 16px 20px;
    background: var(--background);
    border: 1px solid var(--surface-border);
    border-radius: var(--border-radius-md);
    color: var(--text-body);
    font-size: 0.95rem;
    transition: all var(--transition-fast);
}

#cirurgicoDashboard .search-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(111, 232, 181, 0.3);
}

#cirurgicoDashboard .search-input::placeholder {
    color: var(--text-muted);
}

#cirurgicoDashboard .search-icon {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
}

#cirurgicoDashboard .performance-info {
    padding: 12px 20px;
    background: var(--primary-light);
    border: 1px solid var(--primary);
    border-radius: var(--border-radius-md);
    font-size: 0.85rem;
    color: var(--text-title);
    font-weight: 600;
}

#cirurgicoDashboard .filters-section {
    background: var(--surface);
    border: 1px solid var(--surface-border);
    border-radius: var(--border-radius-xl);
    padding: 26px 30px;
    margin-bottom: 30px;
    box-shadow: var(--shadow-md);
    display: flex;
    flex-direction: column;
    gap: 18px;
}

#cirurgicoDashboard .filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
}

#cirurgicoDashboard .filter-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    position: relative;
}

#cirurgicoDashboard .filter-group.is-hidden {
    display: none;
}

#cirurgicoDashboard .filter-label {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-title);
    text-transform: uppercase;
    letter-spacing: 0.4px;
}

#cirurgicoDashboard .filter-select {
    appearance: none;
    padding: 14px 16px;
    background: var(--surface);
    border: 1px solid rgba(111, 232, 181, 0.25);
    border-radius: var(--border-radius-lg);
    color: var(--text-body);
    font-size: 0.95rem;
    font-weight: 500;
    transition: all var(--transition-fast);
    cursor: pointer;
    box-shadow: var(--shadow-sm);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2' stroke='%235E6B73'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 18px center;
    background-size: 14px;
    padding-right: 46px;
}

#cirurgicoDashboard .filter-select:hover {
    border-color: var(--primary);
    box-shadow: 0 12px 24px rgba(111, 232, 181, 0.15);
    transform: translateY(-1px);
}

#cirurgicoDashboard .filter-select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(111, 232, 181, 0.25);
}

#cirurgicoDashboard .filter-helper {
    font-size: 0.75rem;
    color: var(--text-muted);
    line-height: 1.4;
}

#cirurgicoDashboard .quick-nav {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 24px;
}

#cirurgicoDashboard .quick-nav-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    border-radius: var(--border-radius-lg);
    border: 1px solid rgba(79, 214, 155, 0.35);
    background: rgba(79, 214, 155, 0.12);
    color: var(--text-body);
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all var(--transition-fast);
    box-shadow: var(--shadow-sm);
}

#cirurgicoDashboard .quick-nav-btn i {
    color: var(--primary);
}

#cirurgicoDashboard .quick-nav-btn:hover,
#cirurgicoDashboard .quick-nav-btn:focus {
    outline: none;
    border-color: var(--primary);
    background: rgba(79, 214, 155, 0.22);
    box-shadow: 0 10px 20px rgba(79, 214, 155, 0.18);
}

#cirurgicoDashboard .quick-nav-btn:focus-visible {
    box-shadow: var(--focus-ring);
}

#cirurgicoDashboard .quick-nav-btn.is-active {
    background: var(--primary);
    color: #fff;
    border-color: var(--primary-dark);
}

#cirurgicoDashboard .active-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
}

#cirurgicoDashboard .filter-chip {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 14px;
    border-radius: 999px;
    border: 1px solid rgba(79, 214, 155, 0.45);
    background: rgba(79, 214, 155, 0.14);
    color: var(--text-body);
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
    box-shadow: var(--shadow-sm);
}

#cirurgicoDashboard .filter-chip i {
    font-size: 0.8rem;
    color: var(--primary);
}

#cirurgicoDashboard .filter-chip:hover,
#cirurgicoDashboard .filter-chip:focus {
    background: rgba(79, 214, 155, 0.28);
    border-color: var(--primary);
}

#cirurgicoDashboard .filter-chip:focus-visible {
    outline: none;
    box-shadow: var(--focus-ring);
}

#cirurgicoDashboard .filter-chip.is-empty {
    background: rgba(148, 163, 184, 0.18);
    border-color: rgba(148, 163, 184, 0.35);
    color: var(--text-muted);
    cursor: default;
    box-shadow: none;
}

#cirurgicoDashboard .filter-chip.is-empty:hover {
    border-color: rgba(148, 163, 184, 0.35);
}

#cirurgicoDashboard .filter-chip[data-action="clear-all"] {
    background: rgba(255, 122, 74, 0.16);
    border-color: rgba(255, 122, 74, 0.35);
    color: var(--accent-dark);
}

#cirurgicoDashboard .filter-chip[data-action="clear-all"] i {
    color: var(--accent);
}

#cirurgicoDashboard .filter-chip[data-action="clear-all"]:hover {
    background: rgba(255, 122, 74, 0.28);
}

#cirurgicoDashboard .skeleton-block {
    position: relative;
    overflow: hidden;
}

#cirurgicoDashboard[data-loading="true"] .skeleton-block {
    color: transparent !important;
}

#cirurgicoDashboard[data-loading="true"] .skeleton-block::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, rgba(231, 237, 242, 0.05) 0%, rgba(231, 237, 242, 0.8) 50%, rgba(231, 237, 242, 0.05) 100%);
    animation: skeleton-shimmer 1.4s infinite;
}

#cirurgicoDashboard[data-loading="true"] .chart-wrapper canvas {
    opacity: 0;
}

@keyframes skeleton-shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

#cirurgicoDashboard .kpi-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 22px;
}

#cirurgicoDashboard .kpi-card {
    background: var(--surface);
    border: 1px solid rgba(111, 232, 181, 0.25);
    border-radius: var(--border-radius-xl);
    padding: 22px;
    box-shadow: var(--shadow-md);
    transition: var(--transition-normal);
    position: relative;
    overflow: hidden;
}

#cirurgicoDashboard .kpi-card::before {
    content: '';
    position: absolute;
    inset: -40% -20%;
    background: radial-gradient(circle, rgba(111, 232, 181, 0.2), transparent 55%);
    opacity: 0;
    transition: opacity var(--transition-fast);
}

#cirurgicoDashboard .kpi-card:hover::before {
    opacity: 1;
}

#cirurgicoDashboard .kpi-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 18px;
}

#cirurgicoDashboard .kpi-title {
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--text-title);
    margin-bottom: 4px;
}

#cirurgicoDashboard .kpi-value {
    font-size: 2rem;
    font-weight: 800;
    color: var(--text-title);
}

#cirurgicoDashboard .kpi-icon {
    width: 54px;
    height: 54px;
    border-radius: 16px;
    background: rgba(111, 232, 181, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-dark);
    font-size: 1.4rem;
}

#cirurgicoDashboard .trend-up {
    color: var(--primary);
}

#cirurgicoDashboard .trend-down {
    color: var(--accent);
}

#cirurgicoDashboard .charts-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 24px;
}

#cirurgicoDashboard .chart-container {
    background: var(--surface);
    border: 1px solid rgba(201, 243, 224, 0.8);
    border-radius: var(--border-radius-xl);
    padding: 24px;
    box-shadow: var(--shadow-md);
    transition: transform var(--transition-normal), box-shadow var(--transition-normal);
    position: relative;
}

#cirurgicoDashboard .chart-container:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
}

#cirurgicoDashboard .chart-container.is-expanded {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: min(92vw, 980px);
    height: min(86vh, 640px);
    z-index: 1100;
    box-shadow: 0 35px 60px rgba(94, 107, 115, 0.28);
}

#cirurgicoDashboard .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

#cirurgicoDashboard .chart-title {
    font-size: 1.05rem;
    font-weight: 700;
    color: var(--text-title);
}

#cirurgicoDashboard .chart-actions {
    display: flex;
    gap: 12px;
}

#cirurgicoDashboard .chart-btn {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    border: 1px solid rgba(111, 232, 181, 0.4);
    background: rgba(111, 232, 181, 0.12);
    color: var(--primary-dark);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition-fast);
}

#cirurgicoDashboard .chart-btn:hover {
    background: rgba(111, 232, 181, 0.2);
    transform: translateY(-1px);
}

#cirurgicoDashboard .chart-wrapper {
    position: relative;
    height: 320px;
}

#cirurgicoDashboard .chart-container.is-expanded .chart-wrapper {
    height: calc(100% - 60px);
}

#cirurgicoDashboard .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 25px;
}

#cirurgicoDashboard .grid-item {
    background: var(--surface);
    border: 1px solid var(--surface-border);
    border-radius: var(--border-radius-xl);
    padding: 24px;
    box-shadow: var(--shadow-md);
    transition: var(--transition-normal);
}

#cirurgicoDashboard .grid-item:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
}

#cirurgicoDashboard .grid-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

#cirurgicoDashboard .grid-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text-title);
}

#cirurgicoDashboard .grid-content {
    height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
}

#cirurgicoDashboard .insights-section {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 24px;
}

@media (max-width: 1024px) {
    #cirurgicoDashboard .insights-section {
        grid-template-columns: 1fr;
    }
}

#cirurgicoDashboard .table-card,
#cirurgicoDashboard .insight-card {
    background: var(--surface);
    border: 1px solid rgba(201, 243, 224, 0.8);
    border-radius: var(--border-radius-xl);
    padding: 24px;
    box-shadow: var(--shadow-md);
    transition: transform var(--transition-normal), box-shadow var(--transition-normal);
}

#cirurgicoDashboard .table-card:hover,
#cirurgicoDashboard .insight-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
}

#cirurgicoDashboard .table-scroll {
    max-height: 420px;
    overflow-y: auto;
    border-radius: var(--border-radius-md);
    border: 1px solid rgba(201, 243, 224, 0.5);
}

#cirurgicoDashboard .data-table {
    width: 100%;
    border-collapse: collapse;
}

#cirurgicoDashboard .data-table thead {
    background: rgba(201, 243, 224, 0.35);
}

#cirurgicoDashboard .data-table th,
#cirurgicoDashboard .data-table td {
    padding: 16px 18px;
    text-align: left;
    border-bottom: 1px solid rgba(201, 243, 224, 0.4);
}

#cirurgicoDashboard .data-table tbody tr:hover {
    background: rgba(201, 243, 224, 0.25);
}

#cirurgicoDashboard .data-table .empty-row {
    text-align: center;
    color: var(--text-muted);
    font-style: italic;
}

#cirurgicoDashboard .table-header,
#cirurgicoDashboard .insight-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 18px;
}

#cirurgicoDashboard .table-title,
#cirurgicoDashboard .insight-title {
    font-size: 1.05rem;
    font-weight: 700;
    color: var(--text-title);
}

#cirurgicoDashboard .badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    border-radius: 999px;
    background: rgba(111, 232, 181, 0.15);
    color: var(--primary-dark);
    font-weight: 600;
    font-size: 0.85rem;
}

#cirurgicoDashboard .insight-list {
    display: flex;
    flex-direction: column;
    gap: 14px;
}

#cirurgicoDashboard .insight-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    color: var(--text-body);
    font-size: 0.95rem;
    line-height: 1.5;
}

#cirurgicoDashboard .insight-item i {
    font-size: 1.1rem;
    margin-top: 3px;
}

#cirurgicoDashboard .dashboard-footer {
    text-align: center;
    padding: 24px;
    border-top: 1px solid var(--surface-border);
    margin-top: auto;
    color: var(--text-muted);
    font-size: 0.85rem;
}
        /* ===== FOOTER ===== */
        .dashboard-footer {
            text-align: center;
            padding: 25px;
            color: var(--text-muted);
            font-size: 0.85rem;
            border-top: 1px solid var(--surface-border);
            margin-top: auto;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }

        .footer-link {
            color: var(--text-body);
            text-decoration: none;
            transition: var(--transition-fast);
        }

        .footer-link:hover {
            color: var(--primary-dark);
        }
    </style>
</head>
<body data-theme="ambulatorial" data-dataset="ambulatorial">
    <div class="app-shell">
        <aside class="app-sidebar">
            <div class="sidebar-header">
                <span class="sidebar-title">Painéis Gerenciados</span>
                <i class="fas fa-chart-line"></i>
            </div>
            <nav class="sidebar-nav" role="navigation" aria-label="Seleção de dashboards">
                <button type="button" class="sidebar-link is-active" data-dataset-target="ambulatorial">
                    <span class="sidebar-link-icon"><i class="fas fa-stethoscope"></i></span>
                    <span class="sidebar-link-text">
                        <span class="sidebar-link-label">Ambulatorial</span>
                        <span class="sidebar-link-description">Consultas e indicadores clínicos</span>
                    </span>
                </button>
                <button type="button" class="sidebar-link" data-dataset-target="cirurgico">
                    <span class="sidebar-link-icon"><i class="fas fa-notes-medical"></i></span>
                    <span class="sidebar-link-text">
                        <span class="sidebar-link-label">Cirúrgico</span>
                        <span class="sidebar-link-description">Centro cirúrgico e procedimentos</span>
                    </span>
                </button>
            </nav>
            <div class="sidebar-footer">
                <strong>Hospital Universitário do Ceará</strong><br>
                Escolha qual BI deseja visualizar para carregar indicadores dedicados.
            </div>
        </aside>
        <main class="app-main">
            <div class="dashboard-container">
                <div class="global-loading" id="globalLoading" aria-hidden="true">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Carregando indicadores atualizados...</div>
                    </div>
                </div>
                <div id="ambulatorialDashboard" class="dashboard-view dashboard-view--ambulatorial" data-view="ambulatorial" aria-hidden="false">
        <!-- HEADER COM DESIGN FUTURISTA -->
        <header class="dashboard-header animate-fade-in-up">
            <div class="header-content">
                <div class="header-title">
                    <div class="logo">
                        <img src="https://i.ibb.co/1f1VWwpm/signa-icon.png" alt="Hospital Universitário do Ceará - Marca institucional">
                    </div>
                    <div class="title-text">
                        <h1>Hospital Universitário do Ceará - Indicadores Gerenciados</h1>
                        <div class="title-meta">
                            <span class="dataset-badge" id="datasetBadge" aria-live="polite">
                                <i class="fas fa-stethoscope"></i> BI Ambulatorial
                            </span>
                            <p id="datasetSubtitle">Núcleo de Atendimento ao Cliente</p>
                        </div>
                    </div>
                </div>
                <div class="header-controls">
                    <button class="btn btn-primary" type="button" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i> Atualizar Dados
                    </button>
                    <button class="btn btn-success" type="button" id="exportBtn">
                        <i class="fas fa-download"></i> Exportar Relatório
                    </button>
                    <button class="btn btn-accent" type="button" id="settingsBtn" title="Configurações do painel">
                        <i class="fas fa-cog"></i> Configurações
                    </button>
                    <button class="btn btn-outline" type="button" id="themeToggleBtn" aria-pressed="false">
                        <i class="fas fa-moon" aria-hidden="true"></i>
                        <span class="btn-label">Modo Plantão</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- BARRA DE BUSCA AVANÇADA -->
        <section class="search-section animate-fade-in-up">
            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" 
                       placeholder="Buscar por prontuário, nome do paciente ou código...">
                <i class="fas fa-search search-icon"></i>
            </div>
            <button class="btn btn-primary" id="searchBtn">
                <i class="fas fa-search"></i> Buscar
            </button>
            <div class="performance-info" id="performanceInfo">
                <i class="fas fa-bolt"></i> Sistema Otimizado • 40K+ Registros
            </div>
        </section>

        <!-- FILTROS INTELIGENTES -->
        <section class="filters-section animate-fade-in-up">
            <div class="filter-group">
                <label class="filter-label">Especialidade Médica</label>
                <select class="filter-select" id="especialidadeFilter">
                    <option value="">Todas as Especialidades</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Situação</label>
                <select class="filter-select" id="situacaoFilter">
                    <option value="">Todas as Situações</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Tipo de Consulta</label>
                <select class="filter-select" id="tipoConsultaFilter">
                    <option value="">Todos os Tipos</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Período de Análise</label>
                <select class="filter-select" id="periodTypeFilter">
                    <option value="diario">Diário</option>
                    <option value="semanal">Semanal</option>
                    <option value="mensal" selected>Mensal</option>
                    <option value="bimestral">Bimestral</option>
                    <option value="trimestral">Trimestral</option>
                    <option value="semestral">Semestral</option>
                </select>
            </div>
            <div class="filter-group is-hidden" id="mesFilterGroup">
                <label class="filter-label">Mês de Referência</label>
                <select class="filter-select" id="mesFilter">
                    <option value="">Selecione o mês</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Intervalos Selecionados</label>
                <div class="multi-select" id="periodRangeControl">
                    <button type="button" class="multi-select-trigger" aria-haspopup="listbox" aria-expanded="false">
                        <span id="periodRangeSummary">Todos os intervalos</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="multi-select-dropdown" role="listbox">
                        <div class="multi-select-actions">
                            <button type="button" data-action="select-all">Selecionar todos</button>
                            <button type="button" data-action="clear-all">Limpar</button>
                        </div>
                        <div class="multi-select-options" id="periodRangeOptions"></div>
                    </div>
                    <div class="multi-select-summary" id="periodRangeBadges"></div>
                </div>
                <select class="filter-select-hidden" id="periodRangeFilter" multiple></select>
                <span class="filter-helper" id="periodRangeHelper">Selecione um ou mais intervalos conforme o período escolhido.</span>
            </div>
            <div class="filter-group">
                <label class="filter-label">Ano</label>
                <select class="filter-select" id="anoFilter">
                    <option value="">Todos os Anos</option>
                </select>
            </div>
        </section>

        <!-- KPIs COM CARDS ANIMADOS -->
        <section class="kpi-section">
            <div class="kpi-card animate-fade-in-up">
                <div class="kpi-header">
                    <div>
                        <div class="kpi-title">Consultas Realizadas</div>
                        <div class="kpi-value" id="totalConsultas">0</div>
                    </div>
                    <div class="kpi-icon">
                        <i class="fas fa-user-md"></i>
                    </div>
                </div>
                <div class="kpi-trend trend-up">
                    Indicador baseado nos filtros ativos
                </div>
            </div>

            <div class="kpi-card animate-fade-in-up" data-variant="agendamentos" style="animation-delay: 0.05s">
                <div class="kpi-header">
                    <div>
                        <div class="kpi-title">Agendamentos Totais</div>
                        <div class="kpi-value" id="totalAgendamentos">0</div>
                    </div>
                    <div class="kpi-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                </div>
                <div class="kpi-trend trend-up">
                    Inclui consultas realizadas e faltantes
                </div>
            </div>

            <div class="kpi-card animate-fade-in-up" data-kpi-card="absenteismo" style="animation-delay: 0.1s">
                <div class="kpi-header">
                    <div>
                        <div class="kpi-title">Percentual de Absenteísmo</div>
                        <div class="kpi-value" id="percentualAbsenteismo">0%</div>
                    </div>
                    <div class="kpi-icon">
                        <i class="fas fa-user-times"></i>
                    </div>
                </div>
                <div class="kpi-trend trend-down">
                    Faltas sobre o total de agendamentos
                </div>
            </div>

            <div class="kpi-card animate-fade-in-up" style="animation-delay: 0.2s">
                <div class="kpi-header">
                    <div>
                        <div class="kpi-title">Pacientes em Segmento</div>
                        <div class="kpi-value" id="pacientesSegmento">0</div>
                    </div>
                    <div class="kpi-icon">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
                <div class="kpi-trend trend-up">
                    Pacientes únicos com consulta realizada
                </div>
            </div>
        </section>

        <!-- GRÁFICOS INTERATIVOS -->
        <section class="charts-section">
            <div class="chart-container animate-fade-in-up" data-chart-key="especialidade">
                <div class="chart-header">
                    <div class="chart-title">Atendimentos válidos por especialidade</div>
                    <div class="chart-actions">
                        <button class="chart-btn" type="button" title="Exportar dados" aria-label="Exportar dados"><i class="fas fa-download"></i></button>
                        <button class="chart-btn chart-expand-btn" type="button" data-action="expand-chart" aria-expanded="false" aria-label="Expandir gráfico" title="Expandir gráfico"><i class="fas fa-expand"></i></button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="especialidadeChart"></canvas>
                </div>
                <div class="chart-legend chart-legend--highlight is-hidden" data-chart-legend="especialidade" role="list" aria-label="Legenda: atendimentos válidos por especialidade" aria-hidden="true"></div>
            </div>

            <div class="chart-container animate-fade-in-up" style="animation-delay: 0.1s" data-chart-key="evolucao">
                <div class="chart-header">
                    <div class="chart-title">Evolução Mensal</div>
                    <div class="chart-actions">
                        <button class="chart-btn" type="button" title="Exportar dados" aria-label="Exportar dados"><i class="fas fa-download"></i></button>
                        <button class="chart-btn chart-expand-btn" type="button" data-action="expand-chart" aria-expanded="false" aria-label="Expandir gráfico" title="Expandir gráfico"><i class="fas fa-expand"></i></button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="evolucaoChart"></canvas>
                </div>
                <div class="chart-legend chart-legend--highlight is-hidden" data-chart-legend="evolucao" role="list" aria-label="Legenda: evolução mensal" aria-hidden="true"></div>
            </div>

            <div class="chart-container animate-fade-in-up" style="animation-delay: 0.2s" data-chart-key="tipoConsulta">
                <div class="chart-header">
                    <div class="chart-title">Tipos de Consulta Realizadas</div>
                    <div class="chart-actions">
                        <button class="chart-btn" type="button" title="Alternar formato" aria-label="Alternar formato"><i class="fas fa-chart-pie"></i></button>
                        <button class="chart-btn chart-expand-btn" type="button" data-action="expand-chart" aria-expanded="false" aria-label="Expandir gráfico" title="Expandir gráfico"><i class="fas fa-expand"></i></button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="tipoConsultaChart"></canvas>
                </div>
            </div>
        </section>

        <section class="demographic-section">
            <div class="chart-container animate-fade-in-up" data-chart-key="faixaEtaria">
                <div class="chart-header">
                    <div class="chart-title">Faixa etária - Pacientes atendidos</div>
                    <div class="chart-actions">
                        <button class="chart-btn chart-expand-btn" type="button" data-action="expand-chart" aria-expanded="false" aria-label="Expandir gráfico" title="Expandir gráfico"><i class="fas fa-expand"></i></button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="faixaEtariaChart"></canvas>
                </div>
            </div>

            <div class="chart-container animate-fade-in-up" style="animation-delay: 0.1s" data-chart-key="genero">
                <div class="chart-header">
                    <div class="chart-title">Distribuição por gênero</div>
                    <div class="chart-actions">
                        <button class="chart-btn chart-expand-btn" type="button" data-action="expand-chart" aria-expanded="false" aria-label="Expandir gráfico" title="Expandir gráfico"><i class="fas fa-expand"></i></button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="generoChart"></canvas>
                </div>
            </div>

            <div class="chart-container animate-fade-in-up" style="animation-delay: 0.2s" data-chart-key="desfechos">
                <div class="chart-header">
                    <div class="chart-title">Desfechos das consultas</div>
                    <div class="chart-actions">
                        <button class="chart-btn chart-expand-btn" type="button" data-action="expand-chart" aria-expanded="false" aria-label="Expandir gráfico" title="Expandir gráfico"><i class="fas fa-expand"></i></button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="desfechoChart"></canvas>
                </div>
                <div class="chart-legend chart-legend--highlight is-hidden" data-chart-legend="desfecho" role="list" aria-label="Legenda: desfechos das consultas" aria-hidden="true"></div>
            </div>
        </section>

        <section class="insights-section">
            <div class="table-card animate-fade-in-up">
                <div class="table-header">
                    <div class="table-title">Consultas por Especialidade</div>
                    <div class="badge">
                        <i class="fas fa-chart-pie"></i>
                        <span id="consultasBadge">Visão consolidada</span>
                    </div>
                </div>
                <div class="table-scroll" role="region" aria-live="polite">
                    <table class="data-table">
                        <colgroup>
                            <col>
                            <col>
                            <col>
                        </colgroup>
                        <thead>
                            <tr>
                                <th>Especialidade</th>
                                <th>Atendimentos válidos</th>
                                <th>Participação</th>
                            </tr>
                        </thead>
                        <tbody id="consultasEspecialidadeBody">
                            <tr class="empty-row">
                                <td colspan="3">Carregando dados...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="insight-card animate-fade-in-up" style="animation-delay: 0.1s">
                <div class="insight-header">
                    <div class="insight-title">Insights de Especialidades</div>
                    <button class="chart-btn" id="insightsRefreshBtn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <ul class="insight-list">
                    <li class="insight-item">
                        <i class="fas fa-user-check"></i>
                        <span>Total de atendimentos válidos: <strong id="insightTotalAtendimentos">0</strong></span>
                    </li>
                    <li class="insight-item">
                        <i class="fas fa-trophy"></i>
                        <span>Especialidade líder: <strong id="insightEspecialidadeLider">-</strong></span>
                    </li>
                    <li class="insight-item">
                        <i class="fas fa-layer-group"></i>
                        <span>Top 3 especialidades: <strong id="insightTopEspecialidades">-</strong></span>
                    </li>
                </ul>
            </div>
        </section>

        <!-- FOOTER -->
        <footer class="dashboard-footer">
            <div>NEXUS MED Dashboard &copy; 2024 - Sistema de Gestão Médica Inteligente</div>
            <div class="footer-links">
                <a href="#" class="footer-link">Privacidade</a>
                <a href="#" class="footer-link">Termos</a>
                <a href="#" class="footer-link">Suporte</a>
                <a href="#" class="footer-link">Documentação</a>
            </div>
        </footer>
                </div>

                <div id="cirurgicoDashboard" class="dashboard-view dashboard-view--cirurgico" data-view="cirurgico" data-loading="false" aria-hidden="true">
                    <header class="dashboard-header">
                        <div class="header-content">
                            <div class="header-title">
                                <div class="logo" aria-hidden="true">
                                    <i class="fas fa-heartbeat"></i>
                                </div>
                                <div class="title-text">
                                    <h1>Painel BI - Gestão Cirúrgica</h1>
                                    <p>Monitoramento e análise de dados cirúrgicos em tempo real</p>
                                </div>
                            </div>
                            <div class="header-controls">
                                <button class="btn btn-accent" type="button" id="cirurgicoRefreshBtn">
                                    <i class="fas fa-sync-alt"></i>
                                    Atualizar
                                </button>
                                <button class="btn btn-primary" type="button" id="cirurgicoExportBtn">
                                    <i class="fas fa-file-export"></i>
                                    Exportar
                                </button>
                            </div>
                        </div>
                    </header>

                    <section class="search-section">
                        <div class="search-container">
                            <input type="text" class="search-input" id="cirurgicoSearchInput" placeholder="Buscar por prontuário, nome, município...">
                            <div class="search-icon">
                                <i class="fas fa-search"></i>
                            </div>
                        </div>
                        <div class="performance-info" id="cirurgicoPerformanceInfo">
                            <i class="fas fa-bolt"></i>
                            Última atualização: <span id="cirurgicoLastUpdate">--:--</span>
                        </div>
                    </section>

                    <nav class="quick-nav" id="cirurgicoQuickNav" aria-label="Navegação rápida do BI Cirúrgico">
                        <button type="button" class="quick-nav-btn" data-scroll-target="#cirurgicoFiltersSection"><i class="fas fa-filter"></i><span>Filtros</span></button>
                        <button type="button" class="quick-nav-btn" data-scroll-target="#cirurgicoKpiSection"><i class="fas fa-chart-line"></i><span>Indicadores</span></button>
                        <button type="button" class="quick-nav-btn" data-scroll-target="#cirurgicoChartsSection"><i class="fas fa-chart-pie"></i><span>Gráficos</span></button>
                        <button type="button" class="quick-nav-btn" data-scroll-target="#cirurgicoInsightsSection"><i class="fas fa-lightbulb"></i><span>Insights</span></button>
                    </nav>

                    <section class="filters-section" id="cirurgicoFiltersSection">
                        <div class="filters-grid">
                            <div class="filter-group">
                                <label class="filter-label" for="cirurgicoProgramFilter">Programa</label>
                                <select class="filter-select" id="cirurgicoProgramFilter">
                                    <option value="">Todos os Programas</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label" for="cirurgicoYearFilter">Ano</label>
                                <select class="filter-select" id="cirurgicoYearFilter">
                                    <option value="">Todos os Anos</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label" for="cirurgicoMonthFilter">Mês</label>
                                <select class="filter-select" id="cirurgicoMonthFilter">
                                    <option value="">Todos os Meses</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label" for="cirurgicoSpecialtyFilter">Especialidade</label>
                                <select class="filter-select" id="cirurgicoSpecialtyFilter">
                                    <option value="">Todas as Especialidades</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label" for="cirurgicoSituationFilter">Situação FastMedic</label>
                                <select class="filter-select" id="cirurgicoSituationFilter">
                                    <option value="">Todas as Situações</option>
                                </select>
                            </div>
                        </div>
                        <div class="active-filters" id="cirurgicoActiveFilters" aria-live="polite">
                            <span class="filter-chip is-empty">Nenhum filtro ativo</span>
                        </div>
                    </section>

                    <section class="kpi-section" id="cirurgicoKpiSection">
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <div>
                                    <div class="kpi-title">Cirurgias Realizadas</div>
                                    <div class="kpi-value skeleton-block" id="cirurgicoSurgeriesCount">0</div>
                                    <div class="kpi-trend trend-up skeleton-block"><i class="fas fa-arrow-up"></i> Evolução positiva</div>
                                </div>
                                <div class="kpi-icon">
                                    <i class="fas fa-procedures"></i>
                                </div>
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <div>
                                    <div class="kpi-title">Agendamentos Pendentes</div>
                                    <div class="kpi-value skeleton-block" id="cirurgicoPendingCount">0</div>
                                    <div class="kpi-trend trend-down skeleton-block"><i class="fas fa-arrow-down"></i> Acompanhamento contínuo</div>
                                </div>
                                <div class="kpi-icon">
                                    <i class="fas fa-calendar-check"></i>
                                </div>
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <div>
                                    <div class="kpi-title">Pacientes Federais</div>
                                    <div class="kpi-value skeleton-block" id="cirurgicoFederalCount">0</div>
                                    <div class="kpi-trend trend-up skeleton-block"><i class="fas fa-arrow-up"></i> Tendência de crescimento</div>
                                </div>
                                <div class="kpi-icon">
                                    <i class="fas fa-user-injured"></i>
                                </div>
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <div>
                                    <div class="kpi-title">Pacientes Estaduais</div>
                                    <div class="kpi-value skeleton-block" id="cirurgicoStateCount">0</div>
                                    <div class="kpi-trend trend-up skeleton-block"><i class="fas fa-arrow-up"></i> Monitoramento ativo</div>
                                </div>
                                <div class="kpi-icon">
                                    <i class="fas fa-user-md"></i>
                                </div>
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <div>
                                    <div class="kpi-title">Taxa de Confirmação</div>
                                    <div class="kpi-value skeleton-block" id="cirurgicoConfirmationRate">0%</div>
                                    <div class="kpi-trend trend-up skeleton-block"><i class="fas fa-arrow-up"></i> Tendência positiva</div>
                                </div>
                                <div class="kpi-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <div>
                                    <div class="kpi-title">Tempo médio de espera</div>
                                    <div class="kpi-value skeleton-block" id="cirurgicoAvgWaitTime">0d</div>
                                    <div class="kpi-trend trend-down skeleton-block"><i class="fas fa-hourglass-half"></i> Acompanhamento contínuo</div>
                                </div>
                                <div class="kpi-icon">
                                    <i class="fas fa-stopwatch"></i>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="charts-section" id="cirurgicoChartsSection">
                        <div class="chart-container" data-cirurgico-chart="especialidade">
                            <div class="chart-header">
                                <div class="chart-title">Distribuição por Especialidade</div>
                                <div class="chart-actions">
                                    <button class="chart-btn chart-expand-btn" type="button" data-action="expand-chart" data-cirurgico-chart-target="cirurgicoSpecialtyChart" aria-expanded="false"><i class="fas fa-expand"></i></button>
                                </div>
                            </div>
                            <div class="chart-wrapper skeleton-block">
                                <canvas id="cirurgicoSpecialtyChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container" data-cirurgico-chart="mensal">
                            <div class="chart-header">
                                <div class="chart-title">Evolução Mensal</div>
                                <div class="chart-actions">
                                    <button class="chart-btn chart-expand-btn" type="button" data-action="expand-chart" data-cirurgico-chart-target="cirurgicoMonthlyChart" aria-expanded="false"><i class="fas fa-expand"></i></button>
                                </div>
                            </div>
                            <div class="chart-wrapper skeleton-block">
                                <canvas id="cirurgicoMonthlyChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container" data-cirurgico-chart="status">
                            <div class="chart-header">
                                <div class="chart-title">Status dos Agendamentos</div>
                                <div class="chart-actions">
                                    <button class="chart-btn chart-expand-btn" type="button" data-action="expand-chart" data-cirurgico-chart-target="cirurgicoStatusChart" aria-expanded="false"><i class="fas fa-expand"></i></button>
                                </div>
                            </div>
                            <div class="chart-wrapper skeleton-block">
                                <canvas id="cirurgicoStatusChart"></canvas>
                            </div>
                        </div>
                    </section>

                    <section class="dashboard-grid" id="cirurgicoGridSection">
                        <div class="grid-item">
                            <div class="grid-header">
                                <div class="grid-title">Distribuição Geográfica - Ceará</div>
                            </div>
                            <div class="grid-content" id="cirurgicoMapContainer">
                                <div style="display: flex; align-items: center; justify-content: center; height: 100%; gap: 16px;">
                                    <i class="fas fa-map-marked-alt" style="font-size: 2.8rem; color: var(--primary);"></i>
                                    <span style="font-size: 1rem; color: var(--text-body);">Mapa interativo disponível na versão integrada</span>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="insights-section" id="cirurgicoInsightsSection">
                        <div class="table-card">
                            <div class="table-header">
                                <div class="table-title">Registros Cirúrgicos</div>
                                <div class="badge">
                                    <i class="fas fa-table"></i>
                                    <span class="skeleton-block" id="cirurgicoTableCount">0 registros</span>
                                </div>
                            </div>
                            <div class="table-scroll skeleton-block">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Paciente / Procedimento</th>
                                            <th>Data</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cirurgicoDataTableBody">
                                        <tr class="empty-row">
                                            <td colspan="3">Nenhum dado disponível</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-header">
                                <div class="insight-title">Insights Cirúrgicos</div>
                                <div class="badge">
                                    <i class="fas fa-lightbulb"></i>
                                    <span>Análise</span>
                                </div>
                            </div>
                            <ul class="insight-list skeleton-block" id="cirurgicoInsightsList">
                                <li class="insight-item">
                                    <i class="fas fa-info-circle" style="color: var(--primary);"></i>
                                    <span>Carregando análises...</span>
                                </li>
                            </ul>
                        </div>
                    </section>

                    <footer class="dashboard-footer">
                        <p>Sistema de Gestão de Dados Cirúrgicos - Painel BI</p>
                        <div class="footer-links">
                            <a href="#" class="footer-link">Suporte</a>
                            <a href="#" class="footer-link">Documentação</a>
                            <a href="#" class="footer-link">Privacidade</a>
                        </div>
                    </footer>
                </div>

    </footer>
</div>

            </div>
        </main>
    </div>

    <div class="chart-overlay" id="chartOverlay" aria-hidden="true"></div>

    <script>
        // ===== SISTEMA PRINCIPAL DO DASHBOARD =====
        document.addEventListener('DOMContentLoaded', function() {
            restoreDatasetSelection();
            updateDatasetVisuals();
            setupDatasetMenu();
            ThemeManager.initialize();
            console.log(`🚀 NEXUS MED Dashboard Iniciado • BI ativo: ${activeDataset.toUpperCase()}`);

            if (activeDataset === 'cirurgico') {
                CirurgicoDashboard.activate({ initialLoad: true }).catch(error => {
                    console.error('Falha ao iniciar o BI cirúrgico:', error);
                    showError('Não foi possível carregar o BI Cirúrgico na abertura.');
                });
            } else {
                initializeDashboard();
                setupEventListeners();
            }

            ThemeManager.syncToggle();
            startBackgroundAnimations();
        });

        // ===== VARIÁVEIS GLOBAIS =====
        const hasAppsScript = typeof google !== 'undefined' && google.script && google.script.run;
        const FALLBACK_DATASETS = Object.freeze({
            ambulatorial: {
                kpis: {
                    totalConsultas: 1840,
                    percentualAbsenteismo: 7.4,
                    pacientesSegmento: 965,
                    totalRegistros: 1840,
                    totalFaltas: 136,
                    totalAgendamentos: 1976
                },
                consultasEspecialidade: [
                    { especialidade: 'CARDIOLOGIA', consultas: 340 },
                    { especialidade: 'DERMATOLOGIA', consultas: 275 },
                    { especialidade: 'PEDIATRIA', consultas: 410 },
                    { especialidade: 'ONCOLOGIA', consultas: 180 },
                    { especialidade: 'ORTOPEDIA', consultas: 295 },
                    { especialidade: 'NEUROLOGIA', consultas: 140 },
                    { especialidade: 'GINECOLOGIA', consultas: 200 }
                ],
                charts: {
                    especialidadesValidas: {
                        labels: ['CARDIOLOGIA', 'DERMATOLOGIA', 'PEDIATRIA', 'ONCOLOGIA', 'ORTOPEDIA', 'NEUROLOGIA', 'GINECOLOGIA'],
                        data: [340, 275, 410, 180, 295, 140, 200]
                    },
                    evolucao: {
                        labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                        data: [260, 280, 295, 305, 340, 360]
                    },
                    situacoes: {
                        labels: ['CONCLUÍDO', 'ANDAMENTO', 'ALTA AMBULATORIAL'],
                        data: [520, 180, 76]
                    },
                    faixaEtaria: {
                        labels: ['Criança', 'Adulto', 'Idoso'],
                        data: [180, 980, 380]
                    },
                    genero: {
                        labels: ['Feminino', 'Masculino'],
                        data: [960, 880]
                    },
                    desfechos: {
                        labels: ['Concluído', 'Em andamento', 'Alta ambulatorial', 'Cancelado'],
                        data: [520, 180, 76, 42]
                    },
                    tipoConsulta: {
                        labels: ['Primeira Consulta', 'Retorno', 'Teleatendimento', 'Urgência'],
                        data: [820, 610, 290, 120]
                    }
                },
                especialidadesResumo: [
                    { especialidade: 'CARDIOLOGIA', consultas: 340 },
                    { especialidade: 'PEDIATRIA', consultas: 410 },
                    { especialidade: 'ORTOPEDIA', consultas: 295 }
                ]
            },
            cirurgico: {
                kpis: {
                    totalConsultas: 742,
                    percentualAbsenteismo: 2.9,
                    pacientesSegmento: 418,
                    totalRegistros: 742,
                    totalFaltas: 28,
                    totalAgendamentos: 770
                },
                consultasEspecialidade: [
                    { especialidade: 'CIRURGIA GERAL', consultas: 182 },
                    { especialidade: 'ORTOPEDIA', consultas: 126 },
                    { especialidade: 'NEUROCIRURGIA', consultas: 88 },
                    { especialidade: 'CARDÍACA', consultas: 76 },
                    { especialidade: 'UROLOGIA', consultas: 94 },
                    { especialidade: 'OBSTETRÍCIA', consultas: 82 },
                    { especialidade: 'OTORRINOLARINGOLOGIA', consultas: 74 }
                ],
                charts: {
                    especialidadesValidas: {
                        labels: ['CIRURGIA GERAL', 'ORTOPEDIA', 'NEUROCIRURGIA', 'CARDÍACA', 'UROLOGIA', 'OBSTETRÍCIA', 'OTORRINOLARINGOLOGIA'],
                        data: [182, 126, 88, 76, 94, 82, 74]
                    },
                    evolucao: {
                        labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                        data: [58, 62, 66, 71, 79, 84]
                    },
                    situacoes: {
                        labels: ['REALIZADA', 'AGENDADA', 'CANCELADA', 'REPROGRAMADA'],
                        data: [402, 188, 52, 36]
                    },
                    faixaEtaria: {
                        labels: ['0-17 anos', '18-39 anos', '40-59 anos', '60+ anos'],
                        data: [48, 232, 294, 168]
                    },
                    genero: {
                        labels: ['Feminino', 'Masculino'],
                        data: [368, 374]
                    },
                    desfechos: {
                        labels: ['Alta', 'Internação Prolongada', 'UTI', 'Reoperação'],
                        data: [488, 76, 54, 28]
                    },
                    tipoConsulta: {
                        labels: ['Eletiva', 'Urgência', 'Pré-Operatório Ambulatorial', 'Revisão Pós-Operatória'],
                        data: [356, 184, 128, 74]
                    }
                },
                especialidadesResumo: [
                    { especialidade: 'CIRURGIA GERAL', consultas: 182 },
                    { especialidade: 'ORTOPEDIA', consultas: 126 },
                    { especialidade: 'CARDÍACA', consultas: 76 }
                ]
            }
        });
        const CirurgicoDashboard = (() => {
            const SELECTORS = Object.freeze({
                container: 'cirurgicoDashboard',
                refreshBtn: 'cirurgicoRefreshBtn',
                exportBtn: 'cirurgicoExportBtn',
                searchInput: 'cirurgicoSearchInput',
                performanceInfo: 'cirurgicoPerformanceInfo',
                lastUpdate: 'cirurgicoLastUpdate',
                programFilter: 'cirurgicoProgramFilter',
                yearFilter: 'cirurgicoYearFilter',
                monthFilter: 'cirurgicoMonthFilter',
                specialtyFilter: 'cirurgicoSpecialtyFilter',
                situationFilter: 'cirurgicoSituationFilter',
                activeFilters: 'cirurgicoActiveFilters',
                quickNav: 'cirurgicoQuickNav',
                surgeriesCount: 'cirurgicoSurgeriesCount',
                pendingCount: 'cirurgicoPendingCount',
                federalCount: 'cirurgicoFederalCount',
                stateCount: 'cirurgicoStateCount',
                confirmationRate: 'cirurgicoConfirmationRate',
                avgWaitTime: 'cirurgicoAvgWaitTime',
                tableBody: 'cirurgicoDataTableBody',
                tableCount: 'cirurgicoTableCount',
                insightsList: 'cirurgicoInsightsList',
                specialtyChart: 'cirurgicoSpecialtyChart',
                monthlyChart: 'cirurgicoMonthlyChart',
                statusChart: 'cirurgicoStatusChart'
            });

            const DEFAULT_FILTERS = Object.freeze({
                dataset: 'cirurgico',
                programa: '',
                ano: '',
                mes: '',
                especialidade: '',
                situacao: '',
                search: ''
            });

            const FILTER_LABELS = Object.freeze({
                programa: 'Programa',
                ano: 'Ano',
                mes: 'Mês',
                especialidade: 'Especialidade',
                situacao: 'Situação',
                search: 'Busca'
            });

            const FILTER_CONTROL_MAP = Object.freeze({
                programa: 'programFilter',
                ano: 'yearFilter',
                mes: 'monthFilter',
                especialidade: 'specialtyFilter',
                situacao: 'situationFilter',
                search: 'searchInput'
            });

            const fallbackData = Object.freeze({
                filters: {
                    programs: ['Federal', 'Estadual'],
                    years: ['2024', '2023'],
                    months: ['Janeiro', 'Fevereiro', 'Março'],
                    specialties: ['Cirurgia Geral', 'Ortopedia', 'Neurocirurgia', 'Cardíaca', 'Urologia'],
                    situations: ['Realizada', 'Agendada', 'Cancelada', 'Pendente']
                },
                rows: [
                    {
                        PRONTUÁRIO: '2024-001',
                        NOME: 'Ana Souza',
                        PROCEDIMENTO: 'Colecistectomia',
                        ESPECIALIDADE: 'Cirurgia Geral',
                        DATA_DA_CIRURGIA: '12/02/2024',
                        ANO: '2024',
                        MÊS: 'Fevereiro',
                        PROGRAMA: 'Federal',
                        STATUS_DO_AGENDAMENTO: 'Realizada',
                        SITUAÇÃO_FASTMEDIC: 'Confirmada'
                    },
                    {
                        PRONTUÁRIO: '2024-014',
                        NOME: 'Bruno Lima',
                        PROCEDIMENTO: 'Artroscopia de Joelho',
                        ESPECIALIDADE: 'Ortopedia',
                        DATA_DA_CIRURGIA: '22/02/2024',
                        ANO: '2024',
                        MÊS: 'Fevereiro',
                        PROGRAMA: 'Estadual',
                        STATUS_DO_AGENDAMENTO: 'Agendada',
                        SITUAÇÃO_FASTMEDIC: 'Autorizada'
                    },
                    {
                        PRONTUÁRIO: '2024-028',
                        NOME: 'Carla Menezes',
                        PROCEDIMENTO: 'Aneurismectomia',
                        ESPECIALIDADE: 'Neurocirurgia',
                        DATA_DA_CIRURGIA: '05/03/2024',
                        ANO: '2024',
                        MÊS: 'Março',
                        PROGRAMA: 'Federal',
                        STATUS_DO_AGENDAMENTO: 'Pendente',
                        SITUAÇÃO_FASTMEDIC: 'Aguardando Documentação'
                    }
                ],
                insights: [
                    { icon: 'fas fa-procedures', text: '128 cirurgias realizadas no período selecionado.' },
                    { icon: 'fas fa-clock', text: '24 agendamentos pendentes aguardando confirmação.' },
                    { icon: 'fas fa-chart-pie', text: '54% pacientes federais e 46% estaduais.' }
                ],
                metrics: {
                    surgeriesCount: 128,
                    pendingCount: 24,
                    federalCount: 72,
                    stateCount: 56,
                    confirmationRate: 84,
                    avgWaitTime: 5,
                    totalRecords: 210
                },
                charts: {
                    specialty: {
                        labels: ['Cirurgia Geral', 'Ortopedia', 'Neurocirurgia', 'Cardíaca', 'Urologia'],
                        data: [42, 32, 18, 16, 20]
                    },
                    monthly: {
                        labels: ['Jan 2024', 'Fev 2024', 'Mar 2024', 'Abr 2024'],
                        data: [28, 30, 32, 38]
                    },
                    status: {
                        labels: ['Realizada', 'Agendada', 'Cancelada', 'Reprogramada'],
                        data: [128, 42, 12, 8]
                    }
                }
            });

            const NORMALIZED_MARKER = Symbol('cirurgicoNormalized');
            const APPS_SCRIPT_TIMEOUT_MS = 15000;

            function normalizeFieldKey(key) {
                return (key || '')
                    .toString()
                    .trim()
                    .normalize('NFD')
                    .replace(/\p{Diacritic}/gu, '')
                    .replace(/[\s_/\\-]+/g, '')
                    .toLowerCase();
            }

            function buildNormalizedKeyMap(source) {
                const map = new Map();
                if (!source || typeof source !== 'object') {
                    return map;
                }

                Object.keys(source).forEach(key => {
                    const normalized = normalizeFieldKey(key);
                    if (normalized && !map.has(normalized)) {
                        map.set(normalized, key);
                    }
                });

                return map;
            }

            function resolveFieldValue(source, variants, normalizedMap) {
                if (!source || typeof source !== 'object' || !Array.isArray(variants)) {
                    return undefined;
                }

                const map = normalizedMap || buildNormalizedKeyMap(source);

                for (const variant of variants) {
                    const normalizedVariant = normalizeFieldKey(variant);
                    if (!normalizedVariant) {
                        continue;
                    }

                    const resolvedKey = map.get(normalizedVariant);
                    if (resolvedKey !== undefined) {
                        const value = source[resolvedKey];
                        if (value !== undefined && value !== null && value !== '') {
                            return value;
                        }
                    }
                }

                return undefined;
            }

            const CIRURGICO_FIELD_ALIASES = Object.freeze({
                'PRONTUÁRIO': ['PRONTUÁRIO', 'PRONTUARIO', 'PRONT'],
                'PRONTUARIO': ['PRONTUARIO', 'PRONTUÁRIO', 'PRONT'],
                'PROCEDIMENTO': ['PROCEDIMENTO', 'PROCEDIMENTO INDICADO', 'PROCEDIMENTO_INDICADO'],
                'PROCEDIMENTO INDICADO': ['PROCEDIMENTO INDICADO', 'PROCEDIMENTO', 'PROCEDIMENTO_INDICADO'],
                'DATA_DA_CIRURGIA': ['DATA_DA_CIRURGIA', 'DATA DA CIRURGIA'],
                'DATA DA CIRURGIA': ['DATA DA CIRURGIA', 'DATA_DA_CIRURGIA'],
                'STATUS_DO_AGENDAMENTO': ['STATUS_DO_AGENDAMENTO', 'STATUS DO AGENDAMENTO'],
                'STATUS DO AGENDAMENTO': ['STATUS DO AGENDAMENTO', 'STATUS_DO_AGENDAMENTO'],
                'SITUAÇÃO_FASTMEDIC': ['SITUAÇÃO_FASTMEDIC', 'SITUACAO_FASTMEDIC', 'SITUAÇÃO FASTMEDIC'],
                'SITUACAO_FASTMEDIC': ['SITUACAO_FASTMEDIC', 'SITUAÇÃO_FASTMEDIC', 'SITUAÇÃO FASTMEDIC'],
                'CONFIRMAÇÃO_DA_INTERNAÇÃO': ['CONFIRMAÇÃO_DA_INTERNAÇÃO', 'CONFIRMAÇÃO DA INTERNAÇÃO', 'CONFIRMACAO_DA_INTERNAÇÃO', 'CONFIRMACAO_DA_INTERNACAO'],
                'CONFIRMACAO_DA_INTERNAÇÃO': ['CONFIRMACAO_DA_INTERNAÇÃO', 'CONFIRMAÇÃO_DA_INTERNAÇÃO', 'CONFIRMAÇÃO DA INTERNAÇÃO', 'CONFIRMACAO_DA_INTERNACAO'],
                'CONFIRMACAO_DA_INTERNACAO': ['CONFIRMACAO_DA_INTERNACAO', 'CONFIRMAÇÃO_DA_INTERNAÇÃO', 'CONFIRMAÇÃO DA INTERNAÇÃO', 'CONFIRMACAO_DA_INTERNAÇÃO'],
                'TEMPO_DE_ESPERA': ['TEMPO_DE_ESPERA', 'TEMPO DE ESPERA PARA AGENDAMENTO CIRURGICO'],
                'MUNICÍPIO': ['MUNICÍPIO', 'MUNICIPIO'],
                'MUNICIPIO': ['MUNICÍPIO', 'MUNICIPIO'],
                'MÊS': ['MÊS', 'MES'],
                'MES': ['MÊS', 'MES']
            });

            function normalizeCirurgicoRecord(source) {
                if (!source || typeof source !== 'object') {
                    return {};
                }

                if (source[NORMALIZED_MARKER]) {
                    return source;
                }

                const normalized = { ...source };
                const normalizedKeyMap = buildNormalizedKeyMap(source);

                Object.entries(CIRURGICO_FIELD_ALIASES).forEach(([targetKey, variants]) => {
                    if (!Array.isArray(variants)) {
                        return;
                    }

                    const existing = normalized[targetKey];
                    if (existing !== undefined && existing !== null && existing !== '') {
                        return;
                    }

                    const value = resolveFieldValue(source, variants, normalizedKeyMap);
                    if (value !== undefined && value !== null && value !== '') {
                        normalized[targetKey] = value;
                    }
                });

                Object.defineProperty(normalized, NORMALIZED_MARKER, {
                    value: true,
                    enumerable: false
                });

                return normalized;
            }

            function mapToNormalized(records) {
                return Array.isArray(records) ? records.map(normalizeCirurgicoRecord) : [];
            }

            const state = {
                initialized: false,
                isActive: false,
                listenersBound: false,
                elements: null,
                charts: {
                    specialty: null,
                    monthly: null,
                    status: null
                },
                filters: { ...DEFAULT_FILTERS },
                allData: [],
                filteredData: [],
                lastUpdated: null
            };

            function getElement(id) {
                return document.getElementById(id);
            }

            function getElements() {
                if (state.elements) {
                    return state.elements;
                }

                state.elements = {
                    container: getElement(SELECTORS.container),
                    refreshBtn: getElement(SELECTORS.refreshBtn),
                    exportBtn: getElement(SELECTORS.exportBtn),
                    searchInput: getElement(SELECTORS.searchInput),
                    performanceInfo: getElement(SELECTORS.performanceInfo),
                    lastUpdate: getElement(SELECTORS.lastUpdate),
                    programFilter: getElement(SELECTORS.programFilter),
                    yearFilter: getElement(SELECTORS.yearFilter),
                    monthFilter: getElement(SELECTORS.monthFilter),
                    specialtyFilter: getElement(SELECTORS.specialtyFilter),
                    situationFilter: getElement(SELECTORS.situationFilter),
                    activeFilters: getElement(SELECTORS.activeFilters),
                    quickNav: getElement(SELECTORS.quickNav),
                    surgeriesCount: getElement(SELECTORS.surgeriesCount),
                    pendingCount: getElement(SELECTORS.pendingCount),
                    federalCount: getElement(SELECTORS.federalCount),
                    stateCount: getElement(SELECTORS.stateCount),
                    confirmationRate: getElement(SELECTORS.confirmationRate),
                    avgWaitTime: getElement(SELECTORS.avgWaitTime),
                    tableBody: getElement(SELECTORS.tableBody),
                    tableCount: getElement(SELECTORS.tableCount),
                    insightsList: getElement(SELECTORS.insightsList),
                    specialtyChart: getElement(SELECTORS.specialtyChart),
                    monthlyChart: getElement(SELECTORS.monthlyChart),
                    statusChart: getElement(SELECTORS.statusChart)
                };

                return state.elements;
            }

            function readThemeVariable(variableName, fallback = '#4FD69B') {
                const root = document.body || document.documentElement;
                if (!root || typeof getComputedStyle !== 'function') {
                    return fallback;
                }

                const value = getComputedStyle(root).getPropertyValue(variableName);
                return value ? value.trim() || fallback : fallback;
            }

            function getPalette() {
                return [
                    readThemeVariable('--primary', '#4FD69B'),
                    readThemeVariable('--primary-dark', '#2D9B73'),
                    readThemeVariable('--accent', '#FF7A4A'),
                    readThemeVariable('--accent-light', '#FFD3BF'),
                    readThemeVariable('--text-title', '#5E6B73'),
                    readThemeVariable('--text-body', '#7A8A93')
                ];
            }

            function debounce(func, wait = 300) {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), wait);
                };
            }

            function setPerformanceMessage(message) {
                const { performanceInfo } = getElements();
                if (performanceInfo) {
                    performanceInfo.innerHTML = `<i class="fas fa-bolt"></i> ${message}`;
                }
            }

            function setLastUpdate(timestamp) {
                const { lastUpdate } = getElements();
                const date = timestamp ? new Date(timestamp) : new Date();
                if (lastUpdate && !Number.isNaN(date.getTime())) {
                    lastUpdate.textContent = date.toLocaleTimeString('pt-BR', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            }

            function showGlobalLoading(show) {
                const loading = document.getElementById('globalLoading');
                if (!loading) {
                    return;
                }
                loading.setAttribute('aria-hidden', show ? 'false' : 'true');
                loading.classList.toggle('visible', show);
            }

            function toggleLoadingState(isLoading) {
                const { container } = getElements();
                if (!container) {
                    return;
                }
                container.setAttribute('data-loading', isLoading ? 'true' : 'false');
            }

            function getCurrentFilters() {
                const elements = getElements();
                return {
                    programa: (elements.programFilter?.value || '').trim(),
                    ano: (elements.yearFilter?.value || '').trim(),
                    mes: (elements.monthFilter?.value || '').trim(),
                    especialidade: (elements.specialtyFilter?.value || '').trim(),
                    situacao: (elements.situationFilter?.value || '').trim(),
                    search: (elements.searchInput?.value || '').trim()
                };
            }

            function renderActiveFilters(filters = state.filters) {
                const { activeFilters } = getElements();
                if (!activeFilters) {
                    return;
                }

                activeFilters.innerHTML = '';
                const entries = Object.keys(FILTER_LABELS).map(key => ({
                    key,
                    label: FILTER_LABELS[key],
                    value: (filters && filters[key]) || ''
                })).filter(entry => entry.value);

                if (entries.length === 0) {
                    const span = document.createElement('span');
                    span.className = 'filter-chip is-empty';
                    span.textContent = 'Nenhum filtro ativo';
                    activeFilters.appendChild(span);
                    return;
                }

                entries.forEach(entry => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'filter-chip';
                    button.setAttribute('data-filter-key', entry.key);
                    button.innerHTML = `<i class="fas fa-times"></i><span>${entry.label}: ${entry.value}</span>`;
                    activeFilters.appendChild(button);
                });

                const clearButton = document.createElement('button');
                clearButton.type = 'button';
                clearButton.className = 'filter-chip';
                clearButton.setAttribute('data-action', 'clear-all');
                clearButton.innerHTML = '<i class="fas fa-broom"></i><span>Limpar filtros</span>';
                activeFilters.appendChild(clearButton);
            }

            function handleActiveFiltersClick(event) {
                const target = event.target.closest('.filter-chip');
                if (!target || target.classList.contains('is-empty')) {
                    return;
                }

                const action = target.getAttribute('data-action');
                const elements = getElements();

                if (action === 'clear-all') {
                    Object.entries(FILTER_CONTROL_MAP).forEach(([key, controlName]) => {
                        const control = elements[controlName];
                        if (control) {
                            control.value = '';
                        }
                    });
                    const clearedFilters = { ...DEFAULT_FILTERS };
                    state.filters = { ...clearedFilters };
                    renderActiveFilters(clearedFilters);
                    applyFilters(clearedFilters);
                    return;
                }

                const filterKey = target.getAttribute('data-filter-key');
                if (!filterKey || !Object.prototype.hasOwnProperty.call(FILTER_CONTROL_MAP, filterKey)) {
                    return;
                }

                const controlName = FILTER_CONTROL_MAP[filterKey];
                const control = elements[controlName];
                if (control) {
                    control.value = '';
                }

                const nextFilters = { ...state.filters, [filterKey]: '' };
                renderActiveFilters(nextFilters);
                applyFilters(nextFilters);
            }

            function handleQuickNavClick(event) {
                const button = event.target.closest('.quick-nav-btn');
                if (!button) {
                    return;
                }

                const targetSelector = button.getAttribute('data-scroll-target');
                if (targetSelector) {
                    event.preventDefault();
                    document.querySelectorAll('#cirurgicoDashboard .quick-nav-btn.is-active').forEach(btn => btn.classList.remove('is-active'));
                    button.classList.add('is-active');
                    const section = document.querySelector(targetSelector);
                    if (section) {
                        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            }

            function updateSelectOptions(selectElement, options = [], placeholder = 'Todas as opções') {
                if (!selectElement) {
                    return;
                }

                const currentValue = selectElement.value;
                selectElement.innerHTML = '';
                const placeholderOption = document.createElement('option');
                placeholderOption.value = '';
                placeholderOption.textContent = placeholder;
                selectElement.appendChild(placeholderOption);

                options.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    selectElement.appendChild(opt);
                });

                if (currentValue && options.includes(currentValue)) {
                    selectElement.value = currentValue;
                }
            }

            function updateFiltersUI(filters = {}) {
                const elements = getElements();
                updateSelectOptions(elements.programFilter, filters.programs, 'Todos os Programas');
                updateSelectOptions(elements.yearFilter, filters.years, 'Todos os Anos');
                updateSelectOptions(elements.monthFilter, filters.months, 'Todos os Meses');
                updateSelectOptions(elements.specialtyFilter, filters.specialties, 'Todas as Especialidades');
                updateSelectOptions(elements.situationFilter, filters.situations, 'Todas as Situações');
                renderActiveFilters(state.filters);
            }

            function initializeCharts() {
                const elements = getElements();
                const palette = getPalette();

                if (elements.specialtyChart && !state.charts.specialty) {
                    state.charts.specialty = new Chart(elements.specialtyChart.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: [],
                            datasets: [{
                                data: [],
                                backgroundColor: palette,
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom' } }
                        }
                    });
                }

                if (elements.monthlyChart && !state.charts.monthly) {
                    state.charts.monthly = new Chart(elements.monthlyChart.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Cirurgias',
                                data: [],
                                borderWidth: 3,
                                fill: false,
                                tension: 0.35,
                                borderColor: readThemeVariable('--primary', '#4FD69B'),
                                backgroundColor: readThemeVariable('--primary-light', 'rgba(79, 214, 155, 0.2)')
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                }

                if (elements.statusChart && !state.charts.status) {
                    state.charts.status = new Chart(elements.statusChart.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Agendamentos',
                                data: [],
                                backgroundColor: palette
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                }
            }

            function refreshChartsTheme() {
                const palette = getPalette();
                const { specialty, monthly, status } = state.charts;

                if (specialty) {
                    specialty.data.datasets[0].backgroundColor = palette;
                    specialty.update('none');
                }

                if (monthly) {
                    monthly.data.datasets[0].borderColor = readThemeVariable('--primary', '#4FD69B');
                    monthly.data.datasets[0].backgroundColor = readThemeVariable('--primary-light', 'rgba(79, 214, 155, 0.2)');
                    monthly.update('none');
                }

                if (status) {
                    status.data.datasets[0].backgroundColor = palette;
                    status.update('none');
                }
            }

            function formatNumber(value) {
                const numeric = Number(value);
                return Number.isFinite(numeric) ? numeric.toLocaleString('pt-BR') : '0';
            }

            function formatPercent(value) {
                const numeric = Number(value);
                return Number.isFinite(numeric) ? `${numeric.toFixed(1)}%` : '0%';
            }

            function updateKPIs(metrics = {}) {
                const elements = getElements();
                if (elements.surgeriesCount) {
                    elements.surgeriesCount.textContent = formatNumber(metrics.surgeriesCount || 0);
                }
                if (elements.pendingCount) {
                    elements.pendingCount.textContent = formatNumber(metrics.pendingCount || 0);
                }
                if (elements.federalCount) {
                    elements.federalCount.textContent = formatNumber(metrics.federalCount || 0);
                }
                if (elements.stateCount) {
                    elements.stateCount.textContent = formatNumber(metrics.stateCount || 0);
                }
                if (elements.confirmationRate) {
                    elements.confirmationRate.textContent = formatPercent(metrics.confirmationRate || 0);
                }
                if (elements.avgWaitTime) {
                    const numeric = Number(metrics.avgWaitTime || 0);
                    elements.avgWaitTime.textContent = Number.isFinite(numeric) ? `${numeric.toFixed(0)}d` : '0d';
                }
                if (elements.tableCount) {
                    elements.tableCount.textContent = `${formatNumber(metrics.totalRecords || 0)} registros`;
                }
            }

            function buildStatusClass(status) {
                const normalized = (status || '').toString().toUpperCase();
                if (normalized === 'REALIZADA' || normalized === 'CONFIRMADA') {
                    return 'trend-up';
                }
                if (normalized === 'PENDENTE' || normalized === 'AGENDADA') {
                    return 'trend-down';
                }
                return '';
            }

            function updateTable(rows = []) {
                const elements = getElements();
                if (!elements.tableBody) {
                    return;
                }

                elements.tableBody.innerHTML = '';
                const limitedRows = rows.slice(0, 50);

                if (!limitedRows.length) {
                    const emptyRow = document.createElement('tr');
                    emptyRow.className = 'empty-row';
                    emptyRow.innerHTML = '<td colspan="3">Nenhum dado disponível</td>';
                    elements.tableBody.appendChild(emptyRow);
                    return;
                }

                limitedRows.forEach(item => {
                    const row = document.createElement('tr');

                    const patientCell = document.createElement('td');
                    patientCell.innerHTML = `
                        <div><strong>${item.NOME || 'Paciente não informado'}</strong></div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">${item.PROCEDIMENTO || 'Procedimento não informado'}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">${item.ESPECIALIDADE || ''}</div>
                    `;

                    const dateCell = document.createElement('td');
                    dateCell.style.textAlign = 'right';
                    dateCell.innerHTML = `
                        <div>${item.DATA_DA_CIRURGIA || '--'}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">${item.ANO || ''}</div>
                    `;

                    const statusCell = document.createElement('td');
                    statusCell.style.textAlign = 'right';
                    statusCell.innerHTML = `
                        <div class="${buildStatusClass(item.STATUS_DO_AGENDAMENTO)}">${item.STATUS_DO_AGENDAMENTO || 'Status não informado'}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">${item.SITUAÇÃO_FASTMEDIC || ''}</div>
                    `;

                    row.append(patientCell, dateCell, statusCell);
                    elements.tableBody.appendChild(row);
                });

                if (rows.length > limitedRows.length) {
                    const infoRow = document.createElement('tr');
                    infoRow.className = 'empty-row';
                    infoRow.innerHTML = `<td colspan="3">Mostrando ${limitedRows.length} de ${formatNumber(rows.length)} registros.</td>`;
                    elements.tableBody.appendChild(infoRow);
                }
            }

            function updateInsights(insights = []) {
                const elements = getElements();
                if (!elements.insightsList) {
                    return;
                }

                elements.insightsList.innerHTML = '';

                if (!insights.length) {
                    const li = document.createElement('li');
                    li.className = 'insight-item';
                    li.innerHTML = '<i class="fas fa-info-circle" style="color: var(--primary);"></i><span>Nenhum insight disponível no momento.</span>';
                    elements.insightsList.appendChild(li);
                    return;
                }

                insights.forEach(insight => {
                    const li = document.createElement('li');
                    li.className = 'insight-item';
                    const icon = insight.icon || 'fas fa-lightbulb';
                    li.innerHTML = `<i class="${icon}" style="color: var(--primary);"></i><span>${insight.text || ''}</span>`;
                    elements.insightsList.appendChild(li);
                });
            }

            function updateCharts(charts = {}) {
                initializeCharts();
                if (state.charts.specialty && charts.specialty) {
                    state.charts.specialty.data.labels = charts.specialty.labels || [];
                    state.charts.specialty.data.datasets[0].data = charts.specialty.data || [];
                    state.charts.specialty.update('none');
                }

                if (state.charts.monthly && charts.monthly) {
                    state.charts.monthly.data.labels = charts.monthly.labels || [];
                    state.charts.monthly.data.datasets[0].data = charts.monthly.data || [];
                    state.charts.monthly.update('none');
                }

                if (state.charts.status && charts.status) {
                    state.charts.status.data.labels = charts.status.labels || [];
                    state.charts.status.data.datasets[0].data = charts.status.data || [];
                    state.charts.status.update('none');
                }
            }

            function normalizeText(value) {
                return (value || '').toString().trim().toLowerCase();
            }

            function applyLocalFilters(data, filters) {
                return data.filter(item => {
                    if (filters.programa && normalizeText(item.PROGRAMA) !== normalizeText(filters.programa)) {
                        return false;
                    }
                    if (filters.ano && normalizeText(item.ANO) !== normalizeText(filters.ano)) {
                        return false;
                    }
                    if (filters.mes && normalizeText(item.MÊS || item.MES) !== normalizeText(filters.mes)) {
                        return false;
                    }
                    if (filters.especialidade && normalizeText(item.ESPECIALIDADE) !== normalizeText(filters.especialidade)) {
                        return false;
                    }
                    if (filters.situacao && normalizeText(item.SITUAÇÃO_FASTMEDIC || item.SITUACAO_FASTMEDIC) !== normalizeText(filters.situacao)) {
                        return false;
                    }
                    if (filters.search) {
                        const search = normalizeText(filters.search);
                        const matches = [
                            item.PRONTUÁRIO,
                            item.NOME,
                            item.MUNICÍPIO,
                            item.PROCEDIMENTO
                        ].some(field => normalizeText(field).includes(search));
                        if (!matches) {
                            return false;
                        }
                    }
                    return true;
                });
            }

            function computeMetrics(data) {
                const metrics = {
                    surgeriesCount: 0,
                    pendingCount: 0,
                    federalCount: 0,
                    stateCount: 0,
                    confirmationRate: 0,
                    avgWaitTime: 0,
                    totalRecords: data.length
                };

                let confirmed = 0;
                let waitSum = 0;
                let waitCount = 0;

                data.forEach(item => {
                    if (item.DATA_DA_CIRURGIA) {
                        metrics.surgeriesCount += 1;
                    }

                    const status = normalizeText(item.STATUS_DO_AGENDAMENTO);
                    if (status === 'pendente' || status === 'agendada') {
                        metrics.pendingCount += 1;
                    }

                    const programa = normalizeText(item.PROGRAMA);
                    if (programa === 'federal') {
                        metrics.federalCount += 1;
                    }
                    if (programa === 'estadual') {
                        metrics.stateCount += 1;
                    }

                    const confirmacao = normalizeText(item.CONFIRMAÇÃO_DA_INTERNAÇÃO || item.CONFIRMACAO_DA_INTERNAÇÃO || item.CONFIRMACAO_DA_INTERNACAO);
                    if (confirmacao === 'confirmada') {
                        confirmed += 1;
                    }

                    const tempoEspera = Number(item.TEMPO_DE_ESPERA);
                    if (Number.isFinite(tempoEspera) && tempoEspera > 0) {
                        waitSum += tempoEspera;
                        waitCount += 1;
                    }
                });

                metrics.confirmationRate = metrics.totalRecords > 0 ? (confirmed / metrics.totalRecords) * 100 : 0;
                metrics.avgWaitTime = waitCount > 0 ? waitSum / waitCount : 0;

                return metrics;
            }

            function computeCharts(data) {
                const specialty = new Map();
                const monthly = new Map();
                const status = new Map();

                data.forEach(item => {
                    const esp = item.ESPECIALIDADE || 'Não informado';
                    specialty.set(esp, (specialty.get(esp) || 0) + 1);

                    const mes = item.MÊS || item.MES || '';
                    const ano = item.ANO || '';
                    if (mes || ano) {
                        const label = `${mes} ${ano}`.trim();
                        monthly.set(label, (monthly.get(label) || 0) + 1);
                    }

                    const st = item.STATUS_DO_AGENDAMENTO || 'Não informado';
                    status.set(st, (status.get(st) || 0) + 1);
                });

                const monthlyLabels = Array.from(monthly.keys()).sort((a, b) => a.localeCompare(b));

                return {
                    specialty: {
                        labels: Array.from(specialty.keys()),
                        data: Array.from(specialty.values())
                    },
                    monthly: {
                        labels: monthlyLabels,
                        data: monthlyLabels.map(label => monthly.get(label))
                    },
                    status: {
                        labels: Array.from(status.keys()),
                        data: Array.from(status.values())
                    }
                };
            }

            function computeInsights(data) {
                if (!data.length) {
                    return [];
                }

                const metrics = computeMetrics(data);
                const federal = data.filter(item => normalizeText(item.PROGRAMA) === 'federal').length;
                const estadual = data.filter(item => normalizeText(item.PROGRAMA) === 'estadual').length;

                return [
                    { icon: 'fas fa-procedures', text: `${formatNumber(metrics.surgeriesCount)} cirurgias realizadas no período.` },
                    { icon: 'fas fa-clock', text: `${formatNumber(metrics.pendingCount)} agendamentos pendentes.` },
                    { icon: 'fas fa-chart-pie', text: `${formatNumber(federal)} pacientes federais e ${formatNumber(estadual)} estaduais.` }
                ];
            }

            function updateFromSnapshot(snapshot) {
                if (!snapshot) {
                    return;
                }

                const normalizedRows = mapToNormalized(snapshot.rows);
                state.filteredData = normalizedRows;
                updateKPIs(snapshot.metrics || {});
                updateCharts(snapshot.charts || {});
                updateTable(normalizedRows);
                updateInsights(snapshot.insights || []);
                setLastUpdate(snapshot.lastUpdated);
                state.lastUpdated = snapshot.lastUpdated || new Date().toISOString();
                const totalRecords = snapshot.metrics?.totalRecords ?? normalizedRows.length;
                setPerformanceMessage(`${formatNumber(totalRecords)} registros analisados`);
            }

            function buildLocalSnapshot(filters = {}) {
                const baseSource = state.allData.length ? state.allData : mapToNormalized(fallbackData.rows);
                const filtered = applyLocalFilters(baseSource, filters);
                const normalizedFiltered = mapToNormalized(filtered);
                return {
                    rows: normalizedFiltered,
                    metrics: computeMetrics(normalizedFiltered),
                    charts: computeCharts(normalizedFiltered),
                    insights: computeInsights(normalizedFiltered),
                    lastUpdated: new Date().toISOString()
                };
            }

            function runAppsScript(methodName, ...args) {
                if (!hasAppsScript || !google.script || !google.script.run || typeof google.script.run[methodName] !== 'function') {
                    return Promise.reject(new Error('Apps Script não disponível'));
                }

                try {
                    const payloadPreview = args.map(arg => {
                        if (arg && typeof arg === 'object') {
                            const clone = { ...arg };
                            if (clone.search) { clone.search = String(clone.search); }
                            return clone;
                        }
                        return arg;
                    });
                    console.info('[CirurgicoDashboard] Executando Apps Script:', methodName, payloadPreview);
                } catch (logError) {
                    console.warn('[CirurgicoDashboard] Falha ao registrar log da chamada Apps Script:', logError);
                }

                return new Promise((resolve, reject) => {
                    let settled = false;
                    const timer = setTimeout(() => {
                        if (settled) {
                            return;
                        }
                        settled = true;
                        console.error(`[CirurgicoDashboard] Tempo limite excedido na chamada ${methodName}.`);
                        reject(new Error('Tempo limite excedido ao buscar dados cirúrgicos.'));
                    }, APPS_SCRIPT_TIMEOUT_MS);

                    google.script.run
                        .withSuccessHandler(response => {
                            if (settled) {
                                return;
                            }
                            settled = true;
                            clearTimeout(timer);

                            if (response && response.success === false) {
                                const message = response && response.error ? response.error : 'Resposta inválida do servidor';
                                reject(new Error(message));
                                return;
                            }

                            resolve(response);
                        })
                        .withFailureHandler(error => {
                            if (settled) {
                                return;
                            }
                            settled = true;
                            clearTimeout(timer);
                            reject(error);
                        })[methodName](...args);
                });
            }

            function loadFilterOptions() {
                if (!hasAppsScript) {
                    updateFiltersUI(fallbackData.filters);
                    return Promise.resolve();
                }

                return runAppsScript('getCirurgicoFilterOptions').then(response => {
                    updateFiltersUI(response.filters || {});
                });
            }

            function loadBaseData() {
                if (!hasAppsScript) {
                    state.allData = mapToNormalized(fallbackData.rows);
                    state.filteredData = state.allData.slice();
                    setPerformanceMessage('Modo demonstração ativo');
                    return Promise.resolve({ lastUpdated: new Date().toISOString() });
                }

                return runAppsScript('getCirurgicoDataFromSheet').then(response => {
                    const rows = response && Array.isArray(response.data) ? response.data : [];
                    const normalizedData = mapToNormalized(rows);
                    state.allData = normalizedData;
                    state.filteredData = normalizedData.slice();
                    return { ...(response || {}), data: normalizedData };
                });
            }

            function applyFilters(filters = state.filters) {
                state.filters = { ...DEFAULT_FILTERS, ...filters, dataset: 'cirurgico' };
                renderActiveFilters(state.filters);

                if (!hasAppsScript) {
                    toggleLoadingState(true);
                    const snapshot = buildLocalSnapshot(state.filters);
                    updateFromSnapshot(snapshot);
                    toggleLoadingState(false);
                    return Promise.resolve();
                }

                toggleLoadingState(true);

                return Promise.all([
                    runAppsScript('getCirurgicoFilteredData', state.filters),
                    runAppsScript('getCirurgicoKPIMetrics', state.filters),
                    runAppsScript('getCirurgicoChartData', state.filters)
                ])
                    .then(([dataResponse, kpiResponse, chartResponse]) => {
                        const snapshot = {
                            rows: mapToNormalized(dataResponse && dataResponse.data),
                            metrics: (kpiResponse && kpiResponse.metrics) || {},
                            charts: (chartResponse && chartResponse.charts) || {},
                            insights: (chartResponse && chartResponse.insights) || [],
                            lastUpdated: (dataResponse && dataResponse.lastUpdated) || new Date().toISOString()
                        };
                        updateFromSnapshot(snapshot);
                    })
                    .catch(error => {
                        console.error('Erro ao aplicar filtros cirúrgicos:', error);
                        if (typeof showNotification === 'function') { showNotification('Não foi possível carregar os dados filtrados.', 'error'); } else { console.error('Não foi possível carregar os dados filtrados.'); }
                        if (error && typeof error === 'object') {
                            error.__cirurgicoNotified = true;
                        }
                        throw error;
                    })
                    .finally(() => {
                        toggleLoadingState(false);
                    });
            }

            function loadInitialData(options = {}) {
                const { forceReload } = options;
                toggleLoadingState(true);
                showGlobalLoading(true);
                setPerformanceMessage('Carregando dados cirúrgicos atualizados...');

                const filtersPromise = (!state.initialized || forceReload) ? loadFilterOptions() : Promise.resolve();

                return filtersPromise
                    .then(() => loadBaseData())
                    .then(response => {
                        setLastUpdate(response?.lastUpdated);
                        state.lastUpdated = response?.lastUpdated || new Date().toISOString();
                        return applyFilters({ ...DEFAULT_FILTERS });
                    })
                    .then(() => {
                        state.initialized = true;
                    })
                    .catch(error => {
                        state.initialized = false;
                        console.error('Erro ao carregar o BI cirúrgico:', error);
                        if (typeof showNotification === 'function' && !(error && error.__cirurgicoNotified)) {
                            showNotification('Não foi possível carregar o BI Cirúrgico.', 'error');
                        }
                        throw error;
                    })
                    .finally(() => {
                        showGlobalLoading(false);
                        toggleLoadingState(false);
                    });
            }

            function exportData() {
                if (!hasAppsScript) {
                    if (typeof showNotification === 'function') { showNotification('Exportação disponível apenas na versão publicada.', 'info'); } else { console.info('Exportação disponível apenas na versão publicada.'); }
                    return;
                }

                runAppsScript('exportCirurgicoData', state.filters)
                    .then(response => {
                        if (typeof showNotification === 'function') { showNotification(response.message || 'Exportação iniciada com sucesso.', 'success'); }
                    })
                    .catch(error => {
                        console.error('Erro ao exportar dados cirúrgicos:', error);
                        if (typeof showNotification === 'function') { showNotification('Erro ao exportar os dados cirúrgicos.', 'error'); }
                    });
            }

            function toggleChartExpand(event) {
                const button = event.currentTarget;
                const container = button.closest('.chart-container');
                const overlay = document.getElementById('chartOverlay');
                const isExpanded = button.getAttribute('aria-expanded') === 'true';

                if (!container || !overlay) {
                    return;
                }

                document.querySelectorAll('.chart-container.is-expanded').forEach(el => {
                    el.classList.remove('is-expanded');
                });
                document.querySelectorAll('.chart-expand-btn[aria-expanded="true"]').forEach(btn => {
                    btn.setAttribute('aria-expanded', 'false');
                });

                if (!isExpanded) {
                    container.classList.add('is-expanded');
                    button.setAttribute('aria-expanded', 'true');
                    overlay.classList.add('is-active');
                    document.body.classList.add('chart-expanded');
                } else {
                    overlay.classList.remove('is-active');
                    document.body.classList.remove('chart-expanded');
                }

                Object.values(state.charts).forEach(chart => chart && chart.resize());
            }

            function closeExpandedCharts() {
                document.querySelectorAll('.chart-container.is-expanded').forEach(el => el.classList.remove('is-expanded'));
                document.querySelectorAll('.chart-expand-btn[aria-expanded="true"]').forEach(btn => btn.setAttribute('aria-expanded', 'false'));
                const overlay = document.getElementById('chartOverlay');
                if (overlay) {
                    overlay.classList.remove('is-active');
                }
                document.body.classList.remove('chart-expanded');
                Object.values(state.charts).forEach(chart => chart && chart.resize());
            }

            const handleSearchInput = debounce(() => {
                applyFilters({ ...getCurrentFilters() });
            }, 300);

            function bindEvents() {
                if (state.listenersBound) {
                    return;
                }

                const elements = getElements();
                const overlay = document.getElementById('chartOverlay');

                if (elements.refreshBtn) {
                    elements.refreshBtn.addEventListener('click', () => loadInitialData({ forceReload: true }));
                }

                if (elements.exportBtn) {
                    elements.exportBtn.addEventListener('click', exportData);
                }

                if (elements.searchInput) {
                    elements.searchInput.addEventListener('input', handleSearchInput);
                }

                ['programFilter', 'yearFilter', 'monthFilter', 'specialtyFilter', 'situationFilter'].forEach(key => {
                    const control = elements[key];
                    if (control) {
                        control.addEventListener('change', () => {
                            applyFilters({ ...getCurrentFilters() });
                        });
                    }
                });

                if (elements.activeFilters) {
                    elements.activeFilters.addEventListener('click', handleActiveFiltersClick);
                }

                if (elements.quickNav) {
                    elements.quickNav.addEventListener('click', handleQuickNavClick);
                }

                document.querySelectorAll('#cirurgicoDashboard .chart-expand-btn').forEach(btn => {
                    btn.addEventListener('click', toggleChartExpand);
                });

                if (overlay) {
                    overlay.addEventListener('click', closeExpandedCharts);
                }

                state.listenersBound = true;
            }

            function activate(options = {}) {
                const elements = getElements();
                if (!elements.container) {
                    return Promise.reject(new Error('Contêiner do BI cirúrgico não encontrado.'));
                }

                state.isActive = true;
                if (elements.quickNav) {
                    elements.quickNav.querySelectorAll('.quick-nav-btn').forEach(btn => btn.classList.remove('is-active'));
                }
                initializeCharts();
                bindEvents();

                const shouldReload = !state.initialized || options.forceReload || options.initialLoad;
                const activationPromise = shouldReload
                    ? loadInitialData({ forceReload: options.forceReload })
                    : applyFilters(state.filters);

                return Promise.resolve(activationPromise).catch(error => {
                    state.isActive = false;
                    throw error;
                });
            }

            function deactivate() {
                state.isActive = false;
            }

            return {
                activate,
                deactivate,
                refreshChartsTheme,
                refresh() {
                    return loadInitialData({ forceReload: true });
                }
            };
        })();
        const ABSENTEEISM_ALERT_THRESHOLD = 8;
        const DATASET_DEFINITIONS = Object.freeze({
            ambulatorial: {
                id: 'ambulatorial',
                label: 'BI Ambulatorial',
                shortLabel: 'Ambulatorial',
                description: 'Núcleo de Atendimento ao Cliente',
                icon: 'fas fa-stethoscope'
            },
            cirurgico: {
                id: 'cirurgico',
                label: 'BI Cirúrgico',
                shortLabel: 'Cirúrgico',
                description: 'Indicadores do Centro Cirúrgico',
                icon: 'fas fa-notes-medical'
            }
        });
        const DATASET_STORAGE_KEY = 'nac-huc-active-dataset';
        let activeDataset = 'ambulatorial';
        let structuredCloneWarningShown = false;
        let fallbackCloneErrorShown = false;
        let ambulatorialInitialized = false;
        let ambulatorialListenersBound = false;

        function cloneData(value) {
            if (typeof structuredClone === 'function') {
                try {
                    return structuredClone(value);
                } catch (error) {
                    if (!structuredCloneWarningShown) {
                        console.warn('structuredClone não suportado para o valor informado, aplicando fallback JSON.', error);
                        structuredCloneWarningShown = true;
                    }
                }
            }

            try {
                return JSON.parse(JSON.stringify(value));
            } catch (error) {
                if (!fallbackCloneErrorShown) {
                    console.error('Não foi possível clonar o fallback dataset. Retornando referência direta.', error);
                    fallbackCloneErrorShown = true;
                }
                return value;
            }
        }
        function normalizeDatasetId(datasetId) {
            if (!datasetId) {
                return 'ambulatorial';
            }

            const normalized = datasetId.toString().trim().toLowerCase();
            return Object.prototype.hasOwnProperty.call(DATASET_DEFINITIONS, normalized)
                ? normalized
                : 'ambulatorial';
        }

        function getDatasetDefinition(datasetId = activeDataset) {
            const normalized = normalizeDatasetId(datasetId);
            return DATASET_DEFINITIONS[normalized];
        }

        function getFallbackDataset(datasetId = activeDataset) {
            const normalized = normalizeDatasetId(datasetId);
            const dataset = FALLBACK_DATASETS[normalized] || FALLBACK_DATASETS.ambulatorial;
            return cloneData(dataset);
        }

        function buildInitialFilters(datasetId = activeDataset) {
            return {
                especialidade: '',
                situacao: '',
                tipoConsulta: '',
                ano: '',
                mes: '',
                periodType: 'mensal',
                periodValues: [],
                search: '',
                dataset: normalizeDatasetId(datasetId)
            };
        }

        function getStoredDatasetId() {
            try {
                return localStorage.getItem(DATASET_STORAGE_KEY);
            } catch (error) {
                console.warn('Não foi possível ler o BI salvo:', error);
                return null;
            }
        }

        function persistDatasetId(datasetId) {
            try {
                localStorage.setItem(DATASET_STORAGE_KEY, datasetId);
            } catch (error) {
                console.warn('Não foi possível salvar o BI selecionado:', error);
            }
        }

        let activeFilters = buildInitialFilters(activeDataset);

        function readThemeVariable(variableName, fallback = '') {
            const root = document.body || document.documentElement;
            if (!root || typeof getComputedStyle !== 'function') {
                return fallback;
            }

            const value = getComputedStyle(root).getPropertyValue(variableName);
            return value ? value.trim() || fallback : fallback;
        }

        function getChartThemeColors() {
            return {
                axis: readThemeVariable('--chart-axis-color', '#3F4C5B'),
                grid: readThemeVariable('--chart-grid-color', 'rgba(99, 112, 126, 0.18)'),
                legend: readThemeVariable('--chart-legend-color', '#384452'),
                label: readThemeVariable('--chart-label-color', '#1F2933'),
                tooltipBg: readThemeVariable('--chart-tooltip-bg', '#FFFFFF'),
                tooltipColor: readThemeVariable('--chart-tooltip-color', '#1F2933'),
                tooltipBorder: readThemeVariable('--chart-tooltip-border', 'rgba(148, 163, 184, 0.35)')
            };
        }

        function getTooltipThemeOptions(overrides = {}) {
            const theme = getChartThemeColors();
            return {
                backgroundColor: theme.tooltipBg,
                titleColor: theme.legend,
                bodyColor: theme.tooltipColor,
                borderColor: theme.tooltipBorder,
                borderWidth: 1,
                padding: 12,
                displayColors: true,
                ...overrides
            };
        }

        const ThemeManager = (() => {
            const STORAGE_KEY = 'nac-huc-theme';
            const DEFAULT_THEME = 'ambulatorial';

            function getToggleButton() {
                return document.getElementById('themeToggleBtn');
            }

            function updateToggleLabel(theme) {
                const button = getToggleButton();
                if (!button) return;

                const icon = button.querySelector('i');
                const label = button.querySelector('.btn-label');
                const isPlantao = theme === 'plantao';

                button.setAttribute('aria-pressed', String(isPlantao));
                button.title = isPlantao
                    ? 'Alternar para modo ambulatorial'
                    : 'Alternar para modo plantão';

                if (icon) {
                    icon.classList.remove('fa-moon', 'fa-sun');
                    icon.classList.add(isPlantao ? 'fa-sun' : 'fa-moon');
                }

                if (label) {
                    label.textContent = isPlantao ? 'Modo Ambulatorial' : 'Modo Plantão';
                }
            }

            function readStoredTheme() {
                try {
                    return localStorage.getItem(STORAGE_KEY);
                } catch (error) {
                    console.warn('Não foi possível ler o tema salvo:', error);
                    return null;
                }
            }

            function persistTheme(theme) {
                try {
                    localStorage.setItem(STORAGE_KEY, theme);
                } catch (error) {
                    console.warn('Não foi possível salvar o tema:', error);
                }
            }

            function applyTheme(theme) {
                const normalized = theme === 'plantao' ? 'plantao' : DEFAULT_THEME;
                document.body.dataset.theme = normalized;
                updateToggleLabel(normalized);
                if (typeof refreshAllChartsTheme === 'function') {
                    requestAnimationFrame(() => refreshAllChartsTheme());
                }
                return normalized;
            }

            return {
                initialize() {
                    const stored = readStoredTheme();
                    applyTheme(stored);
                },
                toggle() {
                    const nextTheme = document.body.dataset.theme === 'plantao' ? 'ambulatorial' : 'plantao';
                    applyTheme(nextTheme);
                    persistTheme(nextTheme);
                },
                syncToggle() {
                    updateToggleLabel(document.body.dataset.theme || DEFAULT_THEME);
                }
            };
        })();
        const DOMRefs = {
            datasetBadge: document.getElementById('datasetBadge'),
            datasetSubtitle: document.getElementById('datasetSubtitle'),
            totalConsultas: document.getElementById('totalConsultas'),
            totalAgendamentos: document.getElementById('totalAgendamentos'),
            percentualAbsenteismo: document.getElementById('percentualAbsenteismo'),
            pacientesSegmento: document.getElementById('pacientesSegmento'),
            absenteismoCard: document.querySelector('[data-kpi-card="absenteismo"]'),
            settingsBtn: document.getElementById('settingsBtn'),
            performanceInfo: document.getElementById('performanceInfo'),
            chartOverlay: document.getElementById('chartOverlay')
        };
        const KPI_VALUE_ELEMENTS = Array.from(document.querySelectorAll('.kpi-value'));
        const chartCanvasMap = Object.freeze({
            especialidadeChart: 'especialidade',
            evolucaoChart: 'evolucao',
            tipoConsultaChart: 'tipoConsulta',
            faixaEtariaChart: 'faixaEtaria',
            generoChart: 'genero',
            desfechoChart: 'desfecho'
        });
        function restoreDatasetSelection() {
            const stored = getStoredDatasetId();
            activeDataset = stored ? normalizeDatasetId(stored) : normalizeDatasetId(activeDataset);
            document.body.dataset.dataset = activeDataset;
            activeFilters = buildInitialFilters(activeDataset);
        }

        function updateDatasetVisuals() {
            const definition = getDatasetDefinition(activeDataset);
            document.body.dataset.dataset = definition.id;

            if (DOMRefs.datasetBadge) {
                DOMRefs.datasetBadge.innerHTML = `<i class="${definition.icon}"></i> ${definition.label}`;
            }

            if (DOMRefs.datasetSubtitle) {
                DOMRefs.datasetSubtitle.textContent = definition.description;
            }

            document.querySelectorAll('.dashboard-view').forEach(view => {
                const isActive = view.dataset.view === definition.id;
                view.setAttribute('aria-hidden', isActive ? 'false' : 'true');
            });

            updateDatasetMenuState();
        }

        function updateDatasetMenuState() {
            document.querySelectorAll('[data-dataset-target]').forEach(button => {
                const target = normalizeDatasetId(button.getAttribute('data-dataset-target'));
                const isActive = target === activeDataset;
                button.classList.toggle('is-active', isActive);
                button.setAttribute('aria-current', isActive ? 'page' : 'false');
            });
        }

        function handleDatasetButtonClick(event) {
            const button = event?.currentTarget;
            if (!button) {
                return;
            }

            const target = button.getAttribute('data-dataset-target');
            if (!target) {
                console.error('Botão de BI sem destino configurado.');
                showError('Opção de BI indisponível.');
                return;
            }

            switchDataset(target).catch(error => {
                console.error('Falha ao alternar o BI:', error);
            });
        }

        function setupDatasetMenu() {
            const buttons = Array.from(document.querySelectorAll('[data-dataset-target]'));

            if (!buttons.length) {
                console.error('Nenhum seletor de BI foi encontrado na barra lateral.');
                showError('Não foi possível carregar o seletor de dashboards. Recarregue a página.');
                return;
            }

            buttons.forEach(button => {
                if (button.dataset.datasetListenerBound === 'true') {
                    return;
                }

                button.addEventListener('click', handleDatasetButtonClick);
                button.dataset.datasetListenerBound = 'true';
            });

            updateDatasetMenuState();
        }

        function resetAllCharts() {
            Object.keys(charts).forEach(key => {
                const instance = charts[key];
                if (instance && typeof instance.destroy === 'function') {
                    instance.destroy();
                }
            });
            charts = createEmptyChartRegistry();
        }

        function resetDashboardState() {
            kpiData = {...emptyKpis};
            chartData = null;
            consultasEspecialidade = [];
            updateKPIs();
            updateConsultasEspecialidade();
            resetAllCharts();
            const datasetDefinition = getDatasetDefinition(activeDataset);
            updatePerformanceInfo(`Carregando indicadores do ${datasetDefinition.label}...`);
        }

        function resetFilterControls() {
            ['especialidadeFilter', 'situacaoFilter', 'tipoConsultaFilter', 'anoFilter', 'mesFilter'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = '';
                }
            });

            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
            }

            const periodTypeSelect = document.getElementById('periodTypeFilter');
            if (periodTypeSelect) {
                periodTypeSelect.value = 'mensal';
            }

            currentPeriodOptions = [];
            setPeriodRangeSelections([], false);
            updatePeriodRangeSummary([]);
            updatePeriodRangeBadges([]);
            updateSelectAllState([]);
            updatePeriodControlsState();
        }

        async function switchDataset(nextDataset, options = {}) {
            const normalized = normalizeDatasetId(nextDataset);
            const forceReload = options.force === true;

            if (!forceReload && normalized === activeDataset) {
                return;
            }

            const previousDataset = activeDataset;
            const previousFilters = cloneData(activeFilters);

            try {
                activeDataset = normalized;
                persistDatasetId(activeDataset);
                updateDatasetVisuals();
                requestCache.clear();

                if (normalized === 'cirurgico') {
                    await Promise.resolve(
                        CirurgicoDashboard.activate({
                            forceReload,
                            initialLoad: options.initialLoad === true
                        })
                    );
                    return;
                }

                CirurgicoDashboard.deactivate();
                activeFilters = buildInitialFilters(activeDataset);
                resetDashboardState();
                resetFilterControls();

                if (!ambulatorialListenersBound) {
                    setupEventListeners();
                }

                if (!hasAppsScript) {
                    const datasetDefinition = getDatasetDefinition(activeDataset);
                    updatePerformanceInfo(`Modo demonstração ativo para ${datasetDefinition.label}.`);
                    await loadDashboardData(activeFilters, 1);
                    ambulatorialInitialized = true;
                    return;
                }

                const shouldReloadFilters = forceReload || !ambulatorialInitialized;

                if (shouldReloadFilters) {
                    updatePerformanceInfo('Carregando filtros atualizados...');
                    await loadFilterOptions();
                    updatePeriodRangeOptions({ preserveSelection: false });
                    updatePeriodControlsState();
                } else {
                    updatePeriodRangeOptions({ preserveSelection: false });
                    updatePeriodControlsState();
                }

                await loadDashboardData(activeFilters, 1);
                ambulatorialInitialized = true;
            } catch (error) {
                console.error('Erro ao alternar BI:', error);
                showError('Não foi possível carregar os dados do BI selecionado');
                activeDataset = previousDataset;
                activeFilters = previousFilters;
                persistDatasetId(activeDataset);
                updateDatasetVisuals();

                if (previousDataset === 'cirurgico') {
                    CirurgicoDashboard.activate().catch(restoreError => {
                        console.error('Falha ao restaurar o BI cirúrgico após erro:', restoreError);
                    });
                } else if (!ambulatorialInitialized) {
                    scheduleInitialAmbulatorialLoad({ immediate: true });
                }
            }
        }
        const dashboardHeader = document.querySelector('.dashboard-header');
        const MONTH_INFO = [
            { value: '01', label: 'Janeiro', shortLabel: 'Jan' },
            { value: '02', label: 'Fevereiro', shortLabel: 'Fev' },
            { value: '03', label: 'Março', shortLabel: 'Mar' },
            { value: '04', label: 'Abril', shortLabel: 'Abr' },
            { value: '05', label: 'Maio', shortLabel: 'Mai' },
            { value: '06', label: 'Junho', shortLabel: 'Jun' },
            { value: '07', label: 'Julho', shortLabel: 'Jul' },
            { value: '08', label: 'Agosto', shortLabel: 'Ago' },
            { value: '09', label: 'Setembro', shortLabel: 'Set' },
            { value: '10', label: 'Outubro', shortLabel: 'Out' },
            { value: '11', label: 'Novembro', shortLabel: 'Nov' },
            { value: '12', label: 'Dezembro', shortLabel: 'Dez' }
        ];
        const MONTH_INFO_BY_VALUE = MONTH_INFO.reduce((acc, info) => {
            acc[info.value] = info;
            return acc;
        }, {});
        const PERIOD_PRESETS = {
            diario: [
                { value: 'hoje', label: 'Hoje' },
                { value: 'ultimos-7-dias', label: 'Últimos 7 dias' },
                { value: 'ultimos-15-dias', label: 'Últimos 15 dias' }
            ],
            semanal: [],
            mensal: [
                { value: 'jan', label: 'Janeiro' },
                { value: 'fev', label: 'Fevereiro' },
                { value: 'mar', label: 'Março' },
                { value: 'abr', label: 'Abril' },
                { value: 'mai', label: 'Maio' },
                { value: 'jun', label: 'Junho' },
                { value: 'jul', label: 'Julho' },
                { value: 'ago', label: 'Agosto' },
                { value: 'set', label: 'Setembro' },
                { value: 'out', label: 'Outubro' },
                { value: 'nov', label: 'Novembro' },
                { value: 'dez', label: 'Dezembro' }
            ],
            bimestral: [
                { value: '1bim', label: '1º Bimestre' },
                { value: '2bim', label: '2º Bimestre' },
                { value: '3bim', label: '3º Bimestre' },
                { value: '4bim', label: '4º Bimestre' },
                { value: '5bim', label: '5º Bimestre' },
                { value: '6bim', label: '6º Bimestre' }
            ],
            trimestral: [
                { value: '1tri', label: '1º Trimestre' },
                { value: '2tri', label: '2º Trimestre' },
                { value: '3tri', label: '3º Trimestre' },
                { value: '4tri', label: '4º Trimestre' }
            ],
            semestral: [
                { value: '1sem', label: '1º Semestre' },
                { value: '2sem', label: '2º Semestre' }
            ]
        };
        const CHART_COLOR_PALETTE = ['#2563EB', '#0F766E', '#F97316', '#7C3AED', '#16A34A', '#475569', '#0EA5E9', '#C2410C'];
        const TIPO_CONSULTA_LIMIT = 5;
        const ESPECIALIDADE_DEFAULT_LIMIT = 10;
        let currentPeriodOptions = [];
        let periodMultiSelectInitialized = false;
        let filterUpdateTimeout = null;
        let pendingFilters = null;
        const FILTER_DEBOUNCE_MS = 220;
        const emptyKpis = {
            totalConsultas: 0,
            percentualAbsenteismo: 0,
            pacientesSegmento: 0,
            totalRegistros: 0,
            totalFaltas: 0,
            totalAgendamentos: 0
        };
        let kpiData = {...emptyKpis};
        let chartData = null;
        let consultasEspecialidade = [];
        function createEmptyChartRegistry() {
            return {
                especialidade: null,
                evolucao: null,
                faixaEtaria: null,
                genero: null,
                desfecho: null,
                tipoConsulta: null
            };
        }
        let charts = createEmptyChartRegistry();

        function refreshChartForCanvas(canvas) {
            if (!canvas) {
                return;
            }

            switch (canvas.id) {
                case 'especialidadeChart':
                    createEspecialidadeChart();
                    break;
                case 'evolucaoChart':
                    createEvolucaoChart();
                    break;
                case 'tipoConsultaChart':
                    createTipoConsultaChart();
                    break;
                case 'faixaEtariaChart':
                    createFaixaEtariaChart();
                    break;
                case 'generoChart':
                    createGeneroChart();
                    break;
                case 'desfechoChart':
                    createDesfechoChart();
                    break;
                default:
                    break;
            }
        }

        function applyThemeToChart(chart) {
            if (!chart) {
                return;
            }

            const theme = getChartThemeColors();
            const options = chart.options || {};

            if (options.scales && typeof options.scales === 'object') {
                Object.values(options.scales).forEach(scale => {
                    if (!scale || typeof scale !== 'object') {
                        return;
                    }

                    if (scale.ticks) {
                        scale.ticks.color = theme.axis;
                    }

                    if (scale.grid && scale.grid.display !== false) {
                        scale.grid.color = theme.grid;
                        if (scale.grid.drawBorder !== false) {
                            scale.grid.borderColor = theme.grid;
                        }
                    }
                });
            }

            if (options.plugins && typeof options.plugins === 'object') {
                const { legend, tooltip, percentageLabel } = options.plugins;

                if (legend && legend.labels) {
                    legend.labels.color = theme.legend;
                }

                if (tooltip) {
                    Object.assign(tooltip, getTooltipThemeOptions());
                }

                if (percentageLabel) {
                    options.plugins.percentageLabel = getPercentageLabelOptions(percentageLabel);
                }
            }

            chart.update('none');
        }

        function refreshAllChartsTheme() {
            if (!charts || typeof charts !== 'object') {
                return;
            }

            Object.values(charts).forEach(chart => applyThemeToChart(chart));

            if (CirurgicoDashboard && typeof CirurgicoDashboard.refreshChartsTheme === 'function') {
                CirurgicoDashboard.refreshChartsTheme();
            }
        }

        const CUSTOM_LEGEND_KEYS = new Set(['especialidade', 'evolucao', 'desfecho']);
        let isLoading = false;
        const requestCache = new Map();
        let loadingTimer = null;
        let loadingVisibleSince = 0;
        const LOADING_VISIBILITY_DELAY = 120;
        const MIN_LOADING_VISIBLE = 220;

        function getDatasetLegendColor(dataset, datasetIndex = 0) {
            const fallbackColor = '#1D4ED8';
            if (!dataset || typeof dataset !== 'object') {
                return fallbackColor;
            }

            const { borderColor, backgroundColor } = dataset;

            const pickColor = value => {
                if (Array.isArray(value) && value.length) {
                    const chosen = value[datasetIndex % value.length];
                    if (typeof chosen === 'string' && chosen.trim()) {
                        return chosen;
                    }
                }

                if (typeof value === 'string' && value.trim()) {
                    return value;
                }

                return null;
            };

            return pickColor(borderColor) || pickColor(backgroundColor) || fallbackColor;
        }

        function refreshCustomLegend(chartKey) {
            if (!CUSTOM_LEGEND_KEYS.has(chartKey)) {
                return;
            }

            const legendElement = document.querySelector(`[data-chart-legend="${chartKey}"]`);
            if (!legendElement) {
                return;
            }

            const chartInstance = charts?.[chartKey];
            const datasets = chartInstance?.data?.datasets;
            const fragment = document.createDocumentFragment();
            let itemCount = 0;

            if (Array.isArray(datasets)) {
                datasets.forEach((dataset, index) => {
                    const label = typeof dataset?.label === 'string' ? dataset.label.trim() : '';
                    if (!label) {
                        return;
                    }

                    const item = document.createElement('div');
                    item.className = 'chart-legend-item';
                    item.setAttribute('role', 'listitem');

                    const swatch = document.createElement('span');
                    swatch.className = 'chart-legend-color';
                    swatch.style.background = getDatasetLegendColor(dataset, index);

                    const text = document.createElement('span');
                    text.className = 'chart-legend-label';
                    text.textContent = label;

                    item.append(swatch, text);
                    fragment.appendChild(item);
                    itemCount += 1;
                });
            }

            legendElement.replaceChildren(fragment);
            const isHidden = itemCount === 0;
            legendElement.classList.toggle('is-hidden', isHidden);
            legendElement.setAttribute('aria-hidden', isHidden ? 'true' : 'false');
        }

        // ===== INICIALIZAÇÃO DO SISTEMA =====
        async function initializeDashboard() {
            let filtersLoaded = false;
            try {
                activeFilters = buildInitialFilters(activeDataset);
                const periodTypeSelect = document.getElementById('periodTypeFilter');
                if (periodTypeSelect) {
                    periodTypeSelect.value = activeFilters.periodType;
                }

                populateSelect('mesFilter', MONTH_INFO);
                setupPeriodRangeMultiSelect();
                updatePeriodControlsState();
                updatePeriodRangeOptions({ preserveSelection: false });

                showLoadingState();
                await loadFilterOptions();
                filtersLoaded = true;
                updatePeriodControlsState();
            } catch (error) {
                console.error('Erro na inicialização:', error);
                showError('Falha ao inicializar o dashboard');
            } finally {
                hideLoadingState();
            }

            // Animações de entrada
            animateElements();
            if (filtersLoaded) {
                scheduleInitialAmbulatorialLoad();
            }
        }

        function scheduleInitialAmbulatorialLoad(options = {}) {
            const config = typeof options === 'object' && options !== null ? options : {};
            const immediate = config.immediate === true;
            const datasetDefinition = getDatasetDefinition(activeDataset);
            if (!datasetDefinition || datasetDefinition.id !== 'ambulatorial') {
                return;
            }
            updatePerformanceInfo(`Preparando indicadores do ${datasetDefinition.label}...`);

            const executeLoad = () => {
                loadDashboardData(activeFilters, 1)
                    .then(() => {
                        ambulatorialInitialized = true;
                    })
                    .catch(error => {
                        console.error('Erro ao carregar dados iniciais do BI ambulatorial:', error);
                        showError('Falha ao carregar os dados iniciais do BI Ambulatorial');
                    });
            };

            if (immediate) {
                executeLoad();
                return;
            }

            if (typeof requestIdleCallback === 'function') {
                requestIdleCallback(executeLoad, { timeout: 1200 });
            } else {
                setTimeout(executeLoad, 120);
            }
        }

        // ===== CONFIGURAÇÃO DE EVENTOS =====
        function setupEventListeners() {
            // Botões principais
            document.getElementById('refreshBtn').addEventListener('click', refreshData);
            document.getElementById('exportBtn').addEventListener('click', exportData);
            document.getElementById('searchBtn').addEventListener('click', performSearch);
            document.getElementById('settingsBtn').addEventListener('click', showSettings);
            document.getElementById('insightsRefreshBtn').addEventListener('click', () => updateConsultasEspecialidade());

            const themeToggleBtn = document.getElementById('themeToggleBtn');
            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', () => ThemeManager.toggle());
            }

            // Filtros
            const filters = ['especialidadeFilter', 'situacaoFilter', 'tipoConsultaFilter'];
            filters.forEach(filterId => {
                const element = document.getElementById(filterId);
                if (element) {
                    element.addEventListener('change', () => applyFilters());
                }
            });

            document.getElementById('periodTypeFilter').addEventListener('change', handlePeriodTypeChange);

            const anoFilter = document.getElementById('anoFilter');
            if (anoFilter) {
                anoFilter.addEventListener('change', () => {
                    const periodType = getCurrentPeriodType();
                    if (periodType === 'semanal') {
                        const selection = updatePeriodRangeOptions({
                            preserveSelection: false,
                            autoSelectCurrentWeek: true,
                            autoSelectFirst: true
                        });
                        const values = selection.length ? selection : getSelectedPeriodValuesFromUI();
                        updatePeriodControlsState();
                        applyFilters({ periodValues: values });
                    } else {
                        updatePeriodControlsState();
                        applyFilters();
                    }
                });
            }

            const mesFilter = document.getElementById('mesFilter');
            if (mesFilter) {
                mesFilter.addEventListener('change', () => {
                    const periodType = getCurrentPeriodType();
                    if (periodType === 'semanal') {
                        const selection = updatePeriodRangeOptions({
                            preserveSelection: false,
                            autoSelectCurrentWeek: true,
                            autoSelectFirst: true
                        });
                        const values = selection.length ? selection : getSelectedPeriodValuesFromUI();
                        updatePeriodControlsState();
                        applyFilters({ periodValues: values });
                    } else {
                        updatePeriodControlsState();
                        applyFilters();
                    }
                });
            }

            // Busca por Enter
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch();
            });

            setupChartExpansion();
            ambulatorialListenersBound = true;
        }

        // ===== CARREGAMENTO DE DADOS =====
        async function loadFilterOptions() {
            if (!hasAppsScript) {
                console.warn('Google Apps Script não disponível, utilizando opções de filtro simuladas.');
                const fallbackFilters = {
                    especialidades: ['CARDIOLOGIA', 'DERMATOLOGIA', 'PEDIATRIA', 'ONCOLOGIA'],
                    situacoes: ['Realizado', 'Agendado', 'Faltou', 'Cancelado'],
                    tiposConsulta: ['Primeira Consulta', 'Retorno', 'Teleatendimento', 'Urgência'],
                    anos: ['2023', '2024']
                };

                populateSelect('especialidadeFilter', fallbackFilters.especialidades);
                populateSelect('situacaoFilter', fallbackFilters.situacoes);
                populateSelect('tipoConsultaFilter', fallbackFilters.tiposConsulta);
                populateSelect('anoFilter', fallbackFilters.anos);
                updatePeriodRangeOptions(false);
                updatePeriodControlsState();
                return;
            }

            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(options => {
                        populateSelect('especialidadeFilter', options?.especialidades || []);
                        populateSelect('situacaoFilter', options?.situacoes || []);
                        populateSelect('tipoConsultaFilter', options?.tiposConsulta || []);
                        populateSelect('anoFilter', options?.anos || []);
                        updatePeriodRangeOptions();
                        updatePeriodControlsState();
                        resolve();
                    })
                    .withFailureHandler(error => {
                        console.error('Erro ao carregar filtros:', error);
                        showError('Não foi possível carregar os filtros da planilha');
                        reject(error);
                    })
                    .getFilterOptions(activeDataset);
            });
        }

        function formatMonthValue(month) {
            if (month === undefined || month === null) {
                return '';
            }

            if (typeof month === 'string' && month.trim() === '') {
                return '';
            }

            const numeric = typeof month === 'number'
                ? month
                : Number.parseInt(month, 10);

            if (!Number.isFinite(numeric)) {
                return '';
            }

            const bounded = Math.min(Math.max(numeric, 1), 12);
            return String(bounded).padStart(2, '0');
        }

        function getMonthInfo(monthValue) {
            const normalized = formatMonthValue(monthValue);
            return normalized ? MONTH_INFO_BY_VALUE[normalized] || null : null;
        }

        function formatDay(day) {
            return String(Math.max(1, Math.floor(day))).padStart(2, '0');
        }

        function getSelectedMonthFromUI() {
            const monthSelect = document.getElementById('mesFilter');
            return monthSelect ? monthSelect.value : '';
        }

        function getSelectedYearFromUI(options = {}) {
            const { fallbackToCurrent = false } = options;
            const yearSelect = document.getElementById('anoFilter');
            const rawValue = yearSelect ? yearSelect.value : '';

            if (rawValue || !fallbackToCurrent) {
                return rawValue;
            }

            return String(new Date().getFullYear());
        }

        function getCurrentPeriodType() {
            const periodTypeSelect = document.getElementById('periodTypeFilter');
            const raw = periodTypeSelect ? periodTypeSelect.value : activeFilters.periodType;
            return (raw || '').toLowerCase();
        }

        function ensureWeeklyContextDefaults() {
            const yearSelect = document.getElementById('anoFilter');
            const monthSelect = document.getElementById('mesFilter');

            let yearValue = getSelectedYearFromUI();
            if ((!yearValue || yearValue === '') && yearSelect) {
                const currentYear = String(new Date().getFullYear());
                const hasCurrentYear = Array.from(yearSelect.options || [])
                    .some(option => option.value === currentYear);
                if (hasCurrentYear) {
                    yearSelect.value = currentYear;
                    yearValue = currentYear;
                }
            }

            let monthValue = getSelectedMonthFromUI();
            if ((!monthValue || monthValue === '') && monthSelect) {
                const currentMonth = formatMonthValue(new Date().getMonth() + 1);
                const hasCurrentMonth = Array.from(monthSelect.options || [])
                    .some(option => option.value === currentMonth);
                if (hasCurrentMonth) {
                    monthSelect.value = currentMonth;
                    monthValue = currentMonth;
                }
            }

            const resolvedYear = yearValue || getSelectedYearFromUI({ fallbackToCurrent: true });
            return {
                year: resolvedYear,
                month: monthValue
            };
        }

        function buildWeeklyOptions(year, monthValue) {
            const normalizedMonth = formatMonthValue(monthValue);
            if (!normalizedMonth) {
                return [];
            }

            const yearNumber = Number.parseInt(year, 10);
            const safeYearNumber = Number.isFinite(yearNumber) ? yearNumber : new Date().getFullYear();
            const labelYear = String(Number.isFinite(yearNumber) ? yearNumber : safeYearNumber);
            const monthIndex = Number.parseInt(normalizedMonth, 10) - 1;

            if (!Number.isFinite(monthIndex) || monthIndex < 0 || monthIndex > 11) {
                return [];
            }

            const totalDays = new Date(safeYearNumber, monthIndex + 1, 0).getDate();
            const options = [];
            let startDay = 1;
            let weekIndex = 1;
            const monthInfo = getMonthInfo(normalizedMonth);
            const monthShort = monthInfo?.shortLabel || normalizedMonth;
            const monthFull = monthInfo?.label || normalizedMonth;

            while (startDay <= totalDays) {
                const endDay = Math.min(startDay + 6, totalDays);
                const startLabel = formatDay(startDay);
                const endLabel = formatDay(endDay);
                const value = `sem-${labelYear}-${normalizedMonth}-${weekIndex}`;
                const label = `Semana ${weekIndex} (${startLabel}–${endLabel} ${monthShort}/${labelYear})`;
                const badgeLabel = `Semana ${weekIndex} · ${monthFull}/${labelYear}`;
                const summaryLabel = `Semana ${weekIndex} · ${monthFull}/${labelYear}`;

                options.push({
                    value,
                    label,
                    badgeLabel,
                    summaryLabel,
                    monthValue: normalizedMonth,
                    year: labelYear,
                    weekIndex,
                    range: {
                        startDay,
                        endDay
                    }
                });

                startDay += 7;
                weekIndex += 1;
            }

            return options;
        }

        function getDefaultWeeklySelection(year, monthValue, options) {
            if (!Array.isArray(options) || options.length === 0) {
                return [];
            }

            const normalizedMonth = formatMonthValue(monthValue);
            const currentDate = new Date();
            const currentYear = String(currentDate.getFullYear());
            const currentMonth = formatMonthValue(currentDate.getMonth() + 1);

            if (String(year) === currentYear && normalizedMonth === currentMonth) {
                const currentWeekIndex = Math.min(
                    options.length,
                    Math.max(1, Math.ceil(currentDate.getDate() / 7))
                );
                const currentWeekOption = options.find(option => option.weekIndex === currentWeekIndex);
                if (currentWeekOption) {
                    return [currentWeekOption.value];
                }
            }

            return [options[0].value];
        }

        function getPeriodOptions(periodType) {
            const normalized = (periodType || '').toLowerCase();
            if (normalized === 'semanal') {
                const monthValue = getSelectedMonthFromUI();
                const yearValue = getSelectedYearFromUI({ fallbackToCurrent: true });
                if (!monthValue) {
                    return [];
                }
                return buildWeeklyOptions(yearValue, monthValue);
            }

            const presets = PERIOD_PRESETS[normalized];
            return Array.isArray(presets)
                ? presets.map(option => ({
                    ...option,
                    badgeLabel: option.badgeLabel || option.label,
                    summaryLabel: option.summaryLabel || option.label
                }))
                : [];
        }

        function updatePeriodRangeOptions(config) {
            const defaultConfig = {
                preserveSelection: true,
                autoSelectCurrentWeek: false,
                autoSelectFirst: false,
                defaultSelection: null,
                triggerFilters: false,
                emptyMessage: null
            };

            const finalConfig = typeof config === 'object' && config !== null
                ? { ...defaultConfig, ...config }
                : { ...defaultConfig, preserveSelection: config !== false };

            const periodTypeSelect = document.getElementById('periodTypeFilter');
            const periodRangeSelect = document.getElementById('periodRangeFilter');
            const optionsContainer = document.getElementById('periodRangeOptions');

            if (!periodTypeSelect || !periodRangeSelect || !optionsContainer) {
                return [];
            }

            const selectedType = periodTypeSelect.value || activeFilters.periodType || 'mensal';
            const options = getPeriodOptions(selectedType);
            const previouslySelected = finalConfig.preserveSelection && Array.isArray(activeFilters.periodValues)
                ? Array.from(new Set(activeFilters.periodValues))
                : [];

            currentPeriodOptions = options.slice();
            populateSelect('periodRangeFilter', options, { keepPlaceholder: false });

            optionsContainer.innerHTML = '';
            if (!options.length) {
                const emptyState = document.createElement('div');
                emptyState.className = 'multi-option multi-option--empty';
                emptyState.textContent = finalConfig.emptyMessage
                    || (selectedType === 'semanal'
                        ? 'Defina ao menos o mês (e, se desejar, o ano) para ver as semanas disponíveis.'
                        : 'Nenhum intervalo disponível para este período.');
                optionsContainer.appendChild(emptyState);
                setPeriodRangeSelections([], false);
                updateSelectAllState([]);
                return [];
            }

            const validValues = new Set(options.map(option => option.value));
            let selectionToApply = previouslySelected.filter(value => validValues.has(value));

            options.forEach(option => {
                const optionId = `period-range-${option.value}`;
                const wrapper = document.createElement('label');
                wrapper.className = 'multi-option';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = option.value;
                checkbox.id = optionId;
                checkbox.checked = selectionToApply.includes(option.value);
                checkbox.addEventListener('change', () => {
                    const values = getSelectedPeriodValuesFromUI();
                    setPeriodRangeSelections(values);
                });

                const text = document.createElement('span');
                text.textContent = option.label;

                wrapper.appendChild(checkbox);
                wrapper.appendChild(text);
                optionsContainer.appendChild(wrapper);
            });

            if (!selectionToApply.length) {
                let defaultSelection = Array.isArray(finalConfig.defaultSelection)
                    ? finalConfig.defaultSelection.filter(value => validValues.has(value))
                    : [];

                if (!defaultSelection.length && finalConfig.autoSelectCurrentWeek && selectedType === 'semanal') {
                    defaultSelection = getDefaultWeeklySelection(
                        getSelectedYearFromUI({ fallbackToCurrent: true }),
                        getSelectedMonthFromUI(),
                        options
                    );
                }

                if (!defaultSelection.length && finalConfig.autoSelectFirst) {
                    defaultSelection = options.length ? [options[0].value] : [];
                }

                selectionToApply = defaultSelection;
            }

            setPeriodRangeSelections(selectionToApply, finalConfig.triggerFilters);

            return selectionToApply;
        }

        function updatePeriodRangeHelperText(periodType = getCurrentPeriodType(), contextReady = true, context = {}) {
            const helper = document.getElementById('periodRangeHelper');
            if (!helper) {
                return;
            }

            const normalized = (periodType || '').toLowerCase();

            if (normalized === 'semanal') {
                if (!contextReady || context.hasMonth === false) {
                    helper.textContent = 'Defina o mês (e, se desejar, o ano) para liberar as semanas disponíveis.';
                } else if (context.hasYear === false) {
                    helper.textContent = 'Mês definido. Utilize o ano para refinar (opcional) e escolha a semana desejada.';
                } else {
                    helper.textContent = 'Escolha a semana após definir o mês e o ano.';
                }
                return;
            }

            if (normalized === 'mensal') {
                helper.textContent = 'Selecione os meses desejados para analisar a série.';
                return;
            }

            if (normalized === 'diario') {
                helper.textContent = 'Selecione um ou mais intervalos diários para análise.';
                return;
            }

            helper.textContent = 'Selecione um ou mais intervalos conforme o período escolhido.';
        }

        function updatePeriodControlsState() {
            const periodType = getCurrentPeriodType();
            const monthGroup = document.getElementById('mesFilterGroup');
            const control = document.getElementById('periodRangeControl');
            const hasMonth = Boolean(getSelectedMonthFromUI());
            const hasYear = Boolean(getSelectedYearFromUI());
            const isWeekly = periodType === 'semanal';
            const contextReady = isWeekly ? hasMonth : true;

            if (monthGroup) {
                monthGroup.classList.toggle('is-hidden', !isWeekly);
            }

            if (control) {
                const shouldDisable = isWeekly && !contextReady;
                control.classList.toggle('is-disabled', shouldDisable);
                if (shouldDisable) {
                    closePeriodRangeDropdown();
                }
            }

            updatePeriodRangeHelperText(periodType, contextReady, { hasMonth, hasYear });
        }

        function setupPeriodRangeMultiSelect() {
            if (periodMultiSelectInitialized) {
                return;
            }

            const control = document.getElementById('periodRangeControl');
            if (!control) {
                return;
            }

            const trigger = control.querySelector('.multi-select-trigger');
            const selectAllBtn = control.querySelector('[data-action="select-all"]');
            const clearBtn = control.querySelector('[data-action="clear-all"]');

            if (trigger) {
                trigger.addEventListener('click', event => {
                    event.preventDefault();
                    if (control.classList.contains('is-disabled')) {
                        return;
                    }
                    const isOpen = control.classList.toggle('open');
                    trigger.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
                });
            }

            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', () => {
                    if (control.classList.contains('is-disabled')) {
                        return;
                    }
                    const allValues = currentPeriodOptions.map(option => option.value);
                    setPeriodRangeSelections(allValues);
                    closePeriodRangeDropdown();
                });
            }

            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    if (control.classList.contains('is-disabled')) {
                        return;
                    }
                    setPeriodRangeSelections([]);
                });
            }

            document.addEventListener('click', event => {
                if (!control.contains(event.target)) {
                    closePeriodRangeDropdown();
                }
            });

            document.addEventListener('keydown', event => {
                if (event.key === 'Escape') {
                    closePeriodRangeDropdown();
                }
            });

            periodMultiSelectInitialized = true;
        }

        function closePeriodRangeDropdown() {
            const control = document.getElementById('periodRangeControl');
            if (!control) {
                return;
            }

            if (control.classList.contains('open')) {
                control.classList.remove('open');
                const trigger = control.querySelector('.multi-select-trigger');
                if (trigger) {
                    trigger.setAttribute('aria-expanded', 'false');
                }
            }
        }

        function getSelectedPeriodValuesFromUI() {
            const control = document.getElementById('periodRangeControl');
            if (!control) {
                return [];
            }

            return Array.from(control.querySelectorAll('.multi-select-options input[type="checkbox"]:checked'))
                .map(input => input.value)
                .filter(Boolean);
        }

        function syncHiddenPeriodSelect(values) {
            const select = document.getElementById('periodRangeFilter');
            if (!select) {
                return;
            }

            const normalized = Array.isArray(values) ? values : [];
            Array.from(select.options).forEach(option => {
                option.selected = normalized.includes(option.value);
            });
        }

        function updatePeriodRangeSummary(selectedValues = activeFilters.periodValues) {
            const summaryEl = document.getElementById('periodRangeSummary');
            if (!summaryEl) {
                return;
            }

            const totalOptions = currentPeriodOptions.length;
            const normalized = Array.isArray(selectedValues) ? selectedValues : [];

            if (!normalized.length || (totalOptions && normalized.length === totalOptions)) {
                summaryEl.textContent = 'Todos os intervalos';
                return;
            }

            const labels = normalized
                .map(value => {
                    const option = currentPeriodOptions.find(item => item.value === value);
                    return option?.summaryLabel || option?.badgeLabel || option?.label;
                })
                .filter(Boolean);

            if (labels.length <= 2) {
                summaryEl.textContent = labels.join(' • ');
            } else {
                summaryEl.textContent = `${labels.length} intervalos selecionados`;
            }
        }

        function updatePeriodRangeBadges(selectedValues = activeFilters.periodValues) {
            const badgesContainer = document.getElementById('periodRangeBadges');
            if (!badgesContainer) {
                return;
            }

            badgesContainer.innerHTML = '';
            const totalOptions = currentPeriodOptions.length;
            const normalized = Array.isArray(selectedValues) ? selectedValues : [];

            if (!normalized.length) {
                const badge = document.createElement('span');
                badge.className = 'multi-select-badge';
                badge.textContent = 'Todos os intervalos';
                badgesContainer.appendChild(badge);
                return;
            }

            if (totalOptions && normalized.length === totalOptions) {
                const badge = document.createElement('span');
                badge.className = 'multi-select-badge';
                badge.textContent = 'Todos os intervalos selecionados';
                badgesContainer.appendChild(badge);
                return;
            }

            const labels = normalized
                .map(value => {
                    const option = currentPeriodOptions.find(item => item.value === value);
                    return option?.badgeLabel || option?.summaryLabel || option?.label;
                })
                .filter(Boolean);

            labels.slice(0, 3).forEach(label => {
                const badge = document.createElement('span');
                badge.className = 'multi-select-badge';
                badge.textContent = label;
                badgesContainer.appendChild(badge);
            });

            if (labels.length > 3) {
                const badge = document.createElement('span');
                badge.className = 'multi-select-badge';
                badge.textContent = `+${labels.length - 3}`;
                badgesContainer.appendChild(badge);
            }
        }

        function updateSelectAllState(selectedValues = activeFilters.periodValues) {
            const control = document.getElementById('periodRangeControl');
            if (!control) {
                return;
            }

            const selectAllBtn = control.querySelector('[data-action="select-all"]');
            const clearBtn = control.querySelector('[data-action="clear-all"]');
            const totalOptions = currentPeriodOptions.length;
            const normalized = Array.isArray(selectedValues) ? selectedValues : [];

            if (selectAllBtn) {
                if (!totalOptions) {
                    selectAllBtn.textContent = 'Sem intervalos';
                    selectAllBtn.disabled = true;
                } else if (normalized.length === totalOptions) {
                    selectAllBtn.textContent = 'Todos selecionados';
                    selectAllBtn.disabled = true;
                } else {
                    selectAllBtn.textContent = 'Selecionar todos';
                    selectAllBtn.disabled = false;
                }
            }

            if (clearBtn) {
                clearBtn.disabled = normalized.length === 0;
            }
        }

        function setPeriodRangeSelections(values, triggerFilters = true) {
            const validOptions = new Set(currentPeriodOptions.map(option => option.value));
            const normalized = Array.isArray(values)
                ? values.filter(value => value && validOptions.has(value))
                : [];

            syncHiddenPeriodSelect(normalized);
            updatePeriodRangeSummary(normalized);
            updatePeriodRangeBadges(normalized);
            updateSelectAllState(normalized);

            if (triggerFilters) {
                applyFilters({ periodValues: normalized });
            } else {
                activeFilters = {
                    ...activeFilters,
                    periodValues: normalized
                };
            }
        }

        function handlePeriodTypeChange() {
            const periodTypeSelect = document.getElementById('periodTypeFilter');
            const nextType = periodTypeSelect ? periodTypeSelect.value : activeFilters.periodType;
            closePeriodRangeDropdown();
            if ((nextType || '').toLowerCase() === 'semanal') {
                const context = ensureWeeklyContextDefaults();
                updatePeriodControlsState();
                const selection = updatePeriodRangeOptions({
                    preserveSelection: false,
                    autoSelectCurrentWeek: true,
                    autoSelectFirst: true
                });
                const values = selection.length ? selection : getSelectedPeriodValuesFromUI();
                applyFilters({
                    periodType: nextType,
                    periodValues: values,
                    mes: document.getElementById('mesFilter')?.value || context.month,
                    ano: document.getElementById('anoFilter')?.value || context.year
                });
            } else {
                updatePeriodControlsState();
                updatePeriodRangeOptions({ preserveSelection: false });
                applyFilters({ periodType: nextType, periodValues: [] });
            }
        }

        async function loadDashboardData(filters = activeFilters, page = 1) {
            if (isLoading) {
                pendingFilters = {
                    filters: {
                        ...filters,
                        dataset: activeDataset,
                        periodValues: Array.isArray(filters.periodValues)
                            ? [...filters.periodValues]
                            : []
                    },
                    page
                };
                return;
            }

            isLoading = true;
            pendingFilters = null;

            activeFilters = {
                ...activeFilters,
                ...filters,
                periodValues: Array.isArray(filters.periodValues)
                    ? [...filters.periodValues]
                    : Array.isArray(activeFilters.periodValues)
                        ? [...activeFilters.periodValues]
                        : [],
                search: (filters.search || activeFilters.search || '').toString().trim()
            };
            activeFilters.dataset = activeDataset;

            const normalizedFilters = normalizeFilters(activeFilters);
            const cacheKey = hasAppsScript ? getRequestCacheKey(normalizedFilters, page) : null;
            const cachedEntry = cacheKey ? requestCache.get(cacheKey) : null;
            const requestStartedAt = getNow();

            updatePerformanceInfo('Carregando dados da planilha...');

            if (!cachedEntry) {
                showLoadingState();
            } else {
                applyDashboardPayload(cachedEntry.result, {
                    fromCache: true,
                    defaultMessage: 'Dados carregados instantaneamente (cache) • Atualizando...'
                });
            }

            if (!hasAppsScript) {
                console.warn('Google Apps Script não disponível. Utilizando dados simulados.');

                const fallbackSnapshot = getFallbackDataset(activeDataset);
                const simulatedResult = {
                    kpis: cloneData(fallbackSnapshot.kpis || {}),
                    consultasEspecialidade: cloneData(fallbackSnapshot.consultasEspecialidade || []),
                    charts: cloneData(fallbackSnapshot.charts || {})
                };

                applyDashboardPayload(simulatedResult, {
                    defaultMessage: 'Modo demonstração ativo • Dados simulados atualizados'
                });

                hideLoadingState();
                isLoading = false;
                const response = Promise.resolve(simulatedResult);
                if (pendingFilters) {
                    const next = pendingFilters;
                    pendingFilters = null;
                    queueMicrotask(() => loadDashboardData(next.filters, next.page));
                }
                return response;
            }

            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(result => {
                        const sanitizedResult = result && typeof result === 'object' ? result : {};
                        const duration = Math.max(0, Math.round(getNow() - requestStartedAt));
                        const hasChartInline = applyDashboardPayload(sanitizedResult, {
                            durationMs: duration
                        });

                        hideLoadingState();
                        isLoading = false;

                        if (cacheKey) {
                            requestCache.set(cacheKey, {
                                result: cloneResult(sanitizedResult),
                                timestamp: Date.now()
                            });
                            pruneRequestCache();
                        }

                        if (!hasChartInline) {
                            loadChartData(activeFilters).catch(() => {});
                        }

                        if (pendingFilters) {
                            const next = pendingFilters;
                            pendingFilters = null;
                            queueMicrotask(() => loadDashboardData(next.filters, next.page));
                        }

                        resolve(result);
                    })
                    .withFailureHandler(error => {
                        console.error('Erro ao carregar dados:', error);
                        showError('Erro ao carregar dados da planilha');
                        hideLoadingState();
                        isLoading = false;
                        if (pendingFilters) {
                            const next = pendingFilters;
                            pendingFilters = null;
                            queueMicrotask(() => loadDashboardData(next.filters, next.page));
                        }
                        reject(error);
                    })
                    .getDashboardDataPaginated(normalizedFilters, page);
            });
        }

        function applyDashboardPayload(result, options = {}) {
            const {
                fromCache = false,
                durationMs = null,
                defaultMessage = 'Dados atualizados a partir da planilha'
            } = options;

            const nextKpis = result?.kpis && typeof result.kpis === 'object' ? result.kpis : emptyKpis;
            const consultasRealizadas = toNumber(nextKpis.totalConsultas || 0);
            const faltasTotais = toNumber(nextKpis.totalFaltas || 0);
            const agendamentosTotais = toNumber(
                nextKpis.totalAgendamentos != null
                    ? nextKpis.totalAgendamentos
                    : consultasRealizadas + faltasTotais
            );

            kpiData = {
                totalConsultas: consultasRealizadas,
                percentualAbsenteismo: toNumber(nextKpis.percentualAbsenteismo || 0),
                pacientesSegmento: toNumber(nextKpis.pacientesSegmento || 0),
                totalRegistros: toNumber(nextKpis.totalRegistros || 0),
                totalFaltas: faltasTotais,
                totalAgendamentos: agendamentosTotais
            };
            updateKPIs();

            const consultasRaw = Array.isArray(result?.consultasEspecialidade)
                ? result.consultasEspecialidade
                : Array.isArray(result?.especialidadesResumo)
                    ? result.especialidadesResumo
                    : null;

            if (Array.isArray(consultasRaw)) {
                consultasEspecialidade = consultasRaw.map(item => ({
                    especialidade: item.especialidade || item.nome || 'N/D',
                    consultas: toNumber(item.consultas ?? item.total ?? item.quantidade ?? 0)
                }));
                updateConsultasEspecialidade();
            }

            let hasChartData = false;
            if (result?.charts && typeof result.charts === 'object') {
                chartData = {...result.charts};
                hasChartData = hasValidChartDataset(chartData);
                if (hasChartData) {
                    updateCharts();
                }
            }

            if (result?.performance) {
                const infoParts = ['Atualizado agora'];
                if (typeof result.performance.totalRecords === 'number') {
                    infoParts.push(`${Number(result.performance.totalRecords).toLocaleString()} registros analisados`);
                }
                if (result.performance.processingTime) {
                    infoParts.push(`${result.performance.processingTime}ms`);
                }
                updatePerformanceInfo(infoParts.join(' • '));
            } else if (typeof durationMs === 'number') {
                updatePerformanceInfo(`Atualizado agora • ${durationMs}ms`);
            } else if (defaultMessage) {
                updatePerformanceInfo(defaultMessage);
            } else if (fromCache) {
                updatePerformanceInfo('Dados carregados instantaneamente do cache');
            }

            return hasChartData;
        }

        // ===== ATUALIZAÇÃO DA INTERFACE =====
        function updateKPIs() {
            const totalConsultas = toNumber(kpiData.totalConsultas || 0);
            const percentualAbsenteismo = toNumber(kpiData.percentualAbsenteismo || 0);
            const pacientesSegmento = toNumber(kpiData.pacientesSegmento || 0);
            const totalAgendamentos = toNumber(
                kpiData.totalAgendamentos || (totalConsultas + toNumber(kpiData.totalFaltas || 0))
            );

            const absenteismoFormatado = Number.isFinite(percentualAbsenteismo)
                ? percentualAbsenteismo.toFixed(1)
                : '0.0';

            if (DOMRefs.totalConsultas) {
                DOMRefs.totalConsultas.textContent = totalConsultas.toLocaleString();
            }

            if (DOMRefs.totalAgendamentos) {
                DOMRefs.totalAgendamentos.textContent = totalAgendamentos.toLocaleString();
            }

            if (DOMRefs.percentualAbsenteismo) {
                DOMRefs.percentualAbsenteismo.textContent = `${absenteismoFormatado}%`;
            }

            if (DOMRefs.pacientesSegmento) {
                DOMRefs.pacientesSegmento.textContent = pacientesSegmento.toLocaleString();
            }

            const absenteismoEmAlerta = Number.isFinite(percentualAbsenteismo)
                && percentualAbsenteismo >= ABSENTEEISM_ALERT_THRESHOLD;

            if (DOMRefs.absenteismoCard) {
                DOMRefs.absenteismoCard.classList.toggle('card--alerta', absenteismoEmAlerta);
                DOMRefs.absenteismoCard.setAttribute('data-state', absenteismoEmAlerta ? 'alerta' : 'normal');
            }

            if (DOMRefs.settingsBtn) {
                DOMRefs.settingsBtn.classList.toggle('btn--critico', absenteismoEmAlerta);
                DOMRefs.settingsBtn.setAttribute('data-alert', absenteismoEmAlerta ? 'true' : 'false');
                DOMRefs.settingsBtn.title = absenteismoEmAlerta
                    ? 'Há indicadores críticos aguardando revisão'
                    : 'Configurações do painel';
            }

            animateValueChanges();
        }

        function updateConsultasEspecialidade() {
            const tableBody = document.getElementById('consultasEspecialidadeBody');
            const badge = document.getElementById('consultasBadge');

            if (!tableBody) return;

            tableBody.innerHTML = '';

            const datasetInfo = getConsultasEspecialidadeDataset();
            const dataset = datasetInfo.dataset;

            if (dataset.length === 0) {
                tableBody.innerHTML = `
                    <tr class="empty-row">
                        <td colspan="3">Nenhum atendimento válido encontrado para os filtros atuais.</td>
                    </tr>
                `;
                badge.textContent = datasetInfo.usingFallback
                    ? 'Sem dados demonstrativos disponíveis'
                    : 'Sem dados disponíveis';
                updateConsultasInsights();
                return;
            }

            const ordenado = dataset
                .slice()
                .sort((a, b) => (toNumber(b.consultas || 0) - toNumber(a.consultas || 0)));

            const totalAtendimentos = ordenado.reduce((acc, item) => acc + toNumber(item.consultas || 0), 0);
            const percentFormatter = new Intl.NumberFormat('pt-BR', {
                minimumFractionDigits: 1,
                maximumFractionDigits: 1
            });

            const fragment = document.createDocumentFragment();

            ordenado.forEach(item => {
                const consultas = toNumber(item.consultas || 0);
                const participacao = totalAtendimentos > 0
                    ? ((consultas / totalAtendimentos) * 100)
                    : 0;
                const participacaoTexto = `${percentFormatter.format(participacao)}%`;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.especialidade || 'N/D'}</td>
                    <td>${consultas.toLocaleString('pt-BR')}</td>
                    <td>${participacaoTexto}</td>
                `;
                fragment.appendChild(row);
            });

            tableBody.appendChild(fragment);

            const topTres = ordenado.slice(0, 3).map(item => item.especialidade || 'N/D');
            const especialidadeLider = ordenado[0] || null;

            badge.textContent = datasetInfo.usingFallback
                ? 'Dados demonstrativos carregados'
                : `${ordenado.length} especialidades analisadas`;

            updateConsultasInsights({
                totalAtendimentos,
                especialidadeLider,
                topTres
            });
        }

        function updateConsultasInsights(stats = null) {
            const totalAtendimentosEl = document.getElementById('insightTotalAtendimentos');
            const especialidadeLiderEl = document.getElementById('insightEspecialidadeLider');
            const topEspecialidadesEl = document.getElementById('insightTopEspecialidades');

            if (!stats) {
                totalAtendimentosEl.textContent = '0';
                especialidadeLiderEl.textContent = '-';
                topEspecialidadesEl.textContent = '-';
                return;
            }

            const { totalAtendimentos, especialidadeLider, topTres } = stats;
            totalAtendimentosEl.textContent = Number(totalAtendimentos || 0).toLocaleString('pt-BR');

            if (especialidadeLider && especialidadeLider.especialidade) {
                const quantidade = Number(especialidadeLider.consultas || 0).toLocaleString('pt-BR');
                especialidadeLiderEl.textContent = `${especialidadeLider.especialidade} (${quantidade})`;
            } else {
                especialidadeLiderEl.textContent = '-';
            }

            if (Array.isArray(topTres) && topTres.length > 0) {
                topEspecialidadesEl.textContent = topTres.join(' • ');
            } else {
                topEspecialidadesEl.textContent = '-';
            }
        }

        function loadChartData(filters = activeFilters) {
            if (!hasAppsScript) {
                console.warn('Google Apps Script não disponível. Mantendo dados simulados dos gráficos.');
                return Promise.resolve(null);
            }

            const requestFilters = normalizeFilters(filters);

            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(data => {
                        chartData = data && typeof data === 'object' ? data : null;
                        if (chartData && Array.isArray(chartData.especialidadesResumo)) {
                            consultasEspecialidade = chartData.especialidadesResumo.map(item => ({
                                especialidade: item.especialidade || item.nome || 'N/D',
                                consultas: toNumber(item.consultas ?? item.total ?? item.quantidade ?? 0)
                            }));
                            updateConsultasEspecialidade();
                        }
                        updateCharts();
                        resolve(chartData);
                    })
                    .withFailureHandler(error => {
                        console.error('Erro ao carregar dados dos gráficos:', error);
                        showError('Não foi possível atualizar os gráficos');
                        reject(error);
                    })
                    .getChartData(requestFilters);
            });
        }

        // ===== FUNÇÕES DE CONTROLE =====
        function applyFilters(overrides = {}) {
            const nextFilters = {
                ...activeFilters,
                especialidade: document.getElementById('especialidadeFilter')?.value || '',
                situacao: document.getElementById('situacaoFilter')?.value || '',
                tipoConsulta: document.getElementById('tipoConsultaFilter')?.value || '',
                ano: document.getElementById('anoFilter')?.value || '',
                mes: document.getElementById('mesFilter')?.value || '',
                periodType: document.getElementById('periodTypeFilter')?.value || activeFilters.periodType,
                periodValues: Array.isArray(activeFilters.periodValues) ? [...activeFilters.periodValues] : [],
                search: overrides.search !== undefined ? overrides.search : activeFilters.search,
                dataset: activeDataset
            };

            if ((nextFilters.periodType || '').toLowerCase() !== 'semanal') {
                nextFilters.mes = '';
            }

            Object.keys(overrides).forEach(key => {
                if (key === 'periodValues') {
                    nextFilters.periodValues = Array.isArray(overrides.periodValues)
                        ? [...overrides.periodValues]
                        : [];
                } else if (key in nextFilters) {
                    nextFilters[key] = overrides[key];
                }
            });

            if (areFiltersEqual(nextFilters, activeFilters)) {
                return;
            }

            activeFilters = nextFilters;
            queueFilterUpdate(activeFilters, 1);
        }

        function areFiltersEqual(a, b) {
            if (!a || !b) {
                return false;
            }

            const keys = ['especialidade', 'situacao', 'tipoConsulta', 'ano', 'mes', 'periodType', 'search'];
            for (const key of keys) {
                if ((a[key] || '') !== (b[key] || '')) {
                    return false;
                }
            }

            const valuesA = Array.isArray(a.periodValues) ? a.periodValues.slice().sort() : [];
            const valuesB = Array.isArray(b.periodValues) ? b.periodValues.slice().sort() : [];

            if (valuesA.length !== valuesB.length) {
                return false;
            }

            for (let index = 0; index < valuesA.length; index += 1) {
                if (valuesA[index] !== valuesB[index]) {
                    return false;
                }
            }

            return true;
        }

        function queueFilterUpdate(filters, page = 1) {
            const normalizedFilters = {
                ...filters,
                dataset: activeDataset,
                periodValues: Array.isArray(filters.periodValues)
                    ? [...filters.periodValues]
                    : []
            };

            if (filterUpdateTimeout) {
                clearTimeout(filterUpdateTimeout);
            }

            filterUpdateTimeout = setTimeout(() => {
                filterUpdateTimeout = null;
                loadDashboardData(normalizedFilters, page);
            }, FILTER_DEBOUNCE_MS);
        }

        function performSearch() {
            if (!hasAppsScript) {
                showError('Conecte o painel ao Apps Script para utilizar a busca.');
                return;
            }

            const value = document.getElementById('searchInput')?.value.trim() || '';
            applyFilters({ search: value });
        }

        function refreshData() {
            if (!hasAppsScript) {
                showError('Conecte o painel ao Apps Script para atualizar os dados.');
                return;
            }

            loadDashboardData(activeFilters, 1)
                .then(() => showNotification('Dados atualizados com sucesso!', 'success'))
                .catch(() => showError('Não foi possível atualizar os dados'));
        }

        function exportData() {
            if (!hasAppsScript) {
                showError('Conecte o painel ao Apps Script para exportar os dados da planilha.');
                return;
            }

            showNotification('Preparando exportação de dados...', 'info');

            setTimeout(() => {
                showNotification('Exportação disponível via integração com a planilha.', 'success');
                updatePerformanceInfo('Exportação solicitada pela interface');
            }, 1500);
        }

        function showSettings() {
            showNotification('Abrindo configurações do sistema...', 'info');
        }

        // ===== EXPANSÃO DE GRÁFICOS =====
        function setupChartExpansion() {
            const overlay = DOMRefs.chartOverlay;
            if (!overlay || overlay.dataset.bound === 'true') {
                return;
            }

            let expandedContainer = null;
            let expandedTrigger = null;

            const closeExpanded = () => {
                if (!expandedContainer) {
                    return;
                }

                const container = expandedContainer;
                const trigger = expandedTrigger;
                const wrapper = container.querySelector('.chart-wrapper');

                container.classList.remove('is-expanded');
                document.body.classList.remove('chart-expanded');
                overlay.classList.remove('is-active');
                overlay.setAttribute('aria-hidden', 'true');

                if (trigger) {
                    trigger.setAttribute('aria-expanded', 'false');
                    trigger.setAttribute('aria-label', 'Expandir gráfico');
                    const icon = trigger.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-compress');
                        icon.classList.add('fa-expand');
                    }
                }

                if (wrapper) {
                    const originalHeight = wrapper.dataset.originalHeight ?? '';
                    const originalMaxHeight = wrapper.dataset.originalMaxHeight ?? '';
                    wrapper.style.height = originalHeight;
                    wrapper.style.maxHeight = originalMaxHeight;
                    delete wrapper.dataset.originalHeight;
                    delete wrapper.dataset.originalMaxHeight;
                }

                const canvas = container.querySelector('canvas');
                if (canvas) {
                    refreshChartForCanvas(canvas);
                }

                refreshChartDimensions(container);

                if (trigger) {
                    trigger.focus({ preventScroll: true });
                }

                expandedContainer = null;
                expandedTrigger = null;
            };

            const openExpanded = (container, trigger) => {
                if (!container || container === expandedContainer) {
                    closeExpanded();
                    return;
                }

                if (expandedContainer && expandedContainer !== container) {
                    closeExpanded();
                }

                expandedContainer = container;
                expandedTrigger = trigger;

                const wrapper = container.querySelector('.chart-wrapper');

                if (wrapper) {
                    if (!wrapper.dataset.originalHeight) {
                        wrapper.dataset.originalHeight = wrapper.style.height || '';
                    }
                    if (!wrapper.dataset.originalMaxHeight) {
                        wrapper.dataset.originalMaxHeight = wrapper.style.maxHeight || '';
                    }
                }

                document.body.classList.add('chart-expanded');
                container.classList.add('is-expanded');
                overlay.classList.add('is-active');
                overlay.setAttribute('aria-hidden', 'false');

                if (trigger) {
                    trigger.setAttribute('aria-expanded', 'true');
                    trigger.setAttribute('aria-label', 'Recolher gráfico');
                    const icon = trigger.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-expand');
                        icon.classList.add('fa-compress');
                    }
                }

                const canvas = container.querySelector('canvas');
                if (canvas) {
                    refreshChartForCanvas(canvas);
                }

                adjustExpandedContainer(container);

                const chart = getChartInstanceFromContainer(container);
                if (chart) {
                    queueMicrotask(() => chart.resize());
                }
            };

            overlay.addEventListener('click', () => closeExpanded());
            window.addEventListener('keyup', event => {
                if (event.key === 'Escape') {
                    closeExpanded();
                }
            });

            document.querySelectorAll('[data-action="expand-chart"]').forEach(button => {
                if (button.dataset.expandBound === 'true') {
                    return;
                }

                button.dataset.expandBound = 'true';
                button.addEventListener('click', event => {
                    event.preventDefault();
                    const container = button.closest('.chart-container');
                    if (!container) {
                        return;
                    }

                    if (container === expandedContainer) {
                        closeExpanded();
                    } else {
                        openExpanded(container, button);
                    }
                });
            });

            window.addEventListener('resize', () => {
                if (expandedContainer) {
                    adjustExpandedContainer(expandedContainer);
                    const chart = getChartInstanceFromContainer(expandedContainer);
                    if (chart) {
                        queueMicrotask(() => chart.resize());
                    }
                } else {
                    enforceEspecialidadeChartHeight();
                }
            });

            overlay.dataset.bound = 'true';
        }

        function adjustExpandedContainer(container) {
            if (!container) {
                return;
            }

            const wrapper = container.querySelector('.chart-wrapper');
            if (!wrapper) {
                return;
            }

            const targetHeight = Math.max(window.innerHeight * 0.65, 420);
            wrapper.style.height = `${Math.round(targetHeight)}px`;
            wrapper.style.maxHeight = 'none';
        }

        function refreshChartDimensions(container) {
            if (!container) {
                enforceEspecialidadeChartHeight();
                return;
            }

            const canvas = container.querySelector('canvas');
            if (!canvas) {
                return;
            }

            if (canvas.id === 'especialidadeChart') {
                enforceEspecialidadeChartHeight();
            } else if (!container.classList.contains('is-expanded')) {
                const wrapper = container.querySelector('.chart-wrapper');
                if (wrapper) {
                    wrapper.style.removeProperty('height');
                    wrapper.style.removeProperty('max-height');
                }
            }

            const chart = getChartInstanceFromContainer(container);
            if (chart) {
                queueMicrotask(() => chart.resize());
            }
        }

        function getChartInstanceFromContainer(container) {
            if (!container) {
                return null;
            }

            const canvas = container.querySelector('canvas');
            if (!canvas) {
                return null;
            }

            const chartKey = chartCanvasMap[canvas.id];
            return chartKey ? charts[chartKey] : null;
        }

        function enforceEspecialidadeChartHeight(labelCount) {
            const canvas = document.getElementById('especialidadeChart');
            if (!canvas) {
                return;
            }

            const wrapper = canvas.parentElement;
            if (!wrapper) {
                return;
            }

            const container = wrapper.closest('.chart-container');
            if (container && container.classList.contains('is-expanded')) {
                return;
            }

            const count = Number.isFinite(labelCount)
                ? labelCount
                : (charts.especialidade?.data?.labels?.length || 0);

            if (!count) {
                wrapper.style.height = '';
                return;
            }

            const dynamicHeight = Math.max(count * 44, 320);
            const cappedHeight = Math.min(dynamicHeight, 900);
            wrapper.style.height = `${cappedHeight}px`;
            wrapper.style.maxHeight = '';
        }

        function getLimitedEspecialidadeChartSeries(limit, baseSeries = null) {
            const series = baseSeries || getChartSeries('especialidadesValidas');
            const allLabels = Array.isArray(series?.labels) ? series.labels.slice() : [];
            const allData = Array.isArray(series?.data) ? series.data.slice() : [];
            const maxLength = Math.min(allLabels.length, allData.length);
            const labels = [];
            const data = [];

            for (let index = 0; index < maxLength; index++) {
                labels.push(allLabels[index]);
                data.push(toNumber(allData[index]));
            }

            if (!Number.isFinite(limit) || limit <= 0) {
                return { labels, data };
            }

            return {
                labels: labels.slice(0, limit),
                data: data.slice(0, limit)
            };
        }

        // ===== GRÁFICOS =====
        function updateCharts() {
            if (!hasValidChartDataset(chartData)) {
                const fallbackSnapshot = getFallbackDataset(activeDataset);
                if (hasValidChartDataset(fallbackSnapshot?.charts)) {
                    chartData = cloneData(fallbackSnapshot.charts);
                    if (!Array.isArray(consultasEspecialidade) || consultasEspecialidade.length === 0) {
                        updateConsultasEspecialidade();
                    }
                } else {
                    return;
                }
            }

            createEspecialidadeChart();
            createEvolucaoChart();
            createTipoConsultaChart();
            createFaixaEtariaChart();
            createGeneroChart();
            createDesfechoChart();
        }

        function measureTextWithLetterSpacing(ctx, text, letterSpacing = 0) {
            if (!ctx || !text) {
                return 0;
            }

            const value = String(text);
            if (!letterSpacing) {
                return ctx.measureText(value).width;
            }

            const characters = Array.from(value);
            if (!characters.length) {
                return 0;
            }

            return characters.reduce((total, character, index) => {
                total += ctx.measureText(character).width;
                if (index < characters.length - 1) {
                    total += letterSpacing;
                }
                return total;
            }, 0);
        }

        function drawTextWithLetterSpacing(ctx, text, x, y, options = {}) {
            if (!ctx || !text) {
                return;
            }

            const {
                letterSpacing = 0,
                textAlign = 'center',
                textBaseline = 'middle'
            } = options;

            const value = String(text);

            if (!letterSpacing) {
                ctx.textAlign = textAlign;
                ctx.textBaseline = textBaseline;
                ctx.fillText(value, x, y);
                return;
            }

            const characters = Array.from(value);
            if (!characters.length) {
                return;
            }

            const totalWidth = measureTextWithLetterSpacing(ctx, value, letterSpacing);
            let startX = x;

            if (textAlign === 'center') {
                startX = x - totalWidth / 2;
            } else if (textAlign === 'right') {
                startX = x - totalWidth;
            }

            ctx.textAlign = 'left';
            ctx.textBaseline = textBaseline;

            let currentX = startX;
            characters.forEach((character, index) => {
                ctx.fillText(character, currentX, y);
                currentX += ctx.measureText(character).width;
                if (index < characters.length - 1) {
                    currentX += letterSpacing;
                }
            });
        }

        function getPercentageLabelOptions(overrides = {}) {
            const theme = getChartThemeColors();
            const base = {
                enabled: true,
                color: theme.label,
                shadowColor: theme.tooltipBorder,
                shadowBlur: 10,
                letterSpacing: 1.2,
                font: {
                    family: '"Inter", sans-serif',
                    weight: '700',
                    size: 13
                },
                horizontalPadding: 16,
                outsideOffset: 12,
                verticalOffset: 18,
                renderForArc: false,
                arcOffset: 0
            };

            const fontOverride = overrides.font
                ? { ...base.font, ...overrides.font }
                : base.font;

            return {
                ...base,
                ...overrides,
                font: fontOverride
            };
        }

        const percentageLabelPlugin = {
            id: 'percentageLabelPlugin',
            afterDatasetsDraw(chart, args, pluginOptions) {
                const optionsFromConfig = chart?.options?.plugins?.percentageLabel;
                const options = pluginOptions ?? optionsFromConfig;

                if (!options || options.enabled === false) {
                    return;
                }

                const datasetIndexFromArgs = args?.meta?.index ?? args?.index;
                if (typeof datasetIndexFromArgs === 'number' && datasetIndexFromArgs > 0) {
                    return;
                }

                const datasets = chart.data?.datasets;
                if (!Array.isArray(datasets) || datasets.length === 0) {
                    return;
                }

                const ctx = chart.ctx;
                const letterSpacing = options.letterSpacing ?? 0;
                const verticalOffset = options.verticalOffset ?? 18;
                const horizontalPadding = options.horizontalPadding ?? 12;
                const outsideOffset = options.outsideOffset ?? 10;
                const arcOffset = options.arcOffset ?? 0;
                const renderForArc = options.renderForArc ?? false;
                const font = options.font || {};
                const chartType = chart.config?.type;
                const isArcChart = ['pie', 'doughnut', 'polarArea'].includes(chartType);

                ctx.save();
                ctx.fillStyle = options.color || '#1E3A8A';
                ctx.shadowColor = options.shadowColor ?? 'rgba(15, 23, 42, 0.25)';
                ctx.shadowBlur = options.shadowBlur ?? 8;
                ctx.font = `${font.weight || '600'} ${font.size || 13}px ${font.family || '"Inter", sans-serif'}`;

                datasets.forEach((dataset, datasetIndex) => {
                    const meta = chart.getDatasetMeta(datasetIndex);
                    if (!meta || (typeof chart.isDatasetVisible === 'function' && !chart.isDatasetVisible(datasetIndex))) {
                        return;
                    }

                    const values = Array.isArray(dataset.data) ? dataset.data : [];
                    const total = values.reduce((sum, value) => sum + toNumber(value), 0);

                    if (!total) {
                        return;
                    }

                    if (isArcChart && !renderForArc) {
                        return;
                    }

                    meta.data.forEach((element, index) => {
                        const rawValue = toNumber(values[index]);
                        if (!rawValue || !element) {
                            return;
                        }

                        const percent = (rawValue / total) * 100;
                        const formatter = typeof options.formatter === 'function'
                            ? options.formatter
                            : null;

                        const text = formatter
                            ? formatter({ chart, dataset, datasetIndex, index, value: rawValue, percent })
                            : `${percent.toFixed(1)}%`;

                        if (!text) {
                            return;
                        }

                        if (isArcChart) {
                            const position = typeof element.tooltipPosition === 'function'
                                ? element.tooltipPosition()
                                : { x: element.x, y: element.y };

                            if (!position || !Number.isFinite(position.x) || !Number.isFinite(position.y)) {
                                return;
                            }

                            let targetX = position.x;
                            let targetY = position.y;
                            const elementProps = typeof element.getProps === 'function'
                                ? element.getProps(['startAngle', 'endAngle', 'innerRadius', 'outerRadius', 'x', 'y'], true)
                                : null;

                            const centerX = elementProps?.x ?? element.x ?? targetX;
                            const centerY = elementProps?.y ?? element.y ?? targetY;
                            const innerRadius = elementProps?.innerRadius ?? element.innerRadius;
                            const outerRadius = elementProps?.outerRadius ?? element.outerRadius;
                            const startAngle = elementProps?.startAngle ?? element.startAngle;
                            const endAngle = elementProps?.endAngle ?? element.endAngle;

                            if (Number.isFinite(startAngle) && Number.isFinite(endAngle) && Number.isFinite(innerRadius) && Number.isFinite(outerRadius)) {
                                const angle = (startAngle + endAngle) / 2;
                                const radius = innerRadius + (outerRadius - innerRadius) / 2 + arcOffset;
                                if (Number.isFinite(centerX) && Number.isFinite(centerY) && Number.isFinite(radius)) {
                                    targetX = centerX + Math.cos(angle) * radius;
                                    targetY = centerY + Math.sin(angle) * radius;
                                }
                            } else if (arcOffset && Number.isFinite(centerX) && Number.isFinite(centerY)) {
                                const dx = targetX - centerX;
                                const dy = targetY - centerY;
                                const length = Math.hypot(dx, dy) || 1;
                                targetX += (dx / length) * arcOffset;
                                targetY += (dy / length) * arcOffset;
                            }

                            drawTextWithLetterSpacing(ctx, text, targetX, targetY, {
                                letterSpacing,
                                textAlign: 'center',
                                textBaseline: 'middle'
                            });
                            return;
                        }

                        if (chartType === 'line') {
                            const position = typeof element.tooltipPosition === 'function'
                                ? element.tooltipPosition()
                                : { x: element.x, y: element.y };

                            if (!position) {
                                return;
                            }

                            const targetY = (position.y ?? element.y) - verticalOffset;
                            drawTextWithLetterSpacing(ctx, text, position.x, targetY, {
                                letterSpacing,
                                textAlign: 'center',
                                textBaseline: 'bottom'
                            });
                            return;
                        }

                        const isHorizontal = chart.options?.indexAxis === 'y';

                        if (isHorizontal) {
                            const base = element.base ?? 0;
                            const xPosition = element.x ?? 0;
                            const yPosition = element.y ?? 0;
                            const left = Math.min(base, xPosition);
                            const right = Math.max(base, xPosition);
                            const barWidth = Math.abs(right - left);
                            const textWidth = measureTextWithLetterSpacing(ctx, text, letterSpacing);

                            let textAlign = 'right';
                            let textX = right - horizontalPadding;

                            if (barWidth <= textWidth + horizontalPadding * 1.5) {
                                textAlign = 'left';
                                textX = right + outsideOffset;
                            }

                            drawTextWithLetterSpacing(ctx, text, textX, yPosition, {
                                letterSpacing,
                                textAlign,
                                textBaseline: 'middle'
                            });
                            return;
                        }

                        const position = typeof element.tooltipPosition === 'function'
                            ? element.tooltipPosition()
                            : { x: element.x, y: element.y };

                        if (!position) {
                            return;
                        }

                        const y = (position.y ?? element.y) - verticalOffset;
                        drawTextWithLetterSpacing(ctx, text, position.x, y, {
                            letterSpacing,
                            textAlign: 'center',
                            textBaseline: 'bottom'
                        });
                    });
                });

                ctx.restore();
            }
        };

        function safelyRegisterChartPlugin(plugin) {
            if (!plugin || typeof plugin.id !== 'string') {
                return;
            }

            if (typeof Chart === 'undefined' || typeof Chart.register !== 'function') {
                return;
            }

            const globalScope = typeof window !== 'undefined' ? window : globalThis;
            const registryKey = '__nacRegisteredChartPlugins';
            const registeredPlugins = globalScope[registryKey] ?? (globalScope[registryKey] = {});

            if (registeredPlugins[plugin.id]) {
                return;
            }

            Chart.register(plugin);
            registeredPlugins[plugin.id] = true;
        }

        safelyRegisterChartPlugin(percentageLabelPlugin);

        function createEspecialidadeChart() {
            const canvas = document.getElementById('especialidadeChart');
            if (!canvas) {
                return;
            }

            const ctx = canvas.getContext('2d');
            const container = canvas.closest('.chart-container');
            const isExpanded = container?.classList.contains('is-expanded');
            const limit = isExpanded ? null : ESPECIALIDADE_DEFAULT_LIMIT;
            const { labels, data } = getLimitedEspecialidadeChartSeries(limit);
            const safeLabels = Array.isArray(labels) ? labels : [];
            const safeData = Array.isArray(data) ? data : [];
            const theme = getChartThemeColors();

            enforceEspecialidadeChartHeight(safeLabels.length);

            if (!safeLabels.length) {
                if (charts.especialidade) {
                    charts.especialidade.data.labels = [];
                    charts.especialidade.data.datasets[0].data = [];
                    charts.especialidade.update('none');
                }
                refreshCustomLegend('especialidade');
                return;
            }

            const backgroundColor = safeLabels.map((_, index) => CHART_COLOR_PALETTE[index % CHART_COLOR_PALETTE.length]);

            if (!charts.especialidade) {
                charts.especialidade = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [...safeLabels],
                        datasets: [{
                            data: [...safeData],
                            label: 'Atendimentos válidos',
                            backgroundColor,
                            categoryPercentage: 0.6,
                            barPercentage: 0.55,
                            borderRadius: 12,
                            maxBarThickness: 36,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                ...getTooltipThemeOptions(),
                                callbacks: {
                                    label: context => {
                                        const total = context.dataset.data.reduce((sum, value) => sum + toNumber(value), 0);
                                        const value = Number(context.parsed.x || 0);
                                        const percent = total > 0 ? ((value / total) * 100) : 0;
                                        return `${context.label}: ${value.toLocaleString('pt-BR')} (${percent.toFixed(1)}%)`;
                                    }
                                }
                            },
                            percentageLabel: getPercentageLabelOptions({
                                letterSpacing: 1.4,
                                horizontalPadding: 18,
                                outsideOffset: 16,
                                shadowBlur: 12
                            })
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: theme.axis,
                                    callback: value => Number(value).toLocaleString('pt-BR'),
                                    precision: 0
                                },
                                beginAtZero: true,
                                grid: {
                                    color: theme.grid,
                                    borderColor: theme.grid
                                }
                            },
                            y: {
                                ticks: {
                                    color: theme.legend,
                                    autoSkip: false,
                                    padding: 6,
                                    callback: function(value) {
                                        const label = this.getLabelForValue(value);
                                        const wrapped = wrapLabel(label, 20);
                                        return Array.isArray(wrapped) ? wrapped : [wrapped];
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
                charts.especialidade.options.plugins.tooltip = {
                    ...getTooltipThemeOptions(),
                    callbacks: {
                        label: context => {
                            const total = context.dataset.data.reduce((sum, value) => sum + toNumber(value), 0);
                            const value = Number(context.parsed.x || 0);
                            const percent = total > 0 ? ((value / total) * 100) : 0;
                            return `${context.label}: ${value.toLocaleString('pt-BR')} (${percent.toFixed(1)}%)`;
                        }
                    }
                };
                const containerElement = canvas.closest('.chart-container');
                if (containerElement && containerElement.classList.contains('is-expanded')) {
                    adjustExpandedContainer(containerElement);
                }
                refreshCustomLegend('especialidade');
                return;
            }

            const chart = charts.especialidade;
            chart.data.labels = [...safeLabels];
            const dataset = chart.data.datasets[0];
            dataset.data = [...safeData];
            dataset.backgroundColor = backgroundColor;
            chart.options.plugins = chart.options.plugins || {};
            chart.options.plugins.percentageLabel = getPercentageLabelOptions({
                letterSpacing: 1.4,
                horizontalPadding: 18,
                outsideOffset: 16,
                shadowBlur: 12
            });
            chart.options.plugins.tooltip = {
                ...getTooltipThemeOptions(chart.options.plugins.tooltip || {}),
                callbacks: {
                    label: context => {
                        const total = context.dataset.data.reduce((sum, value) => sum + toNumber(value), 0);
                        const value = Number(context.parsed.x || 0);
                        const percent = total > 0 ? ((value / total) * 100) : 0;
                        return `${context.label}: ${value.toLocaleString('pt-BR')} (${percent.toFixed(1)}%)`;
                    }
                }
            };
            if (chart.options.scales?.x?.ticks) {
                chart.options.scales.x.ticks.color = theme.axis;
            }
            if (chart.options.scales?.x?.grid) {
                chart.options.scales.x.grid.color = theme.grid;
                chart.options.scales.x.grid.borderColor = theme.grid;
            }
            if (chart.options.scales?.y?.ticks) {
                chart.options.scales.y.ticks.color = theme.legend;
            }
            chart.update('none');
            refreshCustomLegend('especialidade');
            queueMicrotask(() => chart.resize());

            const containerElement = canvas.closest('.chart-container');
            if (containerElement && containerElement.classList.contains('is-expanded')) {
                adjustExpandedContainer(containerElement);
            }
        }

        function createEvolucaoChart() {
            const canvas = document.getElementById('evolucaoChart');
            if (!canvas) {
                return;
            }

            const ctx = canvas.getContext('2d');
            const { labels = [], data = [] } = getChartSeries('evolucao');
            const theme = getChartThemeColors();

            if (!charts.evolucao) {
                charts.evolucao = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [...labels],
                        datasets: [{
                            label: 'Atendimentos',
                            data: [...data],
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.18)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: '#F97316',
                            pointBorderColor: '#FFFFFF',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: getTooltipThemeOptions(),
                            percentageLabel: getPercentageLabelOptions({
                                verticalOffset: 22,
                                letterSpacing: 1.1,
                                shadowBlur: 10,
                                horizontalPadding: 14
                            })
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: theme.grid,
                                    borderColor: theme.grid
                                },
                                ticks: {
                                    color: theme.axis
                                }
                            },
                            y: {
                                grid: {
                                    color: theme.grid,
                                    borderColor: theme.grid
                                },
                                ticks: {
                                    color: theme.axis,
                                    precision: 0
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });
                const containerElement = canvas.closest('.chart-container');
                if (containerElement && containerElement.classList.contains('is-expanded')) {
                    adjustExpandedContainer(containerElement);
                }
                refreshCustomLegend('evolucao');
                return;
            }

            const chart = charts.evolucao;
            chart.data.labels = [...labels];
            chart.data.datasets[0].data = [...data];
            chart.options.plugins = chart.options.plugins || {};
            chart.options.plugins.percentageLabel = getPercentageLabelOptions({
                verticalOffset: 22,
                letterSpacing: 1.1,
                shadowBlur: 10,
                horizontalPadding: 14
            });
            chart.options.plugins.tooltip = {
                ...getTooltipThemeOptions(chart.options.plugins.tooltip || {})
            };
            if (chart.options.scales?.x?.ticks) {
                chart.options.scales.x.ticks.color = theme.axis;
            }
            if (chart.options.scales?.x?.grid) {
                chart.options.scales.x.grid.color = theme.grid;
                chart.options.scales.x.grid.borderColor = theme.grid;
            }
            if (chart.options.scales?.y?.ticks) {
                chart.options.scales.y.ticks.color = theme.axis;
            }
            if (chart.options.scales?.y?.grid) {
                chart.options.scales.y.grid.color = theme.grid;
                chart.options.scales.y.grid.borderColor = theme.grid;
            }
            chart.update('none');
            refreshCustomLegend('evolucao');
            queueMicrotask(() => chart.resize());

            const containerElement = canvas.closest('.chart-container');
            if (containerElement && containerElement.classList.contains('is-expanded')) {
                adjustExpandedContainer(containerElement);
            }
        }

        function createTipoConsultaChart() {
            const canvas = document.getElementById('tipoConsultaChart');
            if (!canvas) {
                return;
            }

            const ctx = canvas.getContext('2d');
            const container = canvas.closest('.chart-container');
            const isExpanded = container?.classList.contains('is-expanded');
            const { labels, data } = getChartSeries('tipoConsulta');
            const theme = getChartThemeColors();
            let safeLabels = Array.isArray(labels) ? labels.slice() : [];
            let safeData = Array.isArray(data) ? data.map(value => toNumber(value)) : [];

            if (!safeLabels.length) {
                if (charts.tipoConsulta) {
                    charts.tipoConsulta.data.labels = [];
                    charts.tipoConsulta.data.datasets[0].data = [];
                    charts.tipoConsulta.update('none');
                }
                const parentWrapper = canvas.parentNode;
                if (parentWrapper && !parentWrapper.closest('.chart-container')?.classList.contains('is-expanded')) {
                    parentWrapper.style.removeProperty('height');
                    parentWrapper.style.removeProperty('max-height');
                }
                return;
            }

            if (!isExpanded && safeLabels.length > TIPO_CONSULTA_LIMIT) {
                const combined = safeLabels.map((label, index) => ({
                    label,
                    value: toNumber(safeData[index] ?? 0)
                }));

                combined.sort((a, b) => b.value - a.value);
                const topEntries = combined.slice(0, TIPO_CONSULTA_LIMIT);
                const remainingEntries = combined.slice(TIPO_CONSULTA_LIMIT);
                safeLabels = topEntries.map(entry => entry.label);
                safeData = topEntries.map(entry => entry.value);

                const othersTotal = remainingEntries.reduce((sum, entry) => sum + entry.value, 0);
                if (othersTotal > 0) {
                    safeLabels.push('Outros');
                    safeData.push(othersTotal);
                }
            }

            const palette = CHART_COLOR_PALETTE;
            const wrapper = ctx.canvas.parentNode;
            if (wrapper) {
                if (!isExpanded) {
                    wrapper.style.height = '280px';
                } else {
                    wrapper.style.removeProperty('height');
                    wrapper.style.removeProperty('max-height');
                }
            }

            if (!charts.tipoConsulta) {
                charts.tipoConsulta = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: [...safeLabels],
                        datasets: [{
                            data: [...safeData],
                            backgroundColor: safeLabels.map((_, index) => palette[index % palette.length]),
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '55%',
                        plugins: {
                            legend: {
                                display: isExpanded,
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    padding: 18,
                                    color: theme.legend,
                                    font: {
                                        family: 'Inter',
                                        size: 12,
                                        weight: '600'
                                    }
                                }
                            },
                            tooltip: {
                                ...getTooltipThemeOptions(),
                                callbacks: {
                                    label: context => {
                                        const total = context.dataset.data.reduce((sum, value) => sum + toNumber(value), 0);
                                        const value = Number(context.parsed || 0);
                                        const percent = total > 0 ? ((value / total) * 100) : 0;
                                        return `${context.label}: ${value.toLocaleString('pt-BR')} (${percent.toFixed(1)}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                const containerElement = canvas.closest('.chart-container');
                if (containerElement && containerElement.classList.contains('is-expanded')) {
                    adjustExpandedContainer(containerElement);
                }
                return;
            }

            const chart = charts.tipoConsulta;
            chart.data.labels = [...safeLabels];
            const dataset = chart.data.datasets[0];
            dataset.data = [...safeData];
            dataset.backgroundColor = safeLabels.map((_, index) => palette[index % palette.length]);
            chart.options.plugins = chart.options.plugins || {};
            chart.options.plugins.legend = chart.options.plugins.legend || {};
            chart.options.plugins.legend.display = isExpanded;
            chart.options.plugins.legend.labels = {
                ...(chart.options.plugins.legend.labels || {}),
                color: theme.legend,
                usePointStyle: true,
                padding: 18,
                font: {
                    family: 'Inter',
                    size: 12,
                    weight: '600'
                }
            };
            chart.options.plugins.tooltip = {
                ...getTooltipThemeOptions(chart.options.plugins.tooltip || {}),
                callbacks: {
                    label: context => {
                        const total = context.dataset.data.reduce((sum, value) => sum + toNumber(value), 0);
                        const value = Number(context.parsed || 0);
                        const percent = total > 0 ? ((value / total) * 100) : 0;
                        return `${context.label}: ${value.toLocaleString('pt-BR')} (${percent.toFixed(1)}%)`;
                    }
                }
            };
            chart.update('none');
            queueMicrotask(() => chart.resize());

            const containerElement = canvas.closest('.chart-container');
            if (containerElement && containerElement.classList.contains('is-expanded')) {
                adjustExpandedContainer(containerElement);
            }
        }

        function createFaixaEtariaChart() {
            const canvas = document.getElementById('faixaEtariaChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const { labels, data } = getChartSeries('faixaEtaria');
            const theme = getChartThemeColors();

            if (!labels.length) {
                if (charts.faixaEtaria) {
                    charts.faixaEtaria.data.labels = [];
                    charts.faixaEtaria.data.datasets[0].data = [];
                    charts.faixaEtaria.update('none');
                }
                const parentWrapper = canvas.parentNode;
                if (parentWrapper && !parentWrapper.closest('.chart-container')?.classList.contains('is-expanded')) {
                    parentWrapper.style.removeProperty('height');
                    parentWrapper.style.removeProperty('max-height');
                }
                return;
            }

            const palette = CHART_COLOR_PALETTE;
            const wrapper = ctx.canvas.parentNode;
            const targetHeight = Math.max(320, Math.min(420, labels.length * 68));
            if (wrapper) {
                const isExpanded = wrapper.closest('.chart-container')?.classList.contains('is-expanded');
                if (isExpanded) {
                    wrapper.style.removeProperty('height');
                    wrapper.style.removeProperty('max-height');
                } else {
                    wrapper.style.height = `${Math.max(280, targetHeight - 40)}px`;
                }
            }

            if (!charts.faixaEtaria) {
                charts.faixaEtaria = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: [...labels],
                        datasets: [{
                            data: [...data],
                            backgroundColor: labels.map((_, index) => palette[index % palette.length]),
                            borderColor: '#FFFFFF',
                            borderWidth: 2,
                            hoverOffset: 10,
                            radius: '90%'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '55%',
                        layout: {
                            padding: 8
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: theme.legend,
                                    boxWidth: 12,
                                    padding: 16,
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                ...getTooltipThemeOptions(),
                                callbacks: {
                                    label: context => {
                                        const total = context.dataset.data.reduce((sum, value) => sum + toNumber(value), 0);
                                        const value = Number(context.parsed || 0);
                                        const percent = total > 0 ? ((value / total) * 100) : 0;
                                        return `${context.label}: ${value.toLocaleString('pt-BR')} (${percent.toFixed(1)}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                const containerElement = canvas.closest('.chart-container');
                if (containerElement && containerElement.classList.contains('is-expanded')) {
                    adjustExpandedContainer(containerElement);
                }
                return;
            }

            const chart = charts.faixaEtaria;
            chart.data.labels = [...labels];
            const dataset = chart.data.datasets[0];
            dataset.data = [...data];
            dataset.backgroundColor = labels.map((_, index) => palette[index % palette.length]);
            chart.options.plugins = chart.options.plugins || {};
            chart.options.plugins.legend = chart.options.plugins.legend || {};
            chart.options.plugins.legend.labels = {
                ...(chart.options.plugins.legend.labels || {}),
                color: theme.legend,
                boxWidth: 12,
                padding: 16,
                usePointStyle: true
            };
            chart.options.plugins.tooltip = {
                ...getTooltipThemeOptions(chart.options.plugins.tooltip || {}),
                callbacks: {
                    label: context => {
                        const total = context.dataset.data.reduce((sum, value) => sum + toNumber(value), 0);
                        const value = Number(context.parsed || 0);
                        const percent = total > 0 ? ((value / total) * 100) : 0;
                        return `${context.label}: ${value.toLocaleString('pt-BR')} (${percent.toFixed(1)}%)`;
                    }
                }
            };
            chart.update('none');
            queueMicrotask(() => chart.resize());

            const containerElement = canvas.closest('.chart-container');
            if (containerElement && containerElement.classList.contains('is-expanded')) {
                adjustExpandedContainer(containerElement);
            }
        }

        function createGeneroChart() {
            const canvas = document.getElementById('generoChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const { labels, data } = getChartSeries('genero');
            const theme = getChartThemeColors();

            if (!labels.length) {
                if (charts.genero) {
                    charts.genero.data.labels = [];
                    charts.genero.data.datasets[0].data = [];
                    charts.genero.update('none');
                }
                const parentWrapper = canvas.parentNode;
                if (parentWrapper && !parentWrapper.closest('.chart-container')?.classList.contains('is-expanded')) {
                    parentWrapper.style.removeProperty('height');
                    parentWrapper.style.removeProperty('max-height');
                }
                return;
            }

            const palette = CHART_COLOR_PALETTE;
            const wrapper = ctx.canvas.parentNode;
            if (wrapper) {
                const isExpanded = wrapper.closest('.chart-container')?.classList.contains('is-expanded');
                if (isExpanded) {
                    wrapper.style.removeProperty('height');
                    wrapper.style.removeProperty('max-height');
                } else {
                    wrapper.style.height = '260px';
                }
            }

            if (!charts.genero) {
                charts.genero = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: [...labels],
                        datasets: [{
                            data: [...data],
                            backgroundColor: labels.map((_, index) => palette[index % palette.length]),
                            borderColor: '#FFFFFF',
                            borderWidth: 2,
                            hoverOffset: 12,
                            radius: '90%'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '55%',
                        layout: {
                            padding: 6
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: theme.legend,
                                    boxWidth: 12,
                                    padding: 16,
                                    usePointStyle: true
                                }
                            },
                            percentageLabel: getPercentageLabelOptions({
                                renderForArc: true,
                                color: theme.label,
                                shadowColor: theme.tooltipBorder,
                                shadowBlur: 6,
                                letterSpacing: 1,
                                font: {
                                    weight: '600',
                                    size: 14
                                }
                            }),
                            tooltip: {
                                ...getTooltipThemeOptions(),
                                callbacks: {
                                    label: context => {
                                        const total = context.dataset.data.reduce((sum, value) => sum + toNumber(value), 0);
                                        const value = Number(context.parsed || 0);
                                        const percent = total > 0 ? ((value / total) * 100) : 0;
                                        return `${context.label}: ${value.toLocaleString('pt-BR')} (${percent.toFixed(1)}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                const containerElement = canvas.closest('.chart-container');
                if (containerElement && containerElement.classList.contains('is-expanded')) {
                    adjustExpandedContainer(containerElement);
                }
                return;
            }

            const chart = charts.genero;
            chart.data.labels = [...labels];
            const dataset = chart.data.datasets[0];
            dataset.data = [...data];
            dataset.backgroundColor = labels.map((_, index) => palette[index % palette.length]);
            chart.options.plugins = chart.options.plugins || {};
            chart.options.plugins.legend = chart.options.plugins.legend || {};
            chart.options.plugins.legend.labels = {
                ...(chart.options.plugins.legend.labels || {}),
                color: theme.legend,
                boxWidth: 12,
                padding: 16,
                usePointStyle: true
            };
            chart.options.plugins.percentageLabel = getPercentageLabelOptions({
                renderForArc: true,
                color: theme.label,
                shadowColor: theme.tooltipBorder,
                shadowBlur: 6,
                letterSpacing: 1,
                font: {
                    weight: '600',
                    size: 14
                }
            });
            chart.options.plugins.tooltip = {
                ...getTooltipThemeOptions(chart.options.plugins.tooltip || {}),
                callbacks: {
                    label: context => {
                        const total = context.dataset.data.reduce((sum, value) => sum + toNumber(value), 0);
                        const value = Number(context.parsed || 0);
                        const percent = total > 0 ? ((value / total) * 100) : 0;
                        return `${context.label}: ${value.toLocaleString('pt-BR')} (${percent.toFixed(1)}%)`;
                    }
                }
            };
            chart.update('none');
            queueMicrotask(() => chart.resize());

            const containerElement = canvas.closest('.chart-container');
            if (containerElement && containerElement.classList.contains('is-expanded')) {
                adjustExpandedContainer(containerElement);
            }
        }

        function createDesfechoChart() {
            const canvas = document.getElementById('desfechoChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            let { labels, data } = getChartSeries('desfechos');
            const theme = getChartThemeColors();

            if (!labels.length) {
                const fallbackSeries = getChartSeries('situacoes');
                labels = fallbackSeries.labels;
                data = fallbackSeries.data;
            }

            if (labels.length) {
                const filteredEntries = labels.reduce((acc, label, index) => {
                    if (shouldHideSituacaoLabel(label)) {
                        return acc;
                    }

                    acc.push({
                        label,
                        value: Array.isArray(data) ? data[index] : undefined
                    });
                    return acc;
                }, []);

                if (filteredEntries.length && filteredEntries.length !== labels.length) {
                    labels = filteredEntries.map(entry => entry.label);
                    data = filteredEntries.map(entry => toNumber(entry.value));
                }
            }

            if (!labels.length) {
                if (charts.desfecho) {
                    charts.desfecho.data.labels = [];
                    charts.desfecho.data.datasets[0].data = [];
                    charts.desfecho.update('none');
                }
                const parentWrapper = canvas.parentNode;
                if (parentWrapper && !parentWrapper.closest('.chart-container')?.classList.contains('is-expanded')) {
                    parentWrapper.style.removeProperty('height');
                    parentWrapper.style.removeProperty('max-height');
                }
                refreshCustomLegend('desfecho');
                return;
            }

            const palette = CHART_COLOR_PALETTE;
            const wrapper = ctx.canvas.parentNode;
            const dynamicHeight = Math.max(260, Math.min(520, labels.length * 48));
            if (wrapper) {
                const isExpanded = wrapper.closest('.chart-container')?.classList.contains('is-expanded');
                if (isExpanded) {
                    wrapper.style.removeProperty('height');
                    wrapper.style.removeProperty('max-height');
                } else {
                    wrapper.style.height = `${dynamicHeight}px`;
                }
            }

            if (!charts.desfecho) {
                charts.desfecho = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [...labels],
                        datasets: [{
                            data: [...data],
                            label: 'Atendimentos',
                            backgroundColor: labels.map((_, index) => palette[index % palette.length]),
                            borderRadius: 10,
                            maxBarThickness: 44,
                            barPercentage: 0.7,
                            categoryPercentage: 0.65,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: context => {
                                        const total = context.dataset.data.reduce((sum, value) => sum + toNumber(value), 0);
                                        const value = Number(context.parsed.x || 0);
                                        const percent = total > 0 ? ((value / total) * 100) : 0;
                                        return `${context.label}: ${value.toLocaleString('pt-BR')} (${percent.toFixed(1)}%)`;
                                    }
                                }
                            },
                            percentageLabel: getPercentageLabelOptions({
                                letterSpacing: 1.4,
                                horizontalPadding: 18,
                                outsideOffset: 16,
                                shadowBlur: 12
                            })
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    color: theme.axis,
                                    callback: value => Number(value).toLocaleString('pt-BR')
                                },
                                grid: {
                                    color: theme.grid,
                                    borderColor: theme.grid
                                }
                            },
                            y: {
                                ticks: {
                                    color: theme.legend,
                                    autoSkip: false,
                                    padding: 6,
                                    callback: function(value) {
                                        const label = this.getLabelForValue(value);
                                        const wrapped = wrapLabel(label, 22);
                                        return Array.isArray(wrapped) ? wrapped : [wrapped];
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
                const containerElement = canvas.closest('.chart-container');
                if (containerElement && containerElement.classList.contains('is-expanded')) {
                    adjustExpandedContainer(containerElement);
                }
                refreshCustomLegend('desfecho');
                return;
            }

            const chart = charts.desfecho;
            chart.data.labels = [...labels];
            const dataset = chart.data.datasets[0];
            dataset.data = [...data];
            dataset.backgroundColor = labels.map((_, index) => palette[index % palette.length]);
            chart.options.plugins = chart.options.plugins || {};
            chart.options.plugins.percentageLabel = getPercentageLabelOptions({
                letterSpacing: 1.4,
                horizontalPadding: 18,
                outsideOffset: 16,
                shadowBlur: 12
            });
            chart.options.plugins.tooltip = {
                ...getTooltipThemeOptions(chart.options.plugins.tooltip || {}),
                callbacks: {
                    label: context => {
                        const total = context.dataset.data.reduce((sum, value) => sum + toNumber(value), 0);
                        const value = Number(context.parsed.x || 0);
                        const percent = total > 0 ? ((value / total) * 100) : 0;
                        return `${context.label}: ${value.toLocaleString('pt-BR')} (${percent.toFixed(1)}%)`;
                    }
                }
            };
            if (chart.options.scales?.x?.ticks) {
                chart.options.scales.x.ticks.color = theme.axis;
            }
            if (chart.options.scales?.x?.grid) {
                chart.options.scales.x.grid.color = theme.grid;
                chart.options.scales.x.grid.borderColor = theme.grid;
            }
            if (chart.options.scales?.y?.ticks) {
                chart.options.scales.y.ticks.color = theme.legend;
            }
            chart.update('none');
            refreshCustomLegend('desfecho');
            queueMicrotask(() => chart.resize());

            const containerElement = canvas.closest('.chart-container');
            if (containerElement && containerElement.classList.contains('is-expanded')) {
                adjustExpandedContainer(containerElement);
            }
        }

        function hasValidChartDataset(dataset) {
            if (!dataset || typeof dataset !== 'object') {
                return false;
            }

            const chartKeys = ['especialidadesValidas', 'evolucao', 'faixaEtaria', 'genero', 'desfechos', 'tipoConsulta'];
            return chartKeys.some(key => hasValidSeries(dataset[key]));
        }

        function hasValidSeries(series) {
            return !!(series
                && Array.isArray(series.labels)
                && series.labels.length > 0
                && Array.isArray(series.data)
                && series.data.length > 0);
        }

        function getChartSeries(seriesKey) {
            const series = chartData?.[seriesKey];

            if (hasValidSeries(series)) {
                return {
                    labels: series.labels.slice(),
                    data: series.data.map(value => toNumber(value)),
                    usingFallback: false
                };
            }

            const fallbackSnapshot = getFallbackDataset(activeDataset);
            const fallbackSeries = fallbackSnapshot?.charts?.[seriesKey];

            if (hasValidSeries(fallbackSeries)) {
                if (!chartData) {
                    chartData = {};
                }
                chartData[seriesKey] = {
                    labels: fallbackSeries.labels.slice(),
                    data: fallbackSeries.data.map(value => toNumber(value))
                };

                return {
                    labels: fallbackSeries.labels.slice(),
                    data: fallbackSeries.data.map(value => toNumber(value)),
                    usingFallback: true
                };
            }

            return {
                labels: [],
                data: [],
                usingFallback: false
            };
        }

        function getConsultasEspecialidadeDataset() {
            const dataset = Array.isArray(consultasEspecialidade)
                ? consultasEspecialidade.filter(item => item && (item.especialidade || item.consultas))
                : [];

            if (dataset.length > 0) {
                return {
                    dataset: dataset.map(item => ({
                        especialidade: item.especialidade || 'N/D',
                        consultas: toNumber(item.consultas || 0)
                    })),
                    usingFallback: false
                };
            }

            const fallbackDatasetSnapshot = getFallbackDataset(activeDataset);
            const fallbackData = Array.isArray(fallbackDatasetSnapshot?.consultasEspecialidade)
                ? fallbackDatasetSnapshot.consultasEspecialidade.map(item => ({
                    especialidade: item.especialidade || 'N/D',
                    consultas: toNumber(item.consultas || 0)
                }))
                : [];

            return {
                dataset: fallbackData,
                usingFallback: fallbackData.length > 0
            };
        }

        function toNumber(value) {
            if (typeof value === 'string') {
                const normalized = value
                    .replace(/%/g, '')
                    .replace(/\s+/g, '')
                    .replace(/\.(?=\d{3}(\D|$))/g, '')
                    .replace(',', '.');
                const parsed = Number(normalized);
                return Number.isFinite(parsed) ? parsed : 0;
            }

            const parsed = Number(value);
            return Number.isFinite(parsed) ? parsed : 0;
        }

        function shouldHideSituacaoLabel(label) {
            if (!label || typeof label !== 'string') {
                return false;
            }

            const normalized = label
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .trim()
                .toLowerCase();

            return normalized === 'situacao';
        }

        function wrapLabel(label, maxLineLength = 18) {
            if (!label || typeof label !== 'string') {
                return '';
            }

            const sanitized = label.trim();

            if (sanitized.length <= maxLineLength) {
                return sanitized;
            }

            const words = sanitized.split(/\s+/g);
            const lines = [];
            let currentLine = '';

            words.forEach(word => {
                const candidate = currentLine ? `${currentLine} ${word}` : word;
                if (candidate.length > maxLineLength && currentLine) {
                    lines.push(currentLine);
                    currentLine = word;
                } else {
                    currentLine = candidate;
                }
            });

            if (currentLine) {
                lines.push(currentLine);
            }

            return lines;
        }

        function normalizeFilters(filters) {
            return Object.keys(filters || {}).reduce((acc, key) => {
                const value = filters[key];
                if (Array.isArray(value)) {
                    acc[key] = value
                        .map(item => typeof item === 'string' ? item.trim() : item)
                        .filter(item => item !== '' && item !== null && item !== undefined);
                    if (Array.isArray(acc[key])) {
                        acc[key].sort();
                    }
                } else {
                    acc[key] = typeof value === 'string' ? value.trim() : value;
                }
                return acc;
            }, {});
        }

        function getRequestCacheKey(filters, page = 1) {
            const normalized = normalizeFilters(filters);
            const sortedKeys = Object.keys(normalized).sort();
            const ordered = {};
            sortedKeys.forEach(key => {
                ordered[key] = normalized[key];
            });
            ordered.__page = page;
            return JSON.stringify(ordered);
        }

        function cloneResult(result) {
            try {
                return JSON.parse(JSON.stringify(result || {}));
            } catch (error) {
                return result;
            }
        }

        function pruneRequestCache(limit = 12) {
            if (requestCache.size <= limit) {
                return;
            }

            const entries = Array.from(requestCache.entries())
                .sort((a, b) => (a[1]?.timestamp || 0) - (b[1]?.timestamp || 0));

            while (entries.length > limit) {
                const entry = entries.shift();
                if (entry) {
                    requestCache.delete(entry[0]);
                }
            }
        }

        function getNow() {
            return typeof performance !== 'undefined' && performance.now
                ? performance.now()
                : Date.now();
        }

        // ===== FUNÇÕES AUXILIARES =====
        function populateSelect(selectId, options, config = {}) {
            const select = document.getElementById(selectId);
            if (!select) {
                return;
            }

            const keepPlaceholder = config.keepPlaceholder !== undefined
                ? config.keepPlaceholder
                : !select.multiple;

            if (keepPlaceholder) {
                while (select.options.length > 1) {
                    select.remove(1);
                }
            } else {
                select.innerHTML = '';
                if (config.placeholder) {
                    const placeholderOption = document.createElement('option');
                    placeholderOption.value = config.placeholder.value ?? '';
                    placeholderOption.textContent = config.placeholder.label ?? config.placeholder.text ?? 'Selecione';
                    if (config.placeholder.disabled !== false) {
                        placeholderOption.disabled = true;
                    }
                    if (config.placeholder.hidden !== false) {
                        placeholderOption.hidden = true;
                    }
                    select.appendChild(placeholderOption);
                }
            }

            options.forEach(option => {
                if (option === undefined || option === null) {
                    return;
                }

                const value = typeof option === 'object'
                    ? (option.value ?? option.label)
                    : option;
                const label = typeof option === 'object'
                    ? (option.label ?? option.value)
                    : option;

                if (value === undefined || value === null) {
                    return;
                }

                const optionElement = document.createElement('option');
                optionElement.value = value;
                optionElement.textContent = label;
                select.appendChild(optionElement);
            });
        }

        function showLoadingState() {
            const loader = document.getElementById('globalLoading');
            if (!loader) return;

            if (loadingTimer) {
                clearTimeout(loadingTimer);
            }

            if (loader.classList.contains('visible')) {
                loadingVisibleSince = getNow();
                return;
            }

            loadingTimer = setTimeout(() => {
                loader.classList.add('visible');
                loadingVisibleSince = getNow();
            }, LOADING_VISIBILITY_DELAY);
        }

        function hideLoadingState() {
            const loader = document.getElementById('globalLoading');
            if (!loader) return;

            if (loadingTimer) {
                clearTimeout(loadingTimer);
                loadingTimer = null;
            }

            if (!loader.classList.contains('visible')) {
                loadingVisibleSince = 0;
                return;
            }

            const currentNow = getNow();
            const elapsed = currentNow - (loadingVisibleSince || currentNow);
            const remaining = Math.max(0, MIN_LOADING_VISIBLE - elapsed);

            setTimeout(() => {
                loader.classList.remove('visible');
                loadingVisibleSince = 0;
            }, remaining);
        }

        function showNotification(message, type) {
            // Em produção, usar uma biblioteca de notificações
            console.log(`${type.toUpperCase()}: ${message}`);

            // Feedback visual simples
            const originalBg = document.body.style.background;
            const successBg = readThemeVariable('--primary-light', 'rgba(37, 99, 235, 0.14)');
            const errorBg = readThemeVariable('--accent-light', 'rgba(15, 118, 110, 0.18)');
            const infoBg = readThemeVariable('--surface-subtle', '#F3F6F9');
            document.body.style.background = type === 'success'
                ? successBg
                : type === 'error'
                    ? errorBg
                    : infoBg;

            setTimeout(() => {
                document.body.style.background = originalBg;
            }, 300);
        }

        function showError(message) {
            showNotification(message, 'error');
        }

        function updatePerformanceInfo(message) {
            if (DOMRefs.performanceInfo) {
                DOMRefs.performanceInfo.innerHTML = `<i class="fas fa-bolt"></i> ${message}`;
            }
        }

        function animateValueChanges() {
            KPI_VALUE_ELEMENTS.forEach(value => {
                value.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    value.style.transform = 'scale(1)';
                }, 300);
            });
        }

        function animateElements() {
            const elements = document.querySelectorAll('.animate-fade-in-up');
            elements.forEach((el, index) => {
                el.style.animationDelay = `${index * 0.1}s`;
            });
        }

        function startBackgroundAnimations() {
            if (!dashboardHeader) {
                return;
            }

            const style = getComputedStyle(document.body || document.documentElement);
            const shadow = style.getPropertyValue('--shadow-lg')?.trim() || '0 18px 34px rgba(15, 23, 42, 0.12)';
            dashboardHeader.style.boxShadow = shadow;
        }

    </script>
</body>
</html>
